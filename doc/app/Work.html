<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>Class: Work</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/models/work.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">ActiveRecord::Base
  
</nav>

    <!-- Included Modules -->
<nav id="includes-section" class="section">
  <h3 class="section-header">Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">Taggable</span>
  
  
  
    <li><span class="include">Collectible</span>
  
  
  </ul>
</nav>

    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-build_filters">::build_filters</a>
    
    <li><a href="#method-c-build_filters_from_tags">::build_filters_from_tags</a>
    
    <li><a href="#method-c-find_with_options">::find_with_options</a>
    
    <li><a href="#method-c-in_series">::in_series</a>
    
    <li><a href="#method-c-no_tags">::no_tags</a>
    
    <li><a href="#method-c-purge_old_drafts">::purge_old_drafts</a>
    
    <li><a href="#method-c-visible">::visible</a>
    
    <li><a href="#method-c-visible_to_user">::visible_to_user</a>
    
    <li><a href="#method-i-3C-3D-3E">#&lt;=&gt;</a>
    
    <li><a href="#method-i-add_filter_tagging">#add_filter_tagging</a>
    
    <li><a href="#method-i-adjust_filter_counts">#adjust_filter_counts</a>
    
    <li><a href="#method-i-adjust_series_restriction">#adjust_series_restriction</a>
    
    <li><a href="#method-i-anonymous-3F">#anonymous?</a>
    
    <li><a href="#method-i-author_attributes-3D">#author_attributes=</a>
    
    <li><a href="#method-i-challenge_assignment_ids">#challenge_assignment_ids</a>
    
    <li><a href="#method-i-challenge_assignment_ids-3D">#challenge_assignment_ids=</a>
    
    <li><a href="#method-i-challenge_claim_ids">#challenge_claim_ids</a>
    
    <li><a href="#method-i-change_ownership">#change_ownership</a>
    
    <li><a href="#method-i-chapter_attributes-3D">#chapter_attributes=</a>
    
    <li><a href="#method-i-chapter_total_display">#chapter_total_display</a>
    
    <li><a href="#method-i-chaptered-3F">#chaptered?</a>
    
    <li><a href="#method-i-chapters_in_order">#chapters_in_order</a>
    
    <li><a href="#method-i-check_filter_counts">#check_filter_counts</a>
    
    <li><a href="#method-i-check_for_invalid_chapters">#check_for_invalid_chapters</a>
    
    <li><a href="#method-i-clean_and_validate_title">#clean_and_validate_title</a>
    
    <li><a href="#method-i-comments">#comments</a>
    
    <li><a href="#method-i-count_all_comments">#count_all_comments</a>
    
    <li><a href="#method-i-create_hit_counter">#create_hit_counter</a>
    
    <li><a href="#method-i-database_hits">#database_hits</a>
    
    <li><a href="#method-i-default_date">#default_date</a>
    
    <li><a href="#method-i-destroy_chapters_in_reverse">#destroy_chapters_in_reverse</a>
    
    <li><a href="#method-i-display_authors">#display_authors</a>
    
    <li><a href="#method-i-download_authors">#download_authors</a>
    
    <li><a href="#method-i-download_basename">#download_basename</a>
    
    <li><a href="#method-i-download_dir">#download_dir</a>
    
    <li><a href="#method-i-download_fandoms">#download_fandoms</a>
    
    <li><a href="#method-i-download_title">#download_title</a>
    
    <li><a href="#method-i-ensure_revised_at">#ensure_revised_at</a>
    
    <li><a href="#method-i-find_all_comments">#find_all_comments</a>
    
    <li><a href="#method-i-first_chapter">#first_chapter</a>
    
    <li><a href="#method-i-has_required_tags-3F">#has_required_tags?</a>
    
    <li><a href="#method-i-hits">#hits</a>
    
    <li><a href="#method-i-increment_hit_count">#increment_hit_count</a>
    
    <li><a href="#method-i-is_complete">#is_complete</a>
    
    <li><a href="#method-i-is_wip">#is_wip</a>
    
    <li><a href="#method-i-last_chapter">#last_chapter</a>
    
    <li><a href="#method-i-last_visitor">#last_visitor</a>
    
    <li><a href="#method-i-multipart-3F">#multipart?</a>
    
    <li><a href="#method-i-number_of_chapters">#number_of_chapters</a>
    
    <li><a href="#method-i-number_of_posted_chapters">#number_of_posted_chapters</a>
    
    <li><a href="#method-i-parent_attributes-3D">#parent_attributes=</a>
    
    <li><a href="#method-i-parents">#parents</a>
    
    <li><a href="#method-i-post_first_chapter">#post_first_chapter</a>
    
    <li><a href="#method-i-published_at">#published_at</a>
    
    <li><a href="#method-i-recipients">#recipients</a>
    
    <li><a href="#method-i-recipients-3D">#recipients=</a>
    
    <li><a href="#method-i-redis_key">#redis_key</a>
    
    <li><a href="#method-i-remove_author">#remove_author</a>
    
    <li><a href="#method-i-remove_filter_tagging">#remove_filter_tagging</a>
    
    <li><a href="#method-i-remove_outdated_downloads">#remove_outdated_downloads</a>
    
    <li><a href="#method-i-reorder">#reorder</a>
    
    <li><a href="#method-i-save_chapters">#save_chapters</a>
    
    <li><a href="#method-i-save_parents">#save_parents</a>
    
    <li><a href="#method-i-series_attributes-3D">#series_attributes=</a>
    
    <li><a href="#method-i-set_challenge_claim_info">#set_challenge_claim_info</a>
    
    <li><a href="#method-i-set_challenge_info">#set_challenge_info</a>
    
    <li><a href="#method-i-set_revised_at">#set_revised_at</a>
    
    <li><a href="#method-i-set_word_count">#set_word_count</a>
    
    <li><a href="#method-i-sorted_authors">#sorted_authors</a>
    
    <li><a href="#method-i-sorted_pseuds">#sorted_pseuds</a>
    
    <li><a href="#method-i-sorted_title">#sorted_title</a>
    
    <li><a href="#method-i-tag_groups">#tag_groups</a>
    
    <li><a href="#method-i-unrevealed-3F">#unrevealed?</a>
    
    <li><a href="#method-i-update_complete_status">#update_complete_status</a>
    
    <li><a href="#method-i-update_major_version">#update_major_version</a>
    
    <li><a href="#method-i-update_minor_version">#update_minor_version</a>
    
    <li><a href="#method-i-validate_authors">#validate_authors</a>
    
    <li><a href="#method-i-validate_published_at">#validate_published_at</a>
    
    <li><a href="#method-i-visibility_changed-3F">#visibility_changed?</a>
    
    <li><a href="#method-i-visible">#visible</a>
    
    <li><a href="#method-i-visible-3F">#visible?</a>
    
    <li><a href="#method-i-wip_length">#wip_length</a>
    
    <li><a href="#method-i-wip_length-3D">#wip_length=</a>
    
    <li><a href="#method-i-work_skin_allowed">#work_skin_allowed</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./app/mailers/README.html">README</a>
  
    <li class="file"><a href="./app/views/epub/mimetype.html">mimetype</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./Static.html">Static</a>
  
    <li><a href="./Static/BaseController.html">Static::BaseController</a>
  
    <li><a href="./Static/CollectionsController.html">Static::CollectionsController</a>
  
    <li><a href="./Static/FandomsController.html">Static::FandomsController</a>
  
    <li><a href="./Static/MediaController.html">Static::MediaController</a>
  
    <li><a href="./Static/RestrictedWorksController.html">Static::RestrictedWorksController</a>
  
    <li><a href="./Static/WorksController.html">Static::WorksController</a>
  
    <li><a href="./Admin.html">Admin</a>
  
    <li><a href="./Admin/AdminInvitationsController.html">Admin::AdminInvitationsController</a>
  
    <li><a href="./Admin/AdminUsersController.html">Admin::AdminUsersController</a>
  
    <li><a href="./Admin/SettingsController.html">Admin::SettingsController</a>
  
    <li><a href="./Admin/SkinsController.html">Admin::SkinsController</a>
  
    <li><a href="./Admin/UserCreationsController.html">Admin::UserCreationsController</a>
  
    <li><a href="./Challenge.html">Challenge</a>
  
    <li><a href="./Challenge/GiftExchangeController.html">Challenge::GiftExchangeController</a>
  
    <li><a href="./Challenge/PromptMemeController.html">Challenge::PromptMemeController</a>
  
    <li><a href="./StoryParser.html">StoryParser</a>
  
    <li><a href="./StoryParser/Error.html">StoryParser::Error</a>
  
    <li><a href="./AbuseReport.html">AbuseReport</a>
  
    <li><a href="./AbuseReportsController.html">AbuseReportsController</a>
  
    <li><a href="./AdminMailer.html">AdminMailer</a>
  
    <li><a href="./AdminPost.html">AdminPost</a>
  
    <li><a href="./AdminPostTag.html">AdminPostTag</a>
  
    <li><a href="./AdminPostTagging.html">AdminPostTagging</a>
  
    <li><a href="./AdminPostsController.html">AdminPostsController</a>
  
    <li><a href="./AdminSession.html">AdminSession</a>
  
    <li><a href="./AdminSessionsController.html">AdminSessionsController</a>
  
    <li><a href="./AdminSetting.html">AdminSetting</a>
  
    <li><a href="./AdminsController.html">AdminsController</a>
  
    <li><a href="./AdvancedSearchHelper.html">AdvancedSearchHelper</a>
  
    <li><a href="./AlphabetHelper.html">AlphabetHelper</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./ArchiveFaq.html">ArchiveFaq</a>
  
    <li><a href="./ArchiveFaqsController.html">ArchiveFaqsController</a>
  
    <li><a href="./AutocompleteController.html">AutocompleteController</a>
  
    <li><a href="./Banned.html">Banned</a>
  
    <li><a href="./Bookmark.html">Bookmark</a>
  
    <li><a href="./BookmarksController.html">BookmarksController</a>
  
    <li><a href="./BookmarksHelper.html">BookmarksHelper</a>
  
    <li><a href="./CacheHelper.html">CacheHelper</a>
  
    <li><a href="./CastNomination.html">CastNomination</a>
  
    <li><a href="./Category.html">Category</a>
  
    <li><a href="./ChallengeAssignment.html">ChallengeAssignment</a>
  
    <li><a href="./ChallengeAssignmentsController.html">ChallengeAssignmentsController</a>
  
    <li><a href="./ChallengeClaim.html">ChallengeClaim</a>
  
    <li><a href="./ChallengeClaimsController.html">ChallengeClaimsController</a>
  
    <li><a href="./ChallengeHelper.html">ChallengeHelper</a>
  
    <li><a href="./ChallengeRequestsController.html">ChallengeRequestsController</a>
  
    <li><a href="./ChallengeSignup.html">ChallengeSignup</a>
  
    <li><a href="./ChallengeSignupObserver.html">ChallengeSignupObserver</a>
  
    <li><a href="./ChallengeSignupSweeper.html">ChallengeSignupSweeper</a>
  
    <li><a href="./ChallengeSignupsController.html">ChallengeSignupsController</a>
  
    <li><a href="./ChallengeSweeper.html">ChallengeSweeper</a>
  
    <li><a href="./ChallengesController.html">ChallengesController</a>
  
    <li><a href="./Chapter.html">Chapter</a>
  
    <li><a href="./ChapterSweeper.html">ChapterSweeper</a>
  
    <li><a href="./ChaptersController.html">ChaptersController</a>
  
    <li><a href="./ChaptersHelper.html">ChaptersHelper</a>
  
    <li><a href="./Character.html">Character</a>
  
    <li><a href="./CharacterNomination.html">CharacterNomination</a>
  
    <li><a href="./Collection.html">Collection</a>
  
    <li><a href="./CollectionItem.html">CollectionItem</a>
  
    <li><a href="./CollectionItemsController.html">CollectionItemsController</a>
  
    <li><a href="./CollectionObserver.html">CollectionObserver</a>
  
    <li><a href="./CollectionParticipant.html">CollectionParticipant</a>
  
    <li><a href="./CollectionParticipantsController.html">CollectionParticipantsController</a>
  
    <li><a href="./CollectionPreference.html">CollectionPreference</a>
  
    <li><a href="./CollectionProfile.html">CollectionProfile</a>
  
    <li><a href="./CollectionProfileController.html">CollectionProfileController</a>
  
    <li><a href="./CollectionSweeper.html">CollectionSweeper</a>
  
    <li><a href="./CollectionsController.html">CollectionsController</a>
  
    <li><a href="./CollectionsHelper.html">CollectionsHelper</a>
  
    <li><a href="./Comment.html">Comment</a>
  
    <li><a href="./CommentMailer.html">CommentMailer</a>
  
    <li><a href="./CommentObserver.html">CommentObserver</a>
  
    <li><a href="./CommentSweeper.html">CommentSweeper</a>
  
    <li><a href="./CommentsController.html">CommentsController</a>
  
    <li><a href="./CommentsHelper.html">CommentsHelper</a>
  
    <li><a href="./CommonTagging.html">CommonTagging</a>
  
    <li><a href="./CreationObserver.html">CreationObserver</a>
  
    <li><a href="./Creatorship.html">Creatorship</a>
  
    <li><a href="./DateHelper.html">DateHelper</a>
  
    <li><a href="./DevmodeController.html">DevmodeController</a>
  
    <li><a href="./DownloadsController.html">DownloadsController</a>
  
    <li><a href="./EmailVeracityValidator.html">EmailVeracityValidator</a>
  
    <li><a href="./ErrorsController.html">ErrorsController</a>
  
    <li><a href="./ExternalAuthor.html">ExternalAuthor</a>
  
    <li><a href="./ExternalAuthorName.html">ExternalAuthorName</a>
  
    <li><a href="./ExternalAuthorsController.html">ExternalAuthorsController</a>
  
    <li><a href="./ExternalAuthorsHelper.html">ExternalAuthorsHelper</a>
  
    <li><a href="./ExternalCreatorship.html">ExternalCreatorship</a>
  
    <li><a href="./ExternalWork.html">ExternalWork</a>
  
    <li><a href="./ExternalWorksController.html">ExternalWorksController</a>
  
    <li><a href="./Fandom.html">Fandom</a>
  
    <li><a href="./FandomNomination.html">FandomNomination</a>
  
    <li><a href="./FandomsController.html">FandomsController</a>
  
    <li><a href="./FeedSweeper.html">FeedSweeper</a>
  
    <li><a href="./Feedback.html">Feedback</a>
  
    <li><a href="./FeedbacksController.html">FeedbacksController</a>
  
    <li><a href="./FilterCount.html">FilterCount</a>
  
    <li><a href="./FilterTagging.html">FilterTagging</a>
  
    <li><a href="./Freeform.html">Freeform</a>
  
    <li><a href="./FreeformNomination.html">FreeformNomination</a>
  
    <li><a href="./Gift.html">Gift</a>
  
    <li><a href="./GiftExchange.html">GiftExchange</a>
  
    <li><a href="./GiftsController.html">GiftsController</a>
  
    <li><a href="./HitCounter.html">HitCounter</a>
  
    <li><a href="./HomeController.html">HomeController</a>
  
    <li><a href="./HomeHelper.html">HomeHelper</a>
  
    <li><a href="./InboxComment.html">InboxComment</a>
  
    <li><a href="./InboxController.html">InboxController</a>
  
    <li><a href="./InboxHelper.html">InboxHelper</a>
  
    <li><a href="./Invitation.html">Invitation</a>
  
    <li><a href="./InvitationsController.html">InvitationsController</a>
  
    <li><a href="./InvitationsHelper.html">InvitationsHelper</a>
  
    <li><a href="./InviteRequest.html">InviteRequest</a>
  
    <li><a href="./InviteRequestsController.html">InviteRequestsController</a>
  
    <li><a href="./KnownIssue.html">KnownIssue</a>
  
    <li><a href="./KnownIssuesController.html">KnownIssuesController</a>
  
    <li><a href="./Kudo.html">Kudo</a>
  
    <li><a href="./KudoMailer.html">KudoMailer</a>
  
    <li><a href="./KudoObserver.html">KudoObserver</a>
  
    <li><a href="./KudosController.html">KudosController</a>
  
    <li><a href="./Language.html">Language</a>
  
    <li><a href="./LanguagesController.html">LanguagesController</a>
  
    <li><a href="./Locale.html">Locale</a>
  
    <li><a href="./LocalesController.html">LocalesController</a>
  
    <li><a href="./LogItem.html">LogItem</a>
  
    <li><a href="./Media.html">Media</a>
  
    <li><a href="./MediaController.html">MediaController</a>
  
    <li><a href="./MetaTagging.html">MetaTagging</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./Offer.html">Offer</a>
  
    <li><a href="./OrphansController.html">OrphansController</a>
  
    <li><a href="./OrphansHelper.html">OrphansHelper</a>
  
    <li><a href="./OwnedSetTagging.html">OwnedSetTagging</a>
  
    <li><a href="./OwnedTagSet.html">OwnedTagSet</a>
  
    <li><a href="./OwnedTagSetsController.html">OwnedTagSetsController</a>
  
    <li><a href="./PasswordsController.html">PasswordsController</a>
  
    <li><a href="./People.html">People</a>
  
    <li><a href="./PeopleController.html">PeopleController</a>
  
    <li><a href="./PotentialMatch.html">PotentialMatch</a>
  
    <li><a href="./PotentialMatchSettings.html">PotentialMatchSettings</a>
  
    <li><a href="./PotentialMatchesController.html">PotentialMatchesController</a>
  
    <li><a href="./PotentialPromptMatch.html">PotentialPromptMatch</a>
  
    <li><a href="./Preference.html">Preference</a>
  
    <li><a href="./PreferencesController.html">PreferencesController</a>
  
    <li><a href="./Profile.html">Profile</a>
  
    <li><a href="./ProfileController.html">ProfileController</a>
  
    <li><a href="./Prompt.html">Prompt</a>
  
    <li><a href="./PromptMeme.html">PromptMeme</a>
  
    <li><a href="./PromptRestriction.html">PromptRestriction</a>
  
    <li><a href="./PromptRestrictionsHelper.html">PromptRestrictionsHelper</a>
  
    <li><a href="./PromptsController.html">PromptsController</a>
  
    <li><a href="./Pseud.html">Pseud</a>
  
    <li><a href="./PseudSweeper.html">PseudSweeper</a>
  
    <li><a href="./PseudsController.html">PseudsController</a>
  
    <li><a href="./PseudsHelper.html">PseudsHelper</a>
  
    <li><a href="./Rating.html">Rating</a>
  
    <li><a href="./Reading.html">Reading</a>
  
    <li><a href="./ReadingsController.html">ReadingsController</a>
  
    <li><a href="./RedirectController.html">RedirectController</a>
  
    <li><a href="./RelatedWork.html">RelatedWork</a>
  
    <li><a href="./RelatedWorksController.html">RelatedWorksController</a>
  
    <li><a href="./Relationship.html">Relationship</a>
  
    <li><a href="./RelationshipNomination.html">RelationshipNomination</a>
  
    <li><a href="./Request.html">Request</a>
  
    <li><a href="./Role.html">Role</a>
  
    <li><a href="./RolesUser.html">RolesUser</a>
  
    <li><a href="./SearchController.html">SearchController</a>
  
    <li><a href="./SearchHelper.html">SearchHelper</a>
  
    <li><a href="./SerialWork.html">SerialWork</a>
  
    <li><a href="./SerialWorksController.html">SerialWorksController</a>
  
    <li><a href="./Series.html">Series</a>
  
    <li><a href="./SeriesController.html">SeriesController</a>
  
    <li><a href="./SeriesHelper.html">SeriesHelper</a>
  
    <li><a href="./SetTagging.html">SetTagging</a>
  
    <li><a href="./Skin.html">Skin</a>
  
    <li><a href="./SkinParent.html">SkinParent</a>
  
    <li><a href="./SkinsController.html">SkinsController</a>
  
    <li><a href="./SkinsHelper.html">SkinsHelper</a>
  
    <li><a href="./StaticSweeper.html">StaticSweeper</a>
  
    <li><a href="./StatsController.html">StatsController</a>
  
    <li><a href="./StatsHelper.html">StatsHelper</a>
  
    <li><a href="./Subscription.html">Subscription</a>
  
    <li><a href="./SubscriptionsController.html">SubscriptionsController</a>
  
    <li><a href="./Tag.html">Tag</a>
  
    <li><a href="./TagNomination.html">TagNomination</a>
  
    <li><a href="./TagNominationsController.html">TagNominationsController</a>
  
    <li><a href="./TagSet.html">TagSet</a>
  
    <li><a href="./TagSetAssociation.html">TagSetAssociation</a>
  
    <li><a href="./TagSetAssociationsController.html">TagSetAssociationsController</a>
  
    <li><a href="./TagSetNomination.html">TagSetNomination</a>
  
    <li><a href="./TagSetNominationsController.html">TagSetNominationsController</a>
  
    <li><a href="./TagSetOwnership.html">TagSetOwnership</a>
  
    <li><a href="./TagSetSweeper.html">TagSetSweeper</a>
  
    <li><a href="./TagSetsHelper.html">TagSetsHelper</a>
  
    <li><a href="./TagSweeper.html">TagSweeper</a>
  
    <li><a href="./TagWranglersController.html">TagWranglersController</a>
  
    <li><a href="./TagWranglingsController.html">TagWranglingsController</a>
  
    <li><a href="./Tagging.html">Tagging</a>
  
    <li><a href="./TagsController.html">TagsController</a>
  
    <li><a href="./TagsHelper.html">TagsHelper</a>
  
    <li><a href="./TranslationHelper.html">TranslationHelper</a>
  
    <li><a href="./TranslationNote.html">TranslationNote</a>
  
    <li><a href="./TranslationNotesController.html">TranslationNotesController</a>
  
    <li><a href="./TranslationsController.html">TranslationsController</a>
  
    <li><a href="./TranslatorsController.html">TranslatorsController</a>
  
    <li><a href="./UrlActiveValidator.html">UrlActiveValidator</a>
  
    <li><a href="./UrlFormatValidator.html">UrlFormatValidator</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UserInviteRequest.html">UserInviteRequest</a>
  
    <li><a href="./UserInviteRequestsController.html">UserInviteRequestsController</a>
  
    <li><a href="./UserInviteRequestsHelper.html">UserInviteRequestsHelper</a>
  
    <li><a href="./UserMailer.html">UserMailer</a>
  
    <li><a href="./UserSession.html">UserSession</a>
  
    <li><a href="./UserSessionsController.html">UserSessionsController</a>
  
    <li><a href="./UsersController.html">UsersController</a>
  
    <li><a href="./UsersHelper.html">UsersHelper</a>
  
    <li><a href="./ValidationHelper.html">ValidationHelper</a>
  
    <li><a href="./Warning.html">Warning</a>
  
    <li><a href="./WeightedRandom.html">WeightedRandom</a>
  
    <li><a href="./Work.html">Work</a>
  
    <li><a href="./WorkObserver.html">WorkObserver</a>
  
    <li><a href="./WorkSkin.html">WorkSkin</a>
  
    <li><a href="./WorkSweeper.html">WorkSweeper</a>
  
    <li><a href="./WorksController.html">WorksController</a>
  
    <li><a href="./WorksHelper.html">WorksHelper</a>
  
    <li><a href="./WranglingAssignment.html">WranglingAssignment</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Work</h1>

  <div id="description" class="description">
    
  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="COMMON_TAG_JOIN">COMMON_TAG_JOIN
        
        <dd class="description">
        
      
        <dt id="OWNERSHIP_JOIN">OWNERSHIP_JOIN
        
        <dd class="description"><p>a string for use in :joins =&gt; clause to add ownership lookup</p>
        
      
        <dt id="VISIBLE_TO_ADMIN_CONDITIONS">VISIBLE_TO_ADMIN_CONDITIONS
        
        <dd class="description">
        
      
        <dt id="VISIBLE_TO_ALL_CONDITIONS">VISIBLE_TO_ALL_CONDITIONS
        
        <dd class="description">
        
      
        <dt id="VISIBLE_TO_USER_CONDITIONS">VISIBLE_TO_USER_CONDITIONS
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-ambiguous_pseuds" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">ambiguous_pseuds</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-authors" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">authors</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Virtual attribute to use as a placeholder for pseuds before the work has
been saved Can’t write to work.pseuds until the work has an id</p>
        
        </div>
      </div>
      
      <div id="attribute-i-authors_to_remove" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">authors_to_remove</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-invalid_pseuds" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">invalid_pseuds</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-new_parent" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">new_parent</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-should_reset_filters" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">should_reset_filters</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-url_for_parent" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">url_for_parent</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-build_filters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_filters</span><span
            class="method-args">(works)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Takes an array of works, returns a hash (key = tag type) of arrays of
hashes (of individual tag data) Ex. {‘Fandom’ =&gt; [{:name =&gt; ‘Star
Trek’, :id =&gt; ‘3’, :count =&gt; ‘50’}, …], ‘Character’ =&gt; …}</p>
          

          
          <div class="method-source-code" id="build_filters-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 1059</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_filters</span>(<span class="ruby-identifier">works</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_filters_from_tags</span>(<span class="ruby-constant">Tag</span>.<span class="ruby-identifier">filters_with_count</span>(<span class="ruby-identifier">works</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:id</span>)))
<span class="ruby-keyword">end</span></pre>
          </div><!-- build_filters-source -->
          
        </div>

        

        
      </div><!-- build_filters-method -->

    
      <div id="method-c-build_filters_from_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">build_filters_from_tags</span><span
            class="method-args">(tags)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="build_filters_from_tags-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 1063</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_filters_from_tags</span>(<span class="ruby-identifier">tags</span>)
  <span class="ruby-identifier">filters</span> = {}
  <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">count</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:count</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;0&quot;</span>
    (<span class="ruby-identifier">filters</span>[<span class="ruby-identifier">tag</span>.<span class="ruby-identifier">type</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span>, <span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-value">:count</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">count</span>}
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">filters</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- build_filters_from_tags-source -->
          
        </div>

        

        
      </div><!-- build_filters_from_tags-method -->

    
      <div id="method-c-find_with_options" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_with_options</span><span
            class="method-args">(options = {})</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Used for non-search work filtering</p>
          

          
          <div class="method-source-code" id="find_with_options-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 1001</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">find_with_options</span>(<span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">page_args</span> = {<span class="ruby-value">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:page</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1</span>, <span class="ruby-value">:per_page</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-identifier">options</span>[<span class="ruby-value">:per_page</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">ITEMS_PER_PAGE</span>)}
  <span class="ruby-identifier">sort_by</span> = <span class="ruby-node">&quot;#{options[:sort_column]} #{options[:sort_direction]}&quot;</span>

  <span class="ruby-ivar">@pseuds</span> = []
  <span class="ruby-ivar">@filters</span> = []
  <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:selected_pseuds</span>].<span class="ruby-identifier">empty?</span>
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">written_by_id</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:selected_pseuds</span>])
  <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">owned_by</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:selected_tags</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-identifier">options</span>[<span class="ruby-value">:tag</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:boolean_type</span>] <span class="ruby-operator">==</span> <span class="ruby-string">'or'</span>
      <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">with_any_filter_ids</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:selected_tags</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">with_all_filter_ids</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:selected_tags</span>])
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:language_id</span>]
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">by_language</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:language_id</span>])
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:complete</span>]
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:complete</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:collection</span>]
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">in_collection</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:collection</span>])
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">limit</span>(<span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">SEARCH_RESULTS_MAX</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span> <span class="ruby-operator">==</span> <span class="ruby-value">:false</span>
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">unrestricted</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:sort_column</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;hit_count&quot;</span>
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;works.*, hit_counters.hit_count AS hit_count&quot;</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:hit_counter</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">order</span>(<span class="ruby-identifier">sort_by</span>).<span class="ruby-identifier">posted</span>.<span class="ruby-identifier">unhidden</span>
  <span class="ruby-comment"># for now, trigger the lazy loading so we don't get an error on @works.size</span>
  <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">compact</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:user</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">ANONYMOUS_THRESHOLD_COUNT</span>
    <span class="ruby-comment"># strip out works hidden in challenges if on a user's specific page or if there are too few in this listing to conceal</span>
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">delete_if</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">unrevealed?</span>}
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@filters</span> = <span class="ruby-identifier">build_filters</span>(<span class="ruby-ivar">@works</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">empty?</span>

  <span class="ruby-keyword">return</span> <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">paginate</span>(<span class="ruby-identifier">page_args</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:total_entries</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">size</span>)), <span class="ruby-ivar">@filters</span>, <span class="ruby-ivar">@pseuds</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_with_options-source -->
          
        </div>

        

        
      </div><!-- find_with_options-method -->

    
      <div id="method-c-in_series" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">in_series</span><span
            class="method-args">(series)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="in_series-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 975</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_series</span>(<span class="ruby-identifier">series</span>)
  <span class="ruby-identifier">joins</span>(<span class="ruby-value">:series</span>).
  <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;series.id = ?&quot;</span>, <span class="ruby-identifier">series</span>.<span class="ruby-identifier">id</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- in_series-source -->
          
        </div>

        

        
      </div><!-- in_series-method -->

    
      <div id="method-c-no_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">no_tags</span><span
            class="method-args">(tag_category, options = {})</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>returns an array, must come last TODO: if you know how to turn this into a
scope, please do! find all the works that do not have a tag in the given
category (i.e. no fandom, no characters etc.)</p>
          

          
          <div class="method-source-code" id="no_tags-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 993</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">no_tags</span>(<span class="ruby-identifier">tag_category</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">tags</span> = <span class="ruby-identifier">tag_category</span>.<span class="ruby-identifier">tags</span>
  <span class="ruby-identifier">with_scope</span> <span class="ruby-value">:find</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">find</span>(<span class="ruby-value">:all</span>).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span> <span class="ruby-identifier">w</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">w</span>.<span class="ruby-identifier">tags</span> &amp; <span class="ruby-identifier">tags</span>).<span class="ruby-identifier">empty?</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- no_tags-source -->
          
        </div>

        

        
      </div><!-- no_tags-method -->

    
      <div id="method-c-purge_old_drafts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">purge_old_drafts</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="purge_old_drafts-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 189</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">purge_old_drafts</span>
  <span class="ruby-identifier">draft_ids</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">where</span>(<span class="ruby-string">'works.posted = ? AND works.created_at &lt; ?'</span>, <span class="ruby-keyword">false</span>, <span class="ruby-value">1</span>.<span class="ruby-identifier">week</span>.<span class="ruby-identifier">ago</span>).<span class="ruby-identifier">value_of</span>(<span class="ruby-value">:id</span>)
  <span class="ruby-constant">Chapter</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:work_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">draft_ids</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;position DESC&quot;</span>).<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:destroy</span>)
  <span class="ruby-constant">Work</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">draft_ids</span>).<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:destroy</span>)
  <span class="ruby-identifier">draft_ids</span>.<span class="ruby-identifier">size</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- purge_old_drafts-source -->
          
        </div>

        

        
      </div><!-- purge_old_drafts-method -->

    
      <div id="method-c-visible" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visible</span><span
            class="method-args">(user=User.current_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Use the current user to determine what works are visible</p>
          

          
          <div class="method-source-code" id="visible-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 906</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">visible</span>(<span class="ruby-identifier">user</span>=<span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>)
  <span class="ruby-identifier">visible_to_user</span>(<span class="ruby-identifier">user</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- visible-source -->
          
        </div>

        

        
      </div><!-- visible-method -->

    
      <div id="method-c-visible_to_user" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visible_to_user</span><span
            class="method-args">(user=User.current_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>a complicated dynamic scope here: if the user is an <a
href="Admin.html">Admin</a>, we use the “visible_to_admin” scope if the
user is not a logged-in <a href="User.html">User</a>, we use the
“visible_to_all” scope otherwise, we use a join to get userids and then get
all posted works that are either unhidden OR belong to this user. Note: in
that last case we have to use select(“DISTINCT works.”) because of cases
where the same user appears twice on a work.</p>
          

          
          <div class="method-source-code" id="visible_to_user-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 891</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">visible_to_user</span>(<span class="ruby-identifier">user</span>=<span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">user</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">'Admin'</span>
    <span class="ruby-identifier">visible_to_admin</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">'User'</span>
    <span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;DISTINCT works.*&quot;</span>).
    <span class="ruby-identifier">posted</span>.
    <span class="ruby-identifier">joins</span>({<span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span>}).
    <span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;works.hidden_by_admin = false OR users.id = ?&quot;</span>, <span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">visible_to_all</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- visible_to_user-source -->
          
        </div>

        

        
      </div><!-- visible_to_user-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-3C-3D-3E" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">&lt;=&gt;</span><span
            class="method-args">(another_work)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>sort works by title</p>
          

          
          <div class="method-source-code" id="3C-3D-3E-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 1093</span>
<span class="ruby-keyword">def</span> <span class="ruby-operator">&lt;=&gt;</span>(<span class="ruby-identifier">another_work</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title_to_sort_on</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">another_work</span>.<span class="ruby-identifier">title_to_sort_on</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- 3C-3D-3E-source -->
          
        </div>

        

        
      </div><!-- 3C-3D-3E-method -->

    
      <div id="method-i-add_filter_tagging" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_filter_tagging</span><span
            class="method-args">(tag, meta=false)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a filter_tagging relationship between the work and the tag or its
canonical synonym</p>
          

          
          <div class="method-source-code" id="add_filter_tagging-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 663</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_filter_tagging</span>(<span class="ruby-identifier">tag</span>, <span class="ruby-identifier">meta</span>=<span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">admin_settings</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">&quot;admin_settings&quot;</span>){<span class="ruby-constant">AdminSetting</span>.<span class="ruby-identifier">first</span>}
  <span class="ruby-identifier">filter</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">canonical?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">tag</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">merger</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">filter</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">filters</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">filter</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">meta</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">filter_taggings</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:filter_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:inherited</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">filters</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">filter</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">reset_filter_count</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">meta</span>
      <span class="ruby-identifier">ft</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">filter_taggings</span>.<span class="ruby-identifier">where</span>([<span class="ruby-string">&quot;filter_id = ?&quot;</span>, <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">first</span>
      <span class="ruby-identifier">ft</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:inherited</span>, <span class="ruby-keyword">false</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_filter_tagging-source -->
          
        </div>

        

        
      </div><!-- add_filter_tagging-method -->

    
      <div id="method-i-adjust_filter_counts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjust_filter_counts</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Calls reset_filter_count on all the work’s filters</p>
          

          
          <div class="method-source-code" id="adjust_filter_counts-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 723</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjust_filter_counts</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">should_reset_filters</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">filters</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span> <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">reset_filter_count</span> }
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- adjust_filter_counts-source -->
          
        </div>

        

        
      </div><!-- adjust_filter_counts-method -->

    
      <div id="method-i-adjust_series_restriction" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">adjust_series_restriction</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Make sure the series restriction level is in line with its works</p>
          

          
          <div class="method-source-code" id="adjust_series_restriction-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 426</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">adjust_series_restriction</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">adjust_restricted</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- adjust_series_restriction-source -->
          
        </div>

        

        
      </div><!-- adjust_series_restriction-method -->

    
      <div id="method-i-anonymous-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">anonymous?</span><span
            class="method-args">(user=User.current_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="anonymous-3F-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 350</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">anonymous?</span>(<span class="ruby-identifier">user</span>=<span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>)
  <span class="ruby-comment"># here we check if the story is in a currently-anonymous challenge</span>
  <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">approved_collection_items</span>.<span class="ruby-identifier">anonymous</span>.<span class="ruby-identifier">empty?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- anonymous-3F-source -->
          
        </div>

        

        
      </div><!-- anonymous-3F-method -->

    
      <div id="method-i-author_attributes-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">author_attributes=</span><span
            class="method-args">(attributes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Virtual attribute for pseuds</p>
          

          
          <div class="method-source-code" id="author_attributes-3D-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 234</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">author_attributes=</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-identifier">selected_pseuds</span> = <span class="ruby-constant">Pseud</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">attributes</span>[<span class="ruby-value">:ids</span>])
  (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span> <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">selected_pseuds</span>
  <span class="ruby-comment"># if current user has selected different pseuds</span>
  <span class="ruby-identifier">current_user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">User</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors_to_remove</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">pseuds</span> &amp; (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">selected_pseuds</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Pseud</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">attributes</span>[<span class="ruby-value">:ambiguous_pseuds</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:ambiguous_pseuds</span>]
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">attributes</span>[<span class="ruby-value">:byline</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">results</span> = <span class="ruby-constant">Pseud</span>.<span class="ruby-identifier">parse_bylines</span>(<span class="ruby-identifier">attributes</span>[<span class="ruby-value">:byline</span>], <span class="ruby-value">:keep_ambiguous</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">results</span>[<span class="ruby-value">:pseuds</span>]
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">invalid_pseuds</span> = <span class="ruby-identifier">results</span>[<span class="ruby-value">:invalid_pseuds</span>]
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">ambiguous_pseuds</span> = <span class="ruby-identifier">results</span>[<span class="ruby-value">:ambiguous_pseuds</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">flatten!</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">uniq!</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- author_attributes-3D-source -->
          
        </div>

        

        
      </div><!-- author_attributes-3D-method -->

    
      <div id="method-i-challenge_assignment_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">challenge_assignment_ids</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="challenge_assignment_ids-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 297</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">challenge_assignment_ids</span>
  <span class="ruby-identifier">challenge_assignments</span>.<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:id</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- challenge_assignment_ids-source -->
          
        </div>

        

        
      </div><!-- challenge_assignment_ids-method -->

    
      <div id="method-i-challenge_assignment_ids-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">challenge_assignment_ids=</span><span
            class="method-args">(ids)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="challenge_assignment_ids-3D-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 305</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">challenge_assignment_ids=</span>(<span class="ruby-identifier">ids</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">challenge_assignments</span> = <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-constant">ChallengeAssignment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)}.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">assignment</span><span class="ruby-operator">|</span> <span class="ruby-identifier">assignment</span>.<span class="ruby-identifier">offering_user</span> <span class="ruby-operator">==</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>}
<span class="ruby-keyword">end</span></pre>
          </div><!-- challenge_assignment_ids-3D-source -->
          
        </div>

        

        
      </div><!-- challenge_assignment_ids-3D-method -->

    
      <div id="method-i-challenge_claim_ids" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">challenge_claim_ids</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="challenge_claim_ids-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 301</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">challenge_claim_ids</span>
  <span class="ruby-identifier">challenge_claims</span>.<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:id</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- challenge_claim_ids-source -->
          
        </div>

        

        
      </div><!-- challenge_claim_ids-method -->

    
      <div id="method-i-change_ownership" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">change_ownership</span><span
            class="method-args">(old_user, new_user, new_pseud=nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Transfer ownership of the work from one user to another</p>
          

          
          <div class="method-source-code" id="change_ownership-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 268</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">change_ownership</span>(<span class="ruby-identifier">old_user</span>, <span class="ruby-identifier">new_user</span>, <span class="ruby-identifier">new_pseud</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;No new user provided, cannot change ownership&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">new_user</span>
  <span class="ruby-identifier">new_pseud</span> = <span class="ruby-identifier">new_user</span>.<span class="ruby-identifier">default_pseud</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">new_pseud</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">new_pseud</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">chapter</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">chapter</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">new_pseud</span>
    <span class="ruby-identifier">chapter</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">save</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">remove_author</span>(<span class="ruby-identifier">old_user</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">old_user</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">users</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">old_user</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- change_ownership-source -->
          
        </div>

        

        
      </div><!-- change_ownership-method -->

    
      <div id="method-i-chapter_attributes-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">chapter_attributes=</span><span
            class="method-args">(attributes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Virtual attribute for first chapter</p>
          

          
          <div class="method-source-code" id="chapter_attributes-3D-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 449</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">chapter_attributes=</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">build</span>(<span class="ruby-identifier">attributes</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">attributes</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">posted</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">posted</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- chapter_attributes-3D-source -->
          
        </div>

        

        
      </div><!-- chapter_attributes-3D-method -->

    
      <div id="method-i-chapter_total_display" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">chapter_total_display</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>1/1, 2/3, 5/?, etc.</p>
          

          
          <div class="method-source-code" id="chapter_total_display-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 537</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">chapter_total_display</span>
  <span class="ruby-identifier">current</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">posted?</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">number_of_posted_chapters</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">current</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">'/'</span> <span class="ruby-operator">+</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">wip_length</span>.<span class="ruby-identifier">to_s</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- chapter_total_display-source -->
          
        </div>

        

        
      </div><!-- chapter_total_display-method -->

    
      <div id="method-i-chaptered-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">chaptered?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns true if a work has or will have more than one chapter</p>
          

          
          <div class="method-source-code" id="chaptered-3F-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 509</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">chaptered?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expected_number_of_chapters</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- chaptered-3F-source -->
          
        </div>

        

        
      </div><!-- chaptered-3F-method -->

    
      <div id="method-i-chapters_in_order" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">chapters_in_order</span><span
            class="method-args">(include_content = true)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="chapters_in_order-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 486</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">chapters_in_order</span>(<span class="ruby-identifier">include_content</span> = <span class="ruby-keyword">true</span>)
  <span class="ruby-comment"># in order</span>
  <span class="ruby-identifier">chapters</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">'position ASC'</span>)
  <span class="ruby-comment"># only posted chapters unless author</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Admin</span>) <span class="ruby-operator">||</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_author_of?</span>(<span class="ruby-keyword">self</span>))
    <span class="ruby-identifier">chapters</span> = <span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:posted</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># when doing navigation pass false as contents are not needed</span>
  <span class="ruby-identifier">chapters</span> = <span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">'published_at, id, work_id, title, position, posted'</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">include_content</span>
  <span class="ruby-identifier">chapters</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- chapters_in_order-source -->
          
        </div>

        

        
      </div><!-- chapters_in_order-method -->

    
      <div id="method-i-check_filter_counts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">check_filter_counts</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Determine if filter counts need to be reset after the work is saved</p>
          

          
          <div class="method-source-code" id="check_filter_counts-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 708</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">check_filter_counts</span>
  <span class="ruby-identifier">admin_settings</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">&quot;admin_settings&quot;</span>){<span class="ruby-constant">AdminSetting</span>.<span class="ruby-identifier">first</span>}
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">should_reset_filters</span> = (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_record?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">visibility_changed?</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">admin_settings</span>.<span class="ruby-identifier">suspend_filter_counts?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">restricted_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hidden_by_admin_changed?</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">should_reset_filters</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- check_filter_counts-source -->
          
        </div>

        

        
      </div><!-- check_filter_counts-method -->

    
      <div id="method-i-check_for_invalid_chapters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">check_for_invalid_chapters</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="check_for_invalid_chapters-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 159</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">check_for_invalid_chapters</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">errors</span>[<span class="ruby-value">:chapters</span>].<span class="ruby-identifier">any?</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">t</span>(<span class="ruby-string">'chapter_invalid'</span>, <span class="ruby-value">:default</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Please enter your story in the text field below.&quot;</span>))
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:chapters</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- check_for_invalid_chapters-source -->
          
        </div>

        

        
      </div><!-- check_for_invalid_chapters-method -->

    
      <div id="method-i-clean_and_validate_title" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clean_and_validate_title</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="clean_and_validate_title-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clean_and_validate_title</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">strip</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">TITLE_MIN</span>
      <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Title must be at least %{min} characters long without leading spaces.&quot;</span>, <span class="ruby-value">:min</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">TITLE_MIN</span>))
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title_to_sort_on</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">sorted_title</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clean_and_validate_title-source -->
          
        </div>

        

        
      </div><!-- clean_and_validate_title-method -->

    
      <div id="method-i-comments" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">comments</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>returns the top-level comments for all chapters in the work</p>
          

          
          <div class="method-source-code" id="comments-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 750</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">comments</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">comments</span> }.<span class="ruby-identifier">flatten</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- comments-source -->
          
        </div>

        

        
      </div><!-- comments-method -->

    
      <div id="method-i-count_all_comments" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">count_all_comments</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns number of comments Hidden and deleted comments are referenced in
the view because of the threading system - we don’t necessarily need to
hide their existence from other users</p>
          

          
          <div class="method-source-code" id="count_all_comments-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 745</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">count_all_comments</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">count_all_comments</span> }.<span class="ruby-identifier">sum</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- count_all_comments-source -->
          
        </div>

        

        
      </div><!-- count_all_comments-method -->

    
      <div id="method-i-create_hit_counter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_hit_counter</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="create_hit_counter-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 552</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create_hit_counter</span>
  <span class="ruby-identifier">counter</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">build_hit_counter</span>
  <span class="ruby-identifier">counter</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">set</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">redis_key</span>(<span class="ruby-value">:hit_count</span>), <span class="ruby-value">0</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_hit_counter-source -->
          
        </div>

        

        
      </div><!-- create_hit_counter-method -->

    
      <div id="method-i-database_hits" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">database_hits</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="database_hits-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 625</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">database_hits</span>
  <span class="ruby-identifier">db_hits</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hit_counter</span> <span class="ruby-operator">?</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hit_counter</span>.<span class="ruby-identifier">hit_count</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">db_hits</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- database_hits-source -->
          
        </div>

        

        
      </div><!-- database_hits-method -->

    
      <div id="method-i-default_date" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">default_date</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="default_date-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 400</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">default_date</span>
  <span class="ruby-identifier">backdate</span> = <span class="ruby-identifier">first_chapter</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:published_at</span>) <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">backdate</span>
  <span class="ruby-identifier">backdate</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- default_date-source -->
          
        </div>

        

        
      </div><!-- default_date-method -->

    
      <div id="method-i-destroy_chapters_in_reverse" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">destroy_chapters_in_reverse</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="destroy_chapters_in_reverse-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy_chapters_in_reverse</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;position DESC&quot;</span>).<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:destroy</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- destroy_chapters_in_reverse-source -->
          
        </div>

        

        
      </div><!-- destroy_chapters_in_reverse-method -->

    
      <div id="method-i-display_authors" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">display_authors</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="display_authors-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 599</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">display_authors</span>
  <span class="ruby-identifier">string</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">anonymous?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Anonymous&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">', '</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- display_authors-source -->
          
        </div>

        

        
      </div><!-- display_authors-method -->

    
      <div id="method-i-download_authors" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">download_authors</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>need the next two to be filesystem safe and not overly long</p>
          

          
          <div class="method-source-code" id="download_authors-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 603</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">download_authors</span>
  <span class="ruby-identifier">string</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">anonymous?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Anonymous&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">'-'</span>)
  <span class="ruby-identifier">string</span> = <span class="ruby-constant">Iconv</span>.<span class="ruby-identifier">conv</span>(<span class="ruby-string">&quot;ASCII//TRANSLIT//IGNORE&quot;</span>, <span class="ruby-string">&quot;UTF8&quot;</span>, <span class="ruby-identifier">string</span>)
  <span class="ruby-identifier">string</span> = <span class="ruby-identifier">string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[^[\w _-]]+/</span>, <span class="ruby-string">''</span>)
  <span class="ruby-identifier">string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^(.{24}[\w.]*).*/</span>) {<span class="ruby-node">$1</span>}
<span class="ruby-keyword">end</span></pre>
          </div><!-- download_authors-source -->
          
        </div>

        

        
      </div><!-- download_authors-method -->

    
      <div id="method-i-download_basename" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">download_basename</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="download_basename-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 615</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">download_basename</span>
  <span class="ruby-node">&quot;#{self.download_dir}/#{self.download_title}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- download_basename-source -->
          
        </div>

        

        
      </div><!-- download_basename-method -->

    
      <div id="method-i-download_dir" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">download_dir</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="download_dir-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 591</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">download_dir</span>
  <span class="ruby-node">&quot;#{Rails.public_path}/downloads/#{self.download_authors}/#{self.id}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- download_dir-source -->
          
        </div>

        

        
      </div><!-- download_dir-method -->

    
      <div id="method-i-download_fandoms" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">download_fandoms</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="download_fandoms-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 594</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">download_fandoms</span>
  <span class="ruby-identifier">string</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Multifandom&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">string</span>
  <span class="ruby-identifier">string</span> = <span class="ruby-constant">Iconv</span>.<span class="ruby-identifier">conv</span>(<span class="ruby-string">&quot;ASCII//TRANSLIT//IGNORE&quot;</span>, <span class="ruby-string">&quot;UTF8&quot;</span>, <span class="ruby-identifier">string</span>)
  <span class="ruby-identifier">string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[^[\w _-]]+/</span>, <span class="ruby-string">''</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- download_fandoms-source -->
          
        </div>

        

        
      </div><!-- download_fandoms-method -->

    
      <div id="method-i-download_title" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">download_title</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="download_title-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 609</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">download_title</span>
  <span class="ruby-identifier">string</span> = <span class="ruby-constant">Iconv</span>.<span class="ruby-identifier">conv</span>(<span class="ruby-string">&quot;ASCII//TRANSLIT//IGNORE&quot;</span>, <span class="ruby-string">&quot;UTF8&quot;</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>)
  <span class="ruby-identifier">string</span> = <span class="ruby-identifier">string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/[^[\w _-]]+/</span>, <span class="ruby-string">''</span>)
  <span class="ruby-identifier">string</span> = <span class="ruby-string">&quot;Work by &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">download_authors</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">string</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-identifier">string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/ +/</span>, <span class="ruby-string">&quot; &quot;</span>).<span class="ruby-identifier">strip</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^(.{24}[\w.]*).*/</span>) {<span class="ruby-node">$1</span>}
<span class="ruby-keyword">end</span></pre>
          </div><!-- download_title-source -->
          
        </div>

        

        
      </div><!-- download_title-method -->

    
      <div id="method-i-ensure_revised_at" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ensure_revised_at</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Just to catch any cases that haven’t gone through <a
href="Work.html#method-i-set_revised_at">#set_revised_at</a></p>
          

          
          <div class="method-source-code" id="ensure_revised_at-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 390</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ensure_revised_at</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ensure_revised_at-source -->
          
        </div>

        

        
      </div><!-- ensure_revised_at-method -->

    
      <div id="method-i-find_all_comments" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_all_comments</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Gets all comments for all chapters in the work</p>
          

          
          <div class="method-source-code" id="find_all_comments-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 738</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_all_comments</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">find_all_comments</span> }.<span class="ruby-identifier">flatten</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- find_all_comments-source -->
          
        </div>

        

        
      </div><!-- find_all_comments-method -->

    
      <div id="method-i-first_chapter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">first_chapter</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Gets the current first chapter</p>
          

          
          <div class="method-source-code" id="first_chapter-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 499</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">first_chapter</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">:first</span>, <span class="ruby-value">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'position ASC'</span>) <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- first_chapter-source -->
          
        </div>

        

        
      </div><!-- first_chapter-method -->

    
      <div id="method-i-has_required_tags-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_required_tags?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Check to see that a work is tagged appropriately</p>
          

          
          <div class="method-source-code" id="has_required_tags-3F-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 651</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_required_tags?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fandom_string</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">warning_string</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">rating_string</span>.<span class="ruby-identifier">blank?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- has_required_tags-3F-source -->
          
        </div>

        

        
      </div><!-- has_required_tags-3F-method -->

    
      <div id="method-i-hits" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hits</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="hits-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 619</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">hits</span>
  <span class="ruby-identifier">redis_hits</span> = <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">get</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">redis_key</span>(<span class="ruby-value">:hit_count</span>))
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">database_hits</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">redis_hits</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">redis_hits</span>.<span class="ruby-identifier">to_i</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- hits-source -->
          
        </div>

        

        
      </div><!-- hits-method -->

    
      <div id="method-i-increment_hit_count" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">increment_hit_count</span><span
            class="method-args">(visitor)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>save hits</p>
          

          
          <div class="method-source-code" id="increment_hit_count-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 559</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">increment_hit_count</span>(<span class="ruby-identifier">visitor</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">last_visitor</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">visitor</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">User</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_author_of?</span>(<span class="ruby-keyword">self</span>)
      <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">set</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">redis_key</span>(<span class="ruby-value">:hit_count</span>), <span class="ruby-keyword">self</span>.<span class="ruby-identifier">database_hits</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">get</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">redis_key</span>(<span class="ruby-value">:hit_count</span>))
      <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">incr</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">redis_key</span>(<span class="ruby-value">:hit_count</span>))
      <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">set</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">redis_key</span>(<span class="ruby-value">:last_visitor</span>), <span class="ruby-identifier">visitor</span>)
      <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">sadd</span>(<span class="ruby-string">&quot;Work:new_hits&quot;</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hits</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- increment_hit_count-source -->
          
        </div>

        

        
      </div><!-- increment_hit_count-method -->

    
      <div id="method-i-is_complete" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_complete</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns true if a work is complete</p>
          

          
          <div class="method-source-code" id="is_complete-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 532</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_complete</span>
  <span class="ruby-keyword">return</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_wip</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_complete-source -->
          
        </div>

        

        
      </div><!-- is_complete-method -->

    
      <div id="method-i-is_wip" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_wip</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns true if a work is not yet complete</p>
          

          
          <div class="method-source-code" id="is_wip-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 527</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_wip</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expected_number_of_chapters</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expected_number_of_chapters</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">number_of_posted_chapters</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_wip-source -->
          
        </div>

        

        
      </div><!-- is_wip-method -->

    
      <div id="method-i-last_chapter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">last_chapter</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Gets the current last chapter</p>
          

          
          <div class="method-source-code" id="last_chapter-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 504</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">last_chapter</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">find</span>(<span class="ruby-value">:first</span>, <span class="ruby-value">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'position DESC'</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- last_chapter-source -->
          
        </div>

        

        
      </div><!-- last_chapter-method -->

    
      <div id="method-i-last_visitor" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">last_visitor</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>the last visitor is just used to decide whether or not to increment the hit
count so persisting it in the database is not critical</p>
          

          
          <div class="method-source-code" id="last_visitor-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 573</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">last_visitor</span>
  <span class="ruby-identifier">$redis</span>.<span class="ruby-identifier">get</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">redis_key</span>(<span class="ruby-value">:last_visitor</span>))
<span class="ruby-keyword">end</span></pre>
          </div><!-- last_visitor-source -->
          
        </div>

        

        
      </div><!-- last_visitor-method -->

    
      <div id="method-i-multipart-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">multipart?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns true if a work has more than one chapter</p>
          

          
          <div class="method-source-code" id="multipart-3F-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 514</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">multipart?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">number_of_chapters</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- multipart-3F-source -->
          
        </div>

        

        
      </div><!-- multipart-3F-method -->

    
      <div id="method-i-number_of_chapters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">number_of_chapters</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Get the total number of chapters for a work</p>
          

          
          <div class="method-source-code" id="number_of_chapters-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 475</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">number_of_chapters</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">count</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- number_of_chapters-source -->
          
        </div>

        

        
      </div><!-- number_of_chapters-method -->

    
      <div id="method-i-number_of_posted_chapters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">number_of_posted_chapters</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Get the total number of posted chapters for a work Issue 1316: total number
needs to reflect the actual number of chapters posted rather than the total
number of chapters indicated by user</p>
          

          
          <div class="method-source-code" id="number_of_posted_chapters-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 482</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">number_of_posted_chapters</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">posted</span>.<span class="ruby-identifier">count</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- number_of_posted_chapters-source -->
          
        </div>

        

        
      </div><!-- number_of_posted_chapters-method -->

    
      <div id="method-i-parent_attributes-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parent_attributes=</span><span
            class="method-args">(attributes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Virtual attribute for parent work, via related_works</p>
          

          
          <div class="method-source-code" id="parent_attributes-3D-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 767</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parent_attributes=</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:url</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:url</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">APP_URL</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:url</span>].<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/\/works\/(\d+)/</span>)
        <span class="ruby-keyword">begin</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span> = {<span class="ruby-value">:parent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find</span>(<span class="ruby-node">$1</span>), <span class="ruby-value">:translation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:translation</span>]}
        <span class="ruby-keyword">rescue</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;The work you listed as an inspiration does not seem to exist.&quot;</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Only a link to a work can be listed as an inspiration.&quot;</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:title</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:author</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">error_message</span> = <span class="ruby-string">&quot;&quot;</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:title</span>].<span class="ruby-identifier">blank?</span>
        <span class="ruby-identifier">error_message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;A parent work outside the archive needs to have a title. &quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:author</span>].<span class="ruby-identifier">blank?</span>
        <span class="ruby-identifier">error_message</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;A parent work outside the archive needs to have an author. &quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">error_message</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">translation</span> = <span class="ruby-identifier">attributes</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:translation</span>)
      <span class="ruby-identifier">ew</span> = <span class="ruby-constant">ExternalWork</span>.<span class="ruby-identifier">find_by_url</span>(<span class="ruby-identifier">attributes</span>[<span class="ruby-value">:url</span>])
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">ew</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">ew</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:title</span>]) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">ew</span>.<span class="ruby-identifier">author</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:author</span>])
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span> = {<span class="ruby-value">:parent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ew</span>, <span class="ruby-value">:translation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">translation</span>}
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">ew</span> = <span class="ruby-constant">ExternalWork</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">attributes</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">ew</span>.<span class="ruby-identifier">save</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span> = {<span class="ruby-value">:parent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ew</span>, <span class="ruby-value">:translation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">translation</span>}
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Parent work info would not save.&quot;</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- parent_attributes-3D-source -->
          
        </div>

        

        
      </div><!-- parent_attributes-3D-method -->

    
      <div id="method-i-parents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parents</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Works (internal or external) that this work was inspired by Can’t make this
a has_many association because it’s polymorphic</p>
          

          
          <div class="method-source-code" id="parents-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 762</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parents</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parent_work_relationships</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:parent</span>).<span class="ruby-identifier">compact</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- parents-source -->
          
        </div>

        

        
      </div><!-- parents-method -->

    
      <div id="method-i-post_first_chapter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">post_first_chapter</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>If the work is posted, the first chapter should be posted too</p>
          

          
          <div class="method-source-code" id="post_first_chapter-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 442</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">post_first_chapter</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">posted_changed?</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">posted</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">posted</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- post_first_chapter-source -->
          
        </div>

        

        
      </div><!-- post_first_chapter-method -->

    
      <div id="method-i-published_at" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">published_at</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="published_at-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 396</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">published_at</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">first_chapter</span>.<span class="ruby-identifier">published_at</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- published_at-source -->
          
        </div>

        

        
      </div><!-- published_at-method -->

    
      <div id="method-i-recipients" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">recipients</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="recipients-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 322</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">recipients</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gifts</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:recipient</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- recipients-source -->
          
        </div>

        

        
      </div><!-- recipients-method -->

    
      <div id="method-i-recipients-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">recipients=</span><span
            class="method-args">(recipient_names)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="recipients-3D-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 309</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">recipients=</span>(<span class="ruby-identifier">recipient_names</span>)
  <span class="ruby-identifier">new_gifts</span> = []
  <span class="ruby-identifier">recipient_names</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">','</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">gift</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gifts</span>.<span class="ruby-identifier">for_name_or_byline</span>(<span class="ruby-identifier">name</span>.<span class="ruby-identifier">strip</span>).<span class="ruby-identifier">first</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">gift</span>
      <span class="ruby-identifier">new_gifts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gift</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">new_gifts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Gift</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:recipient</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">strip</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gifts</span> = <span class="ruby-identifier">new_gifts</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- recipients-3D-source -->
          
        </div>

        

        
      </div><!-- recipients-3D-method -->

    
      <div id="method-i-redis_key" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">redis_key</span><span
            class="method-args">(sym)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>helper method to generate redis keys examples: “work:2:hit_count”,
“work:776:<a href="Work.html#method-i-last_visitor">#last_visitor</a>”</p>
          

          
          <div class="method-source-code" id="redis_key-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 632</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">redis_key</span>(<span class="ruby-identifier">sym</span>)
  <span class="ruby-node">&quot;work:#{self.id}:#{sym}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- redis_key-source -->
          
        </div>

        

        
      </div><!-- redis_key-method -->

    
      <div id="method-i-remove_author" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_author</span><span
            class="method-args">(author_to_remove)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_author-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 253</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_author</span>(<span class="ruby-identifier">author_to_remove</span>)
  <span class="ruby-identifier">pseuds_with_author_removed</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">author_to_remove</span>.<span class="ruby-identifier">pseuds</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">Exception</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">&quot;Sorry, we can't remove all authors of a work.&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">pseuds_with_author_removed</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span> = <span class="ruby-identifier">pseuds_with_author_removed</span>
  <span class="ruby-identifier">save</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">chapter</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">chapter</span>.<span class="ruby-identifier">pseuds</span> = (<span class="ruby-identifier">chapter</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">author_to_remove</span>.<span class="ruby-identifier">pseuds</span>).<span class="ruby-identifier">uniq</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">chapter</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">chapter</span>.<span class="ruby-identifier">pseuds</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">chapter</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_author-source -->
          
        </div>

        

        
      </div><!-- remove_author-method -->

    
      <div id="method-i-remove_filter_tagging" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_filter_tagging</span><span
            class="method-args">(tag)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Removes filter_tagging relationship unless the work is tagged with more
than one synonymous tags</p>
          

          
          <div class="method-source-code" id="remove_filter_tagging-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 682</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_filter_tagging</span>(<span class="ruby-identifier">tag</span>)
  <span class="ruby-identifier">filter</span> = <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">filter</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">filter</span>
    <span class="ruby-identifier">filters_to_remove</span> = [<span class="ruby-identifier">filter</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">filter</span>.<span class="ruby-identifier">meta_tags</span>
    <span class="ruby-identifier">filters_to_remove</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter_to_remove</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">filters</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">filter_to_remove</span>)
        <span class="ruby-identifier">all_sub_tags</span> = <span class="ruby-identifier">filter_to_remove</span>.<span class="ruby-identifier">sub_tags</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">filter_to_remove</span>]
        <span class="ruby-identifier">sub_mergers</span> = <span class="ruby-identifier">all_sub_tags</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">?</span> [] <span class="ruby-operator">:</span> <span class="ruby-identifier">all_sub_tags</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:mergers</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
        <span class="ruby-identifier">all_tags_with_filter_to_remove_as_meta</span> = <span class="ruby-identifier">all_sub_tags</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sub_mergers</span>
        <span class="ruby-identifier">remaining_tags</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tags</span> <span class="ruby-operator">-</span> [<span class="ruby-identifier">tag</span>]
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">remaining_tags</span> &amp; <span class="ruby-identifier">all_tags_with_filter_to_remove_as_meta</span>).<span class="ruby-identifier">empty?</span> <span class="ruby-comment"># none of the remaining tags need filter_to_remove</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">filters</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">filter_to_remove</span>)
          <span class="ruby-identifier">filter_to_remove</span>.<span class="ruby-identifier">reset_filter_count</span>
        <span class="ruby-keyword">else</span> <span class="ruby-comment"># we should keep filter_to_remove, but check if inheritence needs to be updated</span>
          <span class="ruby-identifier">direct_tags_for_filter_to_remove</span> = <span class="ruby-identifier">filter_to_remove</span>.<span class="ruby-identifier">mergers</span> <span class="ruby-operator">+</span> [<span class="ruby-identifier">filter_to_remove</span>]
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">remaining_tags</span> &amp; <span class="ruby-identifier">direct_tags_for_filter_to_remove</span>).<span class="ruby-identifier">empty?</span> <span class="ruby-comment"># not tagged with filter or mergers directly</span>
            <span class="ruby-identifier">ft</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">filter_taggings</span>.<span class="ruby-identifier">where</span>([<span class="ruby-string">&quot;filter_id = ?&quot;</span>, <span class="ruby-identifier">filter_to_remove</span>.<span class="ruby-identifier">id</span>]).<span class="ruby-identifier">first</span>
            <span class="ruby-identifier">ft</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:inherited</span>, <span class="ruby-keyword">true</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_filter_tagging-source -->
          
        </div>

        

        
      </div><!-- remove_filter_tagging-method -->

    
      <div id="method-i-remove_outdated_downloads" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_outdated_downloads</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_outdated_downloads-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 588</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_outdated_downloads</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">download_dir</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_outdated_downloads-source -->
          
        </div>

        

        
      </div><!-- remove_outdated_downloads-method -->

    
      <div id="method-i-reorder" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reorder</span><span
            class="method-args">(positions)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Change the positions of the chapters in the work</p>
          

          
          <div class="method-source-code" id="reorder-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 465</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reorder</span>(<span class="ruby-identifier">positions</span>)
  <span class="ruby-constant">SortableList</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">posted</span>.<span class="ruby-identifier">in_order</span>).<span class="ruby-identifier">reorder_list</span>(<span class="ruby-identifier">positions</span>)
  <span class="ruby-comment"># We're caching the chapter positions in the comment blurbs</span>
  <span class="ruby-comment"># so we need to expire them</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">each</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">touch</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- reorder-source -->
          
        </div>

        

        
      </div><!-- reorder-method -->

    
      <div id="method-i-save_chapters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save_chapters</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Save chapter data when the work is updated</p>
          

          
          <div class="method-source-code" id="save_chapters-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 437</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save_chapters</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">save</span>(<span class="ruby-value">:validate</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- save_chapters-source -->
          
        </div>

        

        
      </div><!-- save_chapters-method -->

    
      <div id="method-i-save_parents" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">save_parents</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Save relationship to parent work if applicable</p>
          

          
          <div class="method-source-code" id="save_parents-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 806</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">save_parents</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">parents</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span>))
    <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span>[<span class="ruby-value">:parent</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">relationship</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span>[<span class="ruby-value">:parent</span>].<span class="ruby-identifier">related_works</span>.<span class="ruby-identifier">build</span> <span class="ruby-value">:work_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>, <span class="ruby-value">:translation</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span>[<span class="ruby-value">:translation</span>]
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">relationship</span>.<span class="ruby-identifier">save</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_parent</span> = <span class="ruby-keyword">nil</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- save_parents-source -->
          
        </div>

        

        
      </div><!-- save_parents-method -->

    
      <div id="method-i-series_attributes-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">series_attributes=</span><span
            class="method-args">(attributes)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Virtual attribute for series</p>
          

          
          <div class="method-source-code" id="series_attributes-3D-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 410</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">series_attributes=</span>(<span class="ruby-identifier">attributes</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">attributes</span>[<span class="ruby-value">:id</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">old_series</span> = <span class="ruby-constant">Series</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">attributes</span>[<span class="ruby-value">:id</span>])
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">series</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">old_series</span> <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">old_series</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">old_series</span>))
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">adjust_series_restriction</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">attributes</span>[<span class="ruby-value">:title</span>].<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">new_series</span> = <span class="ruby-constant">Series</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">new_series</span>.<span class="ruby-identifier">title</span> = <span class="ruby-identifier">attributes</span>[<span class="ruby-value">:title</span>]
    <span class="ruby-identifier">new_series</span>.<span class="ruby-identifier">restricted</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">restricted</span>
    <span class="ruby-identifier">new_series</span>.<span class="ruby-identifier">authors</span> = (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">+</span> (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> [] <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span>)).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
    <span class="ruby-identifier">new_series</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">series</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">new_series</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- series_attributes-3D-source -->
          
        </div>

        

        
      </div><!-- series_attributes-3D-method -->

    
      <div id="method-i-set_challenge_claim_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_challenge_claim_info</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="set_challenge_claim_info-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 288</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_challenge_claim_info</span>
  <span class="ruby-comment"># if this is fulfilling a challenge claim, add the collection and recipient</span>
  <span class="ruby-identifier">challenge_claims</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">assignment</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">add_to_collection</span>(<span class="ruby-identifier">claim</span>.<span class="ruby-identifier">collection</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gifts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Gift</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:pseud</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">requesting_pseud</span>) <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">recipients</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">recipients</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">claim</span>.<span class="ruby-identifier">request_byline</span>))
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_challenge_claim_info-source -->
          
        </div>

        

        
      </div><!-- set_challenge_claim_info-method -->

    
      <div id="method-i-set_challenge_info" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_challenge_info</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="set_challenge_info-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 280</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_challenge_info</span>
  <span class="ruby-comment"># if this is fulfilling a challenge, add the collection and recipient</span>
  <span class="ruby-identifier">challenge_assignments</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">assignment</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">add_to_collection</span>(<span class="ruby-identifier">assignment</span>.<span class="ruby-identifier">collection</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gifts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Gift</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:pseud</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">assignment</span>.<span class="ruby-identifier">requesting_pseud</span>) <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">recipients</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">recipients</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">assignment</span>.<span class="ruby-identifier">requesting_pseud</span>.<span class="ruby-identifier">byline</span>))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_challenge_info-source -->
          
        </div>

        

        
      </div><!-- set_challenge_info-method -->

    
      <div id="method-i-set_revised_at" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_revised_at</span><span
            class="method-args">(date=nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="set_revised_at-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 370</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_revised_at</span>(<span class="ruby-identifier">date</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">date</span> <span class="ruby-comment"># if we pass a date, we want to set it to that (or current datetime if it's today)</span>
    <span class="ruby-identifier">date</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">value</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">value</span> = <span class="ruby-constant">DateTime</span><span class="ruby-operator">::</span><span class="ruby-identifier">jd</span>(<span class="ruby-identifier">date</span>.<span class="ruby-identifier">jd</span>, <span class="ruby-value">12</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>)
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span> = <span class="ruby-identifier">value</span>
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># we want to find the most recent @chapter.published_at date</span>
    <span class="ruby-identifier">recent_date</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">maximum</span>(<span class="ruby-string">'published_at'</span>)
    <span class="ruby-comment"># if recent_date is today and revised_at is today, we don't want to update revised_at at all</span>
    <span class="ruby-comment"># because we'd overwrite with an inaccurate time; if revised_at is not already today, best we can</span>
    <span class="ruby-comment"># do is update with current time</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">recent_date</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">recent_date</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span>.<span class="ruby-identifier">to_date</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">revised_at</span> = <span class="ruby-constant">DateTime</span><span class="ruby-operator">::</span><span class="ruby-identifier">jd</span>(<span class="ruby-identifier">recent_date</span>.<span class="ruby-identifier">jd</span>, <span class="ruby-value">12</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_revised_at-source -->
          
        </div>

        

        
      </div><!-- set_revised_at-method -->

    
      <div id="method-i-set_word_count" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_word_count</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Set the value of word_count to reflect the length of the chapter content</p>
          

          
          <div class="method-source-code" id="set_word_count-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 543</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_word_count</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">new_record?</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">word_count</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">set_word_count</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">word_count</span> = <span class="ruby-constant">Chapter</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;SUM(word_count) AS work_word_count&quot;</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:work_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">first</span>.<span class="ruby-identifier">work_word_count</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_word_count-source -->
          
        </div>

        

        
      </div><!-- set_word_count-method -->

    
      <div id="method-i-sorted_authors" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sorted_authors</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>SORTING</p>
          

          
          <div class="method-source-code" id="sorted_authors-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 1076</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sorted_authors</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,  &quot;</span>).<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^[\+-=_\?!'&quot;\.\/]/</span>, <span class="ruby-string">''</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- sorted_authors-source -->
          
        </div>

        

        
      </div><!-- sorted_authors-method -->

    
      <div id="method-i-sorted_pseuds" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sorted_pseuds</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="sorted_pseuds-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 1080</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sorted_pseuds</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,  &quot;</span>).<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^[\+-=_\?!'&quot;\.\/]/</span>, <span class="ruby-string">''</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- sorted_pseuds-source -->
          
        </div>

        

        
      </div><!-- sorted_pseuds-method -->

    
      <div id="method-i-sorted_title" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sorted_title</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="sorted_title-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 1084</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sorted_title</span>
  <span class="ruby-identifier">sorted_title</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">title</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^[&quot;'\.\/]/</span>, <span class="ruby-string">''</span>)
  <span class="ruby-identifier">sorted_title</span> = <span class="ruby-identifier">sorted_title</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^(an?) (.*)/</span>, <span class="ruby-string">'\2, \1'</span>)
  <span class="ruby-identifier">sorted_title</span> = <span class="ruby-identifier">sorted_title</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^the (.*)/</span>, <span class="ruby-string">'\1, the'</span>)
  <span class="ruby-identifier">sorted_title</span> = <span class="ruby-identifier">sorted_title</span>.<span class="ruby-identifier">rjust</span>(<span class="ruby-value">5</span>, <span class="ruby-string">&quot;0&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">sorted_title</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/^\d/</span>)
  <span class="ruby-identifier">sorted_title</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- sorted_title-source -->
          
        </div>

        

        
      </div><!-- sorted_title-method -->

    
      <div id="method-i-tag_groups" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tag_groups</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>TAGGING Works are taggable objects.</p>
          

          
          <div class="method-source-code" id="tag_groups-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 642</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tag_groups</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">placeholder_tags</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">placeholder_tags</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">group_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">type</span>.<span class="ruby-identifier">to_s</span> }
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">group_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">type</span>.<span class="ruby-identifier">to_s</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- tag_groups-source -->
          
        </div>

        

        
      </div><!-- tag_groups-method -->

    
      <div id="method-i-unrevealed-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">unrevealed?</span><span
            class="method-args">(user=User.current_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="unrevealed-3F-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 345</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">unrevealed?</span>(<span class="ruby-identifier">user</span>=<span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>)
  <span class="ruby-comment"># eventually here is where we check if it's in a challenge that hasn't been made public yet</span>
  <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">approved_collection_items</span>.<span class="ruby-identifier">unrevealed</span>.<span class="ruby-identifier">empty?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- unrevealed-3F-source -->
          
        </div>

        

        
      </div><!-- unrevealed-3F-method -->

    
      <div id="method-i-update_complete_status" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_complete_status</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="update_complete_status-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 519</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_complete_status</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">complete</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">posted</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">expected_number_of_chapters</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">complete_changed?</span>
    <span class="ruby-constant">Work</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;complete = #{self.complete}&quot;</span>, <span class="ruby-node">&quot;id = #{self.id}&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_complete_status-source -->
          
        </div>

        

        
      </div><!-- update_complete_status-method -->

    
      <div id="method-i-update_major_version" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_major_version</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>provide an interface to increment major version number resets minor_version
to 0</p>
          

          
          <div class="method-source-code" id="update_major_version-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 361</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_major_version</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_attributes</span>({<span class="ruby-value">:major_version</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">major_version</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>, <span class="ruby-value">:minor_version</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>})
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_major_version-source -->
          
        </div>

        

        
      </div><!-- update_major_version-method -->

    
      <div id="method-i-update_minor_version" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_minor_version</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>provide an interface to increment minor version number</p>
          

          
          <div class="method-source-code" id="update_minor_version-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 366</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_minor_version</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_attribute</span>(<span class="ruby-value">:minor_version</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">minor_version</span><span class="ruby-operator">+</span><span class="ruby-value">1</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_minor_version-source -->
          
        </div>

        

        
      </div><!-- update_minor_version-method -->

    
      <div id="method-i-validate_authors" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">validate_authors</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Checks that work has at least one author</p>
          

          
          <div class="method-source-code" id="validate_authors-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 119</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">validate_authors</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">t</span>(<span class="ruby-string">'must_have_author'</span>, <span class="ruby-value">:default</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Work must have at least one author.&quot;</span>))
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors_to_sort_on</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">sorted_pseuds</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">invalid_pseuds</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">t</span>(<span class="ruby-string">'invalid_pseuds'</span>, <span class="ruby-value">:default</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;These pseuds are invalid: %{pseuds}&quot;</span>, <span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">invalid_pseuds</span>.<span class="ruby-identifier">inspect</span>))
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">authors_to_sort_on</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">sorted_authors</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- validate_authors-source -->
          
        </div>

        

        
      </div><!-- validate_authors-method -->

    
      <div id="method-i-validate_published_at" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">validate_published_at</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="validate_published_at-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 148</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">validate_published_at</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">first_chapter</span>.<span class="ruby-identifier">published_at</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">first_chapter</span>.<span class="ruby-identifier">published_at</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">first_chapter</span>.<span class="ruby-identifier">published_at</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>
    <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">t</span>(<span class="ruby-string">'no_future_dating'</span>, <span class="ruby-value">:default</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Publication date can't be in the future.&quot;</span>))
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- validate_published_at-source -->
          
        </div>

        

        
      </div><!-- validate_published_at-method -->

    
      <div id="method-i-visibility_changed-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visibility_changed?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Must be called before save</p>
          

          
          <div class="method-source-code" id="visibility_changed-3F-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 718</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">visibility_changed?</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">posted_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">restricted_changed?</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hidden_by_admin_changed?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- visibility_changed-3F-source -->
          
        </div>

        

        
      </div><!-- visibility_changed-3F-method -->

    
      <div id="method-i-visible" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visible</span><span
            class="method-args">(current_user=User.current_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>VISIBILITY</p>
          

          
          <div class="method-source-code" id="visible-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 330</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">visible</span>(<span class="ruby-identifier">current_user</span>=<span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">==</span> <span class="ruby-value">:false</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">posted</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">restricted</span> <span class="ruby-operator">||</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hidden_by_admin</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">posted</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-keyword">self</span>.<span class="ruby-identifier">hidden_by_admin</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">hidden_by_admin?</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">kind_of?</span>(<span class="ruby-constant">Admin</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">is_author_of?</span>(<span class="ruby-keyword">self</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- visible-source -->
          
        </div>

        

        
      </div><!-- visible-method -->

    
      <div id="method-i-visible-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visible?</span><span
            class="method-args">(user=User.current_user)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="visible-3F-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 340</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">visible?</span>(<span class="ruby-identifier">user</span>=<span class="ruby-constant">User</span>.<span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">visible</span>(<span class="ruby-identifier">user</span>) <span class="ruby-operator">==</span> <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- visible-3F-source -->
          
        </div>

        

        
      </div><!-- visible-3F-method -->

    
      <div id="method-i-wip_length" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wip_length</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Virtual attribute for # of chapters</p>
          

          
          <div class="method-source-code" id="wip_length-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 455</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">wip_length</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expected_number_of_chapters</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;?&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expected_number_of_chapters</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- wip_length-source -->
          
        </div>

        

        
      </div><!-- wip_length-method -->

    
      <div id="method-i-wip_length-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wip_length=</span><span
            class="method-args">(number)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="wip_length-3D-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 459</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">wip_length=</span>(<span class="ruby-identifier">number</span>)
  <span class="ruby-identifier">number</span> = <span class="ruby-identifier">number</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expected_number_of_chapters</span> = (<span class="ruby-identifier">number</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">number</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">length</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">number</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- wip_length-3D-source -->
          
        </div>

        

        
      </div><!-- wip_length-3D-method -->

    
      <div id="method-i-work_skin_allowed" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">work_skin_allowed</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="work_skin_allowed-source">
            <pre><span class="ruby-comment"># File app/models/work.rb, line 72</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">work_skin_allowed</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_skin</span>.<span class="ruby-identifier">author</span>) <span class="ruby-operator">||</span> (<span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_skin</span>.<span class="ruby-identifier">public?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">work_skin</span>.<span class="ruby-identifier">official?</span>)
    <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You do not have permission to use that custom work stylesheet.&quot;</span>))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- work_skin_allowed-source -->
          
        </div>

        

        
      </div><!-- work_skin_allowed-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.11.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

