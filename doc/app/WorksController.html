<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class WorksController - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>app/controllers/works_controller.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="ApplicationController.html">ApplicationController</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-i-cancel_posting_and_redirect">#cancel_posting_and_redirect</a>
    
    <li><a href="#method-i-confirm_delete">#confirm_delete</a>
    
    <li><a href="#method-i-confirm_delete_multiple">#confirm_delete_multiple</a>
    
    <li><a href="#method-i-create">#create</a>
    
    <li><a href="#method-i-delete_multiple">#delete_multiple</a>
    
    <li><a href="#method-i-destroy">#destroy</a>
    
    <li><a href="#method-i-drafts">#drafts</a>
    
    <li><a href="#method-i-edit">#edit</a>
    
    <li><a href="#method-i-edit_multiple">#edit_multiple</a>
    
    <li><a href="#method-i-edit_tags">#edit_tags</a>
    
    <li><a href="#method-i-import">#import</a>
    
    <li><a href="#method-i-import_multiple">#import_multiple</a>
    
    <li><a href="#method-i-import_single">#import_single</a>
    
    <li><a href="#method-i-index">#index</a>
    
    <li><a href="#method-i-load_pseuds">#load_pseuds</a>
    
    <li><a href="#method-i-load_work">#load_work</a>
    
    <li><a href="#method-i-marktoread">#marktoread</a>
    
    <li><a href="#method-i-navigate">#navigate</a>
    
    <li><a href="#method-i-new">#new</a>
    
    <li><a href="#method-i-post_draft">#post_draft</a>
    
    <li><a href="#method-i-preview">#preview</a>
    
    <li><a href="#method-i-preview_tags">#preview_tags</a>
    
    <li><a href="#method-i-search">#search</a>
    
    <li><a href="#method-i-send_external_invites">#send_external_invites</a>
    
    <li><a href="#method-i-set_author_attributes">#set_author_attributes</a>
    
    <li><a href="#method-i-set_instance_variables">#set_instance_variables</a>
    
    <li><a href="#method-i-set_instance_variables_tags">#set_instance_variables_tags</a>
    
    <li><a href="#method-i-show">#show</a>
    
    <li><a href="#method-i-show_multiple">#show_multiple</a>
    
    <li><a href="#method-i-tag_list">#tag_list</a>
    
    <li><a href="#method-i-update">#update</a>
    
    <li><a href="#method-i-update_multiple">#update_multiple</a>
    
    <li><a href="#method-i-update_tags">#update_tags</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./app/mailers/README.html">README</a>
  
    <li class="file"><a href="./app/views/epub/mimetype.html">mimetype</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./Admin.html">Admin</a>
  
    <li><a href="./Admin/AdminInvitationsController.html">Admin::AdminInvitationsController</a>
  
    <li><a href="./Admin/AdminUsersController.html">Admin::AdminUsersController</a>
  
    <li><a href="./Admin/SettingsController.html">Admin::SettingsController</a>
  
    <li><a href="./Admin/SkinsController.html">Admin::SkinsController</a>
  
    <li><a href="./Admin/StatsController.html">Admin::StatsController</a>
  
    <li><a href="./Admin/UserCreationsController.html">Admin::UserCreationsController</a>
  
    <li><a href="./Static.html">Static</a>
  
    <li><a href="./Static/BaseController.html">Static::BaseController</a>
  
    <li><a href="./Static/CollectionsController.html">Static::CollectionsController</a>
  
    <li><a href="./Static/FandomsController.html">Static::FandomsController</a>
  
    <li><a href="./Static/MediaController.html">Static::MediaController</a>
  
    <li><a href="./Static/RestrictedWorksController.html">Static::RestrictedWorksController</a>
  
    <li><a href="./Static/WorksController.html">Static::WorksController</a>
  
    <li><a href="./Challenge.html">Challenge</a>
  
    <li><a href="./Challenge/GiftExchangeController.html">Challenge::GiftExchangeController</a>
  
    <li><a href="./Challenge/PromptMemeController.html">Challenge::PromptMemeController</a>
  
    <li><a href="./Opendoors.html">Opendoors</a>
  
    <li><a href="./Opendoors/ExternalAuthorsController.html">Opendoors::ExternalAuthorsController</a>
  
    <li><a href="./Opendoors/ToolsController.html">Opendoors::ToolsController</a>
  
    <li><a href="./StoryParser.html">StoryParser</a>
  
    <li><a href="./StoryParser/Error.html">StoryParser::Error</a>
  
    <li><a href="./AbuseReport.html">AbuseReport</a>
  
    <li><a href="./AbuseReportsController.html">AbuseReportsController</a>
  
    <li><a href="./AdminMailer.html">AdminMailer</a>
  
    <li><a href="./AdminPost.html">AdminPost</a>
  
    <li><a href="./AdminPostTag.html">AdminPostTag</a>
  
    <li><a href="./AdminPostTagging.html">AdminPostTagging</a>
  
    <li><a href="./AdminPostsController.html">AdminPostsController</a>
  
    <li><a href="./AdminSession.html">AdminSession</a>
  
    <li><a href="./AdminSessionsController.html">AdminSessionsController</a>
  
    <li><a href="./AdminSetting.html">AdminSetting</a>
  
    <li><a href="./AdminsController.html">AdminsController</a>
  
    <li><a href="./AdvancedSearchHelper.html">AdvancedSearchHelper</a>
  
    <li><a href="./AlphabetHelper.html">AlphabetHelper</a>
  
    <li><a href="./ApplicationController.html">ApplicationController</a>
  
    <li><a href="./ApplicationHelper.html">ApplicationHelper</a>
  
    <li><a href="./ArchiveFaq.html">ArchiveFaq</a>
  
    <li><a href="./ArchiveFaqsController.html">ArchiveFaqsController</a>
  
    <li><a href="./AutocompleteController.html">AutocompleteController</a>
  
    <li><a href="./Banned.html">Banned</a>
  
    <li><a href="./Bookmark.html">Bookmark</a>
  
    <li><a href="./BookmarksController.html">BookmarksController</a>
  
    <li><a href="./BookmarksHelper.html">BookmarksHelper</a>
  
    <li><a href="./CacheHelper.html">CacheHelper</a>
  
    <li><a href="./CastNomination.html">CastNomination</a>
  
    <li><a href="./Category.html">Category</a>
  
    <li><a href="./ChallengeAssignment.html">ChallengeAssignment</a>
  
    <li><a href="./ChallengeAssignmentsController.html">ChallengeAssignmentsController</a>
  
    <li><a href="./ChallengeClaim.html">ChallengeClaim</a>
  
    <li><a href="./ChallengeClaimsController.html">ChallengeClaimsController</a>
  
    <li><a href="./ChallengeHelper.html">ChallengeHelper</a>
  
    <li><a href="./ChallengeRequestsController.html">ChallengeRequestsController</a>
  
    <li><a href="./ChallengeSignup.html">ChallengeSignup</a>
  
    <li><a href="./ChallengeSignupObserver.html">ChallengeSignupObserver</a>
  
    <li><a href="./ChallengeSignupSweeper.html">ChallengeSignupSweeper</a>
  
    <li><a href="./ChallengeSignupsController.html">ChallengeSignupsController</a>
  
    <li><a href="./ChallengeSweeper.html">ChallengeSweeper</a>
  
    <li><a href="./ChallengesController.html">ChallengesController</a>
  
    <li><a href="./Chapter.html">Chapter</a>
  
    <li><a href="./ChapterSweeper.html">ChapterSweeper</a>
  
    <li><a href="./ChaptersController.html">ChaptersController</a>
  
    <li><a href="./ChaptersHelper.html">ChaptersHelper</a>
  
    <li><a href="./Character.html">Character</a>
  
    <li><a href="./CharacterNomination.html">CharacterNomination</a>
  
    <li><a href="./Collection.html">Collection</a>
  
    <li><a href="./CollectionItem.html">CollectionItem</a>
  
    <li><a href="./CollectionItemsController.html">CollectionItemsController</a>
  
    <li><a href="./CollectionObserver.html">CollectionObserver</a>
  
    <li><a href="./CollectionParticipant.html">CollectionParticipant</a>
  
    <li><a href="./CollectionParticipantsController.html">CollectionParticipantsController</a>
  
    <li><a href="./CollectionPreference.html">CollectionPreference</a>
  
    <li><a href="./CollectionProfile.html">CollectionProfile</a>
  
    <li><a href="./CollectionProfileController.html">CollectionProfileController</a>
  
    <li><a href="./CollectionSweeper.html">CollectionSweeper</a>
  
    <li><a href="./CollectionsController.html">CollectionsController</a>
  
    <li><a href="./CollectionsHelper.html">CollectionsHelper</a>
  
    <li><a href="./Comment.html">Comment</a>
  
    <li><a href="./CommentMailer.html">CommentMailer</a>
  
    <li><a href="./CommentObserver.html">CommentObserver</a>
  
    <li><a href="./CommentSweeper.html">CommentSweeper</a>
  
    <li><a href="./CommentsController.html">CommentsController</a>
  
    <li><a href="./CommentsHelper.html">CommentsHelper</a>
  
    <li><a href="./CommonTagging.html">CommonTagging</a>
  
    <li><a href="./CreationObserver.html">CreationObserver</a>
  
    <li><a href="./Creatorship.html">Creatorship</a>
  
    <li><a href="./DateHelper.html">DateHelper</a>
  
    <li><a href="./DevmodeController.html">DevmodeController</a>
  
    <li><a href="./DownloadsController.html">DownloadsController</a>
  
    <li><a href="./EmailVeracityValidator.html">EmailVeracityValidator</a>
  
    <li><a href="./ErrorsController.html">ErrorsController</a>
  
    <li><a href="./ExternalAuthor.html">ExternalAuthor</a>
  
    <li><a href="./ExternalAuthorName.html">ExternalAuthorName</a>
  
    <li><a href="./ExternalAuthorsController.html">ExternalAuthorsController</a>
  
    <li><a href="./ExternalAuthorsHelper.html">ExternalAuthorsHelper</a>
  
    <li><a href="./ExternalCreatorship.html">ExternalCreatorship</a>
  
    <li><a href="./ExternalWork.html">ExternalWork</a>
  
    <li><a href="./ExternalWorksController.html">ExternalWorksController</a>
  
    <li><a href="./Fandom.html">Fandom</a>
  
    <li><a href="./FandomNomination.html">FandomNomination</a>
  
    <li><a href="./FandomsController.html">FandomsController</a>
  
    <li><a href="./FeedSweeper.html">FeedSweeper</a>
  
    <li><a href="./Feedback.html">Feedback</a>
  
    <li><a href="./FeedbacksController.html">FeedbacksController</a>
  
    <li><a href="./FilterCount.html">FilterCount</a>
  
    <li><a href="./FilterTagging.html">FilterTagging</a>
  
    <li><a href="./Freeform.html">Freeform</a>
  
    <li><a href="./FreeformNomination.html">FreeformNomination</a>
  
    <li><a href="./Gift.html">Gift</a>
  
    <li><a href="./GiftExchange.html">GiftExchange</a>
  
    <li><a href="./GiftsController.html">GiftsController</a>
  
    <li><a href="./HitCounter.html">HitCounter</a>
  
    <li><a href="./HomeController.html">HomeController</a>
  
    <li><a href="./HomeHelper.html">HomeHelper</a>
  
    <li><a href="./InboxComment.html">InboxComment</a>
  
    <li><a href="./InboxController.html">InboxController</a>
  
    <li><a href="./InboxHelper.html">InboxHelper</a>
  
    <li><a href="./Invitation.html">Invitation</a>
  
    <li><a href="./InvitationsController.html">InvitationsController</a>
  
    <li><a href="./InvitationsHelper.html">InvitationsHelper</a>
  
    <li><a href="./InviteRequest.html">InviteRequest</a>
  
    <li><a href="./InviteRequestsController.html">InviteRequestsController</a>
  
    <li><a href="./KnownIssue.html">KnownIssue</a>
  
    <li><a href="./KnownIssuesController.html">KnownIssuesController</a>
  
    <li><a href="./Kudo.html">Kudo</a>
  
    <li><a href="./KudoMailer.html">KudoMailer</a>
  
    <li><a href="./KudoObserver.html">KudoObserver</a>
  
    <li><a href="./KudosController.html">KudosController</a>
  
    <li><a href="./KudosSweeper.html">KudosSweeper</a>
  
    <li><a href="./Language.html">Language</a>
  
    <li><a href="./LanguagesController.html">LanguagesController</a>
  
    <li><a href="./Locale.html">Locale</a>
  
    <li><a href="./LocalesController.html">LocalesController</a>
  
    <li><a href="./LogItem.html">LogItem</a>
  
    <li><a href="./Media.html">Media</a>
  
    <li><a href="./MediaController.html">MediaController</a>
  
    <li><a href="./MetaTagging.html">MetaTagging</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./Offer.html">Offer</a>
  
    <li><a href="./OrphansController.html">OrphansController</a>
  
    <li><a href="./OrphansHelper.html">OrphansHelper</a>
  
    <li><a href="./OwnedSetTagging.html">OwnedSetTagging</a>
  
    <li><a href="./OwnedTagSet.html">OwnedTagSet</a>
  
    <li><a href="./OwnedTagSetsController.html">OwnedTagSetsController</a>
  
    <li><a href="./PasswordsController.html">PasswordsController</a>
  
    <li><a href="./People.html">People</a>
  
    <li><a href="./PeopleController.html">PeopleController</a>
  
    <li><a href="./PotentialMatch.html">PotentialMatch</a>
  
    <li><a href="./PotentialMatchSettings.html">PotentialMatchSettings</a>
  
    <li><a href="./PotentialMatchesController.html">PotentialMatchesController</a>
  
    <li><a href="./PotentialPromptMatch.html">PotentialPromptMatch</a>
  
    <li><a href="./Preference.html">Preference</a>
  
    <li><a href="./PreferencesController.html">PreferencesController</a>
  
    <li><a href="./Profile.html">Profile</a>
  
    <li><a href="./ProfileController.html">ProfileController</a>
  
    <li><a href="./Prompt.html">Prompt</a>
  
    <li><a href="./PromptMeme.html">PromptMeme</a>
  
    <li><a href="./PromptRestriction.html">PromptRestriction</a>
  
    <li><a href="./PromptRestrictionsHelper.html">PromptRestrictionsHelper</a>
  
    <li><a href="./PromptsController.html">PromptsController</a>
  
    <li><a href="./Pseud.html">Pseud</a>
  
    <li><a href="./PseudSweeper.html">PseudSweeper</a>
  
    <li><a href="./PseudsController.html">PseudsController</a>
  
    <li><a href="./PseudsHelper.html">PseudsHelper</a>
  
    <li><a href="./Rating.html">Rating</a>
  
    <li><a href="./Reading.html">Reading</a>
  
    <li><a href="./ReadingsController.html">ReadingsController</a>
  
    <li><a href="./RedirectController.html">RedirectController</a>
  
    <li><a href="./RedisMailQueue.html">RedisMailQueue</a>
  
    <li><a href="./RelatedWork.html">RelatedWork</a>
  
    <li><a href="./RelatedWorksController.html">RelatedWorksController</a>
  
    <li><a href="./Relationship.html">Relationship</a>
  
    <li><a href="./RelationshipNomination.html">RelationshipNomination</a>
  
    <li><a href="./Request.html">Request</a>
  
    <li><a href="./Role.html">Role</a>
  
    <li><a href="./RolesUser.html">RolesUser</a>
  
    <li><a href="./SearchController.html">SearchController</a>
  
    <li><a href="./SearchHelper.html">SearchHelper</a>
  
    <li><a href="./SerialWork.html">SerialWork</a>
  
    <li><a href="./SerialWorksController.html">SerialWorksController</a>
  
    <li><a href="./Series.html">Series</a>
  
    <li><a href="./SeriesController.html">SeriesController</a>
  
    <li><a href="./SeriesHelper.html">SeriesHelper</a>
  
    <li><a href="./SetTagging.html">SetTagging</a>
  
    <li><a href="./Skin.html">Skin</a>
  
    <li><a href="./SkinParent.html">SkinParent</a>
  
    <li><a href="./SkinsController.html">SkinsController</a>
  
    <li><a href="./SkinsHelper.html">SkinsHelper</a>
  
    <li><a href="./StatCounter.html">StatCounter</a>
  
    <li><a href="./StaticSweeper.html">StaticSweeper</a>
  
    <li><a href="./StatsController.html">StatsController</a>
  
    <li><a href="./StatsHelper.html">StatsHelper</a>
  
    <li><a href="./Subscription.html">Subscription</a>
  
    <li><a href="./SubscriptionsController.html">SubscriptionsController</a>
  
    <li><a href="./Tag.html">Tag</a>
  
    <li><a href="./TagNomination.html">TagNomination</a>
  
    <li><a href="./TagNominationsController.html">TagNominationsController</a>
  
    <li><a href="./TagSet.html">TagSet</a>
  
    <li><a href="./TagSetAssociation.html">TagSetAssociation</a>
  
    <li><a href="./TagSetAssociationsController.html">TagSetAssociationsController</a>
  
    <li><a href="./TagSetNomination.html">TagSetNomination</a>
  
    <li><a href="./TagSetNominationsController.html">TagSetNominationsController</a>
  
    <li><a href="./TagSetOwnership.html">TagSetOwnership</a>
  
    <li><a href="./TagSetSweeper.html">TagSetSweeper</a>
  
    <li><a href="./TagSetsHelper.html">TagSetsHelper</a>
  
    <li><a href="./TagSweeper.html">TagSweeper</a>
  
    <li><a href="./TagWranglersController.html">TagWranglersController</a>
  
    <li><a href="./TagWranglingsController.html">TagWranglingsController</a>
  
    <li><a href="./Tagging.html">Tagging</a>
  
    <li><a href="./TagsController.html">TagsController</a>
  
    <li><a href="./TagsHelper.html">TagsHelper</a>
  
    <li><a href="./TranslationHelper.html">TranslationHelper</a>
  
    <li><a href="./TranslationNote.html">TranslationNote</a>
  
    <li><a href="./TranslationNotesController.html">TranslationNotesController</a>
  
    <li><a href="./TranslationsController.html">TranslationsController</a>
  
    <li><a href="./TranslatorsController.html">TranslatorsController</a>
  
    <li><a href="./UnsortedTag.html">UnsortedTag</a>
  
    <li><a href="./UnsortedTagsController.html">UnsortedTagsController</a>
  
    <li><a href="./UrlActiveValidator.html">UrlActiveValidator</a>
  
    <li><a href="./UrlFormatValidator.html">UrlFormatValidator</a>
  
    <li><a href="./User.html">User</a>
  
    <li><a href="./UserInviteRequest.html">UserInviteRequest</a>
  
    <li><a href="./UserInviteRequestsController.html">UserInviteRequestsController</a>
  
    <li><a href="./UserInviteRequestsHelper.html">UserInviteRequestsHelper</a>
  
    <li><a href="./UserMailer.html">UserMailer</a>
  
    <li><a href="./UserSession.html">UserSession</a>
  
    <li><a href="./UserSessionsController.html">UserSessionsController</a>
  
    <li><a href="./UsersController.html">UsersController</a>
  
    <li><a href="./UsersHelper.html">UsersHelper</a>
  
    <li><a href="./ValidationHelper.html">ValidationHelper</a>
  
    <li><a href="./Warning.html">Warning</a>
  
    <li><a href="./WeightedRandom.html">WeightedRandom</a>
  
    <li><a href="./Work.html">Work</a>
  
    <li><a href="./WorkLink.html">WorkLink</a>
  
    <li><a href="./WorkLinksController.html">WorkLinksController</a>
  
    <li><a href="./WorkObserver.html">WorkObserver</a>
  
    <li><a href="./WorkSkin.html">WorkSkin</a>
  
    <li><a href="./WorkSweeper.html">WorkSweeper</a>
  
    <li><a href="./WorksController.html">WorksController</a>
  
    <li><a href="./WorksHelper.html">WorksHelper</a>
  
    <li><a href="./WranglingAssignment.html">WranglingAssignment</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class WorksController</h1>

  <div id="description" class="description">
    
  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-confirm_delete" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">confirm_delete</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="confirm_delete-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 478</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">confirm_delete</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- confirm_delete-source -->
          
        </div>

        

        
      </div><!-- confirm_delete-method -->

    
      <div id="method-i-confirm_delete_multiple" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">confirm_delete_multiple</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="confirm_delete_multiple-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 683</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">confirm_delete_multiple</span>
  <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;distinct works.*&quot;</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.id = ?&quot;</span>, <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work_ids</span>])
<span class="ruby-keyword">end</span></pre>
          </div><!-- confirm_delete_multiple-source -->
          
        </div>

        

        
      </div><!-- confirm_delete_multiple-method -->

    
      <div id="method-i-create" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>POST /works</p>
          

          
          <div class="method-source-code" id="create-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 244</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">create</span>
  <span class="ruby-identifier">load_pseuds</span>
  <span class="ruby-ivar">@series</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">uniq</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:edit_button</span>]
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_button</span>]
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;New work posting canceled.&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">current_user</span>
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># now also treating the cancel_coauthor_button case, bc it should function like a preview, really</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:preview_button</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_coauthor_button</span>]
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">posted</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">valid</span> = (<span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_pseuds</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">ambiguous_pseuds</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">valid</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_revised_at</span>(<span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">published_at</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_challenge_info</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-comment">#hack for empty chapter authors in cucumber series tests</span>
      <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">pseuds</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:preview_button</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_coauthor_button</span>]
        <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">preview_work_path</span>(<span class="ruby-ivar">@work</span>), <span class="ruby-value">:notice</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">'Draft was successfully created.'</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">work_path</span>(<span class="ruby-ivar">@work</span>), <span class="ruby-value">:notice</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">'Work was successfully posted.'</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_pseuds</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">ambiguous_pseuds</span>.<span class="ruby-identifier">blank?</span>)
        <span class="ruby-identifier">render</span> <span class="ruby-value">:_choose_coauthor</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span>
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">blank?</span>
            <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Please add all required tags. Fandom is missing.&quot;</span>)
          <span class="ruby-keyword">else</span>
            <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Required tags are missing.&quot;</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">render</span> <span class="ruby-value">:new</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- create-source -->
          
        </div>

        

        
      </div><!-- create-method -->

    
      <div id="method-i-delete_multiple" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">delete_multiple</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="delete_multiple-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 688</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">delete_multiple</span>
  <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.id = ?&quot;</span>, <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work_ids</span>]).<span class="ruby-identifier">readonly</span>(<span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">titles</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:title</span>)
  <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-node">&quot;!&amp;!&amp;!&amp;!&amp;&amp;! GOT HERE #{titles}&quot;</span>
  <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">work</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">work</span>.<span class="ruby-identifier">destroy</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Your works %{titles} were deleted.&quot;</span>, <span class="ruby-value">:titles</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">titles</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>))
  <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">show_multiple_user_works_path</span>(<span class="ruby-ivar">@user</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- delete_multiple-source -->
          
        </div>

        

        
      </div><!-- delete_multiple-method -->

    
      <div id="method-i-destroy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">destroy</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>DELETE /works/1</p>
          

          
          <div class="method-source-code" id="destroy-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 482</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">destroy</span>
  <span class="ruby-ivar">@work</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">was_draft</span> = <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted?</span>
    <span class="ruby-identifier">title</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">title</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">destroy</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Your work %{title} was deleted.&quot;</span>, <span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">title</span>)
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;We couldn't delete that right now, sorry! Please try again later.&quot;</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">was_draft</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">drafts_user_works_path</span>(<span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">user_works_path</span>(<span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- destroy-source -->
          
        </div>

        

        
      </div><!-- destroy-method -->

    
      <div id="method-i-drafts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">drafts</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="drafts-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">drafts</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>]
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Whose drafts did you want to look at?&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:users</span>, <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:index</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>])
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">current_user</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@user</span>
      <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You can only see your own drafts, sorry!&quot;</span>)
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">current_user</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud_id</span>]
        <span class="ruby-ivar">@author</span> = <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud_id</span>])
        <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@author</span>.<span class="ruby-identifier">unposted_works</span>.<span class="ruby-identifier">paginate</span>(<span class="ruby-value">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">unposted_works</span>.<span class="ruby-identifier">paginate</span>(<span class="ruby-value">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>])
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- drafts-source -->
          
        </div>

        

        
      </div><!-- drafts-method -->

    
      <div id="method-i-edit" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">edit</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>GET /works/1/edit</p>
          

          
          <div class="method-source-code" id="edit-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 286</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">edit</span>
  <span class="ruby-ivar">@hide_dashboard</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-ivar">@chapters</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">chapters_in_order</span>(<span class="ruby-keyword">false</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">number_of_chapters</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">load_pseuds</span>
  <span class="ruby-ivar">@series</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">uniq</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-string">&quot;remove&quot;</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;me&quot;</span>
    <span class="ruby-identifier">pseuds_with_author_removed</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">pseuds</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">pseuds_with_author_removed</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-value">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'orphans'</span>, <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'new'</span>, <span class="ruby-value">:work_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">remove_author</span>(<span class="ruby-identifier">current_user</span>)
      <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You have been removed as an author from the work&quot;</span>)
      <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">current_user</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- edit-source -->
          
        </div>

        

        
      </div><!-- edit-method -->

    
      <div id="method-i-edit_multiple" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">edit_multiple</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="edit_multiple-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 672</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">edit_multiple</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;Orphan&quot;</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">new_orphan_path</span>(<span class="ruby-value">:work_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work_ids</span>]) <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;distinct works.*&quot;</span>).<span class="ruby-identifier">joins</span>(<span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.id = ?&quot;</span>, <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work_ids</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;Delete&quot;</span>
    <span class="ruby-identifier">render</span> <span class="ruby-string">&quot;confirm_delete_multiple&quot;</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- edit_multiple-source -->
          
        </div>

        

        
      </div><!-- edit_multiple-method -->

    
      <div id="method-i-edit_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">edit_tags</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>GET /works/1/edit_tags</p>
          

          
          <div class="method-source-code" id="edit_tags-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 304</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">edit_tags</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- edit_tags-source -->
          
        </div>

        

        
      </div><!-- edit_tags-method -->

    
      <div id="method-i-import" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">import</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>POST /works/import</p>
          

          
          <div class="method-source-code" id="import-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 500</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">import</span>
  <span class="ruby-comment"># check to make sure we have some urls to work with</span>
  <span class="ruby-ivar">@urls</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:urls</span>].<span class="ruby-identifier">split</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@urls</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Did you want to enter a URL?&quot;</span>)
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># is this an archivist importing?</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:importing_for_others</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">archivist</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You may not import stories by other users unless you are an approved archivist.&quot;</span>)
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># make sure we're not importing too many at once</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:import_multiple</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;works&quot;</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">archivist</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@urls</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">IMPORT_MAX_WORKS</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@urls</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">IMPORT_MAX_WORKS_BY_ARCHIVIST</span>)
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You cannot import more than %{max} works at a time.&quot;</span>, <span class="ruby-value">:max</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">archivist</span> <span class="ruby-operator">?</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">IMPORT_MAX_WORKS_BY_ARCHIVIST</span> <span class="ruby-operator">:</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">IMPORT_MAX_WORKS</span>)
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:import_multiple</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;chapters&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@urls</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">IMPORT_MAX_CHAPTERS</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You cannot import more than %{max} chapters at a time.&quot;</span>, <span class="ruby-value">:max</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">ArchiveConfig</span>.<span class="ruby-constant">IMPORT_MAX_CHAPTERS</span>)
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># otherwise let's build the options</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseuds_to_apply</span>]
    <span class="ruby-identifier">pseuds_to_apply</span> = <span class="ruby-constant">Pseud</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:pseuds_to_apply</span>])
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">options</span> = {<span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">pseuds_to_apply</span>,
    <span class="ruby-value">:post_without_preview</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:post_without_preview</span>],
    <span class="ruby-value">:importing_for_others</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:importing_for_others</span>],
    <span class="ruby-value">:restricted</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:restricted</span>],
    <span class="ruby-value">:override_tags</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:override_tags</span>],
    <span class="ruby-value">:fandom</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:fandom_string</span>],
    <span class="ruby-value">:warning</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:warning_strings</span>],
    <span class="ruby-value">:character</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:character_string</span>],
    <span class="ruby-value">:rating</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:rating_string</span>],
    <span class="ruby-value">:relationship</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:relationship_string</span>],
    <span class="ruby-value">:category</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:category_string</span>],
    <span class="ruby-value">:freeform</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:freeform_string</span>],
    <span class="ruby-value">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:encoding</span>]
  }

  <span class="ruby-comment"># now let's do the import</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:import_multiple</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;works&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@urls</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">import_multiple</span>(<span class="ruby-ivar">@urls</span>, <span class="ruby-identifier">options</span>)
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># a single work possibly with multiple chapters</span>
    <span class="ruby-identifier">import_single</span>(<span class="ruby-ivar">@urls</span>, <span class="ruby-identifier">options</span>)
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div><!-- import-source -->
          
        </div>

        

        
      </div><!-- import-method -->

    
      <div id="method-i-index" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">index</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>GET /works</p>
          

          
          <div class="method-source-code" id="index-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 39</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">index</span>
    <span class="ruby-ivar">@sort_column</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_column</span>]
      <span class="ruby-keyword">when</span> <span class="ruby-string">'author'</span>
        <span class="ruby-string">'authors_to_sort_on'</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">'title'</span>
        <span class="ruby-string">'title_to_sort_on'</span> 
      <span class="ruby-keyword">when</span> <span class="ruby-string">'word_count'</span>
        <span class="ruby-string">'word_count'</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">'hit_count'</span>
        <span class="ruby-string">'hit_count'</span>
      <span class="ruby-keyword">when</span> <span class="ruby-string">'created_at'</span>
        <span class="ruby-string">'created_at'</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-string">'revised_at'</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-ivar">@sort_direction</span> = (<span class="ruby-identifier">valid_sort_direction</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_direction</span>]) <span class="ruby-operator">?</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_direction</span>] <span class="ruby-operator">:</span> <span class="ruby-string">'DESC'</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_direction</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">valid_sort_direction</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_direction</span>])
      <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_direction</span>] = <span class="ruby-string">'DESC'</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># numerical ids for now</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:selected_pseuds</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-ivar">@selected_pseuds</span> = <span class="ruby-constant">Pseud</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:selected_pseuds</span>]).<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:id</span>).<span class="ruby-identifier">uniq</span>
      <span class="ruby-keyword">rescue</span>
        <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Sorry, we couldn't find one or more of the authors you selected. Please try again.&quot;</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># if we're browsing by a particular tag, just add that</span>
    <span class="ruby-comment"># tag to the selected_tags list.</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:tag_id</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-ivar">@tag</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:tag_id</span>])
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@tag</span>
        <span class="ruby-ivar">@page_subtitle</span> = <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">name</span>
        <span class="ruby-ivar">@tag</span> = <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">merger</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">merger</span>
        <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">url_for</span>({<span class="ruby-value">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:tags</span>, <span class="ruby-value">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:show</span>, <span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@tag</span>}) <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">canonical</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Sorry, there's no tag by that name in our system.&quot;</span>)
        <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">works_path</span>
        <span class="ruby-keyword">return</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:fandom_id</span>].<span class="ruby-identifier">present?</span>
      <span class="ruby-ivar">@fandom</span> = <span class="ruby-constant">Fandom</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:fandom_id</span>])
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@collection</span>
      <span class="ruby-ivar">@page_subtitle</span> = <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">title</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># if we're browsing by a particular user get works by that user</span>
    <span class="ruby-ivar">@selected_pseuds</span> = []
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>].<span class="ruby-identifier">blank?</span>
      <span class="ruby-ivar">@user</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_login</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:user_id</span>])
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@user</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud_id</span>].<span class="ruby-identifier">blank?</span>
          <span class="ruby-ivar">@author</span> = <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud_id</span>])
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@author</span>
            <span class="ruby-ivar">@selected_pseuds</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@author</span>.<span class="ruby-identifier">id</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@selected_pseuds</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@author</span>.<span class="ruby-identifier">id</span>)
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-ivar">@page_subtitle</span> = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;by %{name}&quot;</span>, <span class="ruby-value">:name</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@author</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@author</span>.<span class="ruby-identifier">byline</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">login</span>))
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Sorry, there's no user by that name in our system.&quot;</span>)
        <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">works_path</span>
        <span class="ruby-keyword">return</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@language</span> = <span class="ruby-constant">Language</span>.<span class="ruby-identifier">find_by_short</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:language_id</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:language_id</span>]
    
    <span class="ruby-comment"># Now let's build the query</span>
    <span class="ruby-identifier">options</span> = {
      <span class="ruby-value">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user</span>, 
      <span class="ruby-value">:author</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@author</span>, 
      <span class="ruby-value">:selected_pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@selected_pseuds</span>,
      <span class="ruby-value">:tag</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@tag</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@fandom</span>, 
      <span class="ruby-value">:collection</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@collection</span>,
      <span class="ruby-value">:language_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@language</span>,
      <span class="ruby-value">:sort_column</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@sort_column</span>, 
      <span class="ruby-value">:sort_direction</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@sort_direction</span>,
      <span class="ruby-value">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>], 
      <span class="ruby-value">:per_page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:per_page</span>],
      <span class="ruby-value">:complete</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:complete</span>]
    }
    <span class="ruby-comment"># Add caching for tag pages</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">present?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:sort_column</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:language_id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:complete</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">6</span>)
      <span class="ruby-identifier">status</span> = <span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;u&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;v&quot;</span>
      <span class="ruby-identifier">page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1</span>
      <span class="ruby-comment"># This has views/ in it because that's what expire_fragment is looking for</span>
      <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">cache</span>.<span class="ruby-identifier">fetch</span> <span class="ruby-node">&quot;views/works/t/#{@tag.id}/#{status}/p/#{page}&quot;</span> <span class="ruby-keyword">do</span>
        <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find_with_options</span>(<span class="ruby-identifier">options</span>).<span class="ruby-identifier">compact</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find_with_options</span>(<span class="ruby-identifier">options</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># we now have @works found</span>
    <span class="ruby-comment"># only need to check this if the filters expose info about the works</span>
<span class="ruby-comment">#    @over_anon_threshold = @works.collect(&amp;:authors_to_sort_on).uniq.count &gt; ArchiveConfig.ANONYMOUS_THRESHOLD_COUNT</span>
    <span class="ruby-ivar">@over_anon_threshold</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span></pre>
          </div><!-- index-source -->
          
        </div>

        

        
      </div><!-- index-method -->

    
      <div id="method-i-marktoread" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">marktoread</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>marks a work to read later, or unmarks it if the work is already marked</p>
          

          
          <div class="method-source-code" id="marktoread-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 722</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">marktoread</span>
  <span class="ruby-ivar">@work</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-constant">Reading</span>.<span class="ruby-identifier">mark_to_read_later</span>(<span class="ruby-ivar">@work</span>, <span class="ruby-identifier">current_user</span>)
  <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Your history was updated. It may take a short while to show up.&quot;</span>)
  <span class="ruby-identifier">redirect_to</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">env</span>[<span class="ruby-string">&quot;HTTP_REFERER&quot;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">root_path</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- marktoread-source -->
          
        </div>

        

        
      </div><!-- marktoread-method -->

    
      <div id="method-i-navigate" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">navigate</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="navigate-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 208</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">navigate</span>
  <span class="ruby-ivar">@chapters</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">chapters_in_order</span>(<span class="ruby-keyword">false</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- navigate-source -->
          
        </div>

        

        
      </div><!-- navigate-method -->

    
      <div id="method-i-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>GET /works/new</p>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 213</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@hide_dashboard</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">load_pseuds</span>
  <span class="ruby-ivar">@series</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">uniq</span>
  <span class="ruby-ivar">@unposted</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">unposted_work</span>
  <span class="ruby-comment"># for clarity, add the collection and recipient</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:assignment_id</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@challenge_assignment</span> = <span class="ruby-constant">ChallengeAssignment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:assignment_id</span>])) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@challenge_assignment</span>.<span class="ruby-identifier">offering_user</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">challenge_assignments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@challenge_assignment</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">collections</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@challenge_assignment</span>.<span class="ruby-identifier">collection</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">recipients</span> = <span class="ruby-ivar">@challenge_assignment</span>.<span class="ruby-identifier">requesting_pseud</span>.<span class="ruby-identifier">byline</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">collection_names</span> = <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@collection</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:claim_id</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@challenge_claim</span> = <span class="ruby-constant">ChallengeClaim</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:claim_id</span>])) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@challenge_claim</span>.<span class="ruby-identifier">claiming_user_id</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">current_user</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">challenge_claims</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@challenge_claim</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">collections</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@challenge_claim</span>.<span class="ruby-identifier">collection</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">collection_names</span> = <span class="ruby-ivar">@collection</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@collection</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:import</span>]
    <span class="ruby-ivar">@page_subtitle</span> = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;import&quot;</span>)
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:load_unposted</span>]
    <span class="ruby-ivar">@work</span> = <span class="ruby-ivar">@unposted</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:edit</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
      <div id="method-i-post_draft" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">post_draft</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="post_draft-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 630</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">post_draft</span>
  <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-ivar">@work</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">is_author_of?</span>(<span class="ruby-ivar">@work</span>)
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You can only post your own works.&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">current_user</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;That work is already posted. Do you want to edit it instead?&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_user_work_path</span>(<span class="ruby-ivar">@user</span>, <span class="ruby-ivar">@work</span>) <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">minor_version</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">minor_version</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
  <span class="ruby-comment"># @work.update_minor_version</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;There were problems posting your work.&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_user_work_path</span>(<span class="ruby-ivar">@user</span>, <span class="ruby-ivar">@work</span>) <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Your work was successfully posted.&quot;</span>)
  <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@work</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- post_draft-source -->
          
        </div>

        

        
      </div><!-- post_draft-method -->

    
      <div id="method-i-preview" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preview</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>GET /works/1/preview</p>
          

          
          <div class="method-source-code" id="preview-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 469</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">preview</span>
  <span class="ruby-ivar">@preview_mode</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">load_pseuds</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- preview-source -->
          
        </div>

        

        
      </div><!-- preview-method -->

    
      <div id="method-i-preview_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">preview_tags</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="preview_tags-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 474</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">preview_tags</span>
  <span class="ruby-ivar">@preview_mode</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- preview_tags-source -->
          
        </div>

        

        
      </div><!-- preview_tags-method -->

    
      <div id="method-i-search" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">search</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="search-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 22</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">search</span>
  <span class="ruby-ivar">@languages</span> = <span class="ruby-constant">Language</span>.<span class="ruby-identifier">default_order</span>
  <span class="ruby-ivar">@query</span> = {}
  <span class="ruby-comment"># to understand this, the code you are looking for is in lib/query.rb</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:query</span>]
    <span class="ruby-ivar">@query</span> = <span class="ruby-constant">Query</span>.<span class="ruby-identifier">standardize</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:query</span>])
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:page</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">errors</span>, <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Query</span>.<span class="ruby-identifier">search_with_sphinx</span>(<span class="ruby-constant">Work</span>, <span class="ruby-ivar">@query</span>, <span class="ruby-identifier">page</span>)
      <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot; &quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Riddle</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionError</span>
      <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;The search engine seems to be down at the moment, sorry!&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- search-source -->
          
        </div>

        

        
      </div><!-- search-method -->

    
      <div id="method-i-show" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">show</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>GET /works/1 GET /works/1.xml</p>
          

          
          <div class="method-source-code" id="show-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 164</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">show</span>
  <span class="ruby-comment"># Users must explicitly okay viewing of adult content</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:view_adult</span>]
    <span class="ruby-identifier">session</span>[<span class="ruby-value">:adult</span>] = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">adult?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">see_adult?</span>
    <span class="ruby-identifier">render</span> <span class="ruby-string">&quot;_adult&quot;</span>, <span class="ruby-value">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;application&quot;</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Users must explicitly okay viewing of entire work</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">number_of_posted_chapters</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:view_full_work</span>] <span class="ruby-operator">||</span> (<span class="ruby-identifier">logged_in?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">preference</span>.<span class="ruby-identifier">try</span>(<span class="ruby-value">:view_full_works</span>))
      <span class="ruby-ivar">@chapters</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">chapters_in_order</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">keep</span>
      <span class="ruby-identifier">redirect_to</span> [<span class="ruby-ivar">@work</span>, <span class="ruby-ivar">@chapter</span>] <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@tag_categories_limited</span> = <span class="ruby-constant">Tag</span><span class="ruby-operator">::</span><span class="ruby-constant">VISIBLE</span> <span class="ruby-operator">-</span> [<span class="ruby-string">&quot;Warning&quot;</span>]
  <span class="ruby-ivar">@kudos</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">kudos</span>.<span class="ruby-identifier">with_pseud</span>.<span class="ruby-identifier">includes</span>(<span class="ruby-value">:pseud</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span>).<span class="ruby-identifier">order</span>(<span class="ruby-string">&quot;created_at DESC&quot;</span>)
  
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:subscriptions</span>)
    <span class="ruby-ivar">@subscription</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">subscriptions</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:subscribable_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">id</span>,
                                                     <span class="ruby-value">:subscribable_type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'Work'</span>).<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span>
                    <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">subscriptions</span>.<span class="ruby-identifier">build</span>(<span class="ruby-value">:subscribable</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@work</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@page_title</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">unrevealed?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Mystery Work&quot;</span>) <span class="ruby-operator">:</span>
    <span class="ruby-identifier">get_page_title</span>(<span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">3</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Multifandom&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">string</span>,
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">anonymous?</span> <span class="ruby-operator">?</span>  <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Anonymous&quot;</span>)  <span class="ruby-operator">:</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:byline</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">', '</span>),
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">title</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">unrevealed?</span>
      <span class="ruby-ivar">@tweet_text</span> = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Mystery Work&quot;</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@tweet_text</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">title</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; by &quot;</span> <span class="ruby-operator">+</span>
                    (<span class="ruby-ivar">@work</span>.<span class="ruby-identifier">anonymous?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Anonymous&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">', '</span>)) <span class="ruby-operator">+</span> <span class="ruby-string">&quot; - &quot;</span> <span class="ruby-operator">+</span>
                    (<span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Multifandom&quot;</span>) <span class="ruby-operator">:</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">string</span>)
      <span class="ruby-ivar">@tweet_text</span> = <span class="ruby-ivar">@tweet_text</span>.<span class="ruby-identifier">truncate</span>(<span class="ruby-value">95</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">render</span> <span class="ruby-value">:show</span>
  <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">increment_hit_count</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">remote_ip</span>)
  <span class="ruby-constant">Reading</span>.<span class="ruby-identifier">update_or_create</span>(<span class="ruby-ivar">@work</span>, <span class="ruby-identifier">current_user</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">current_user</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- show-source -->
          
        </div>

        

        
      </div><!-- show-method -->

    
      <div id="method-i-show_multiple" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">show_multiple</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>WORK ON MULTIPLE WORKS</p>
          

          
          <div class="method-source-code" id="show_multiple-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 657</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">show_multiple</span>
  <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud_id</span>]
    <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:pseuds</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:pseud_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud_id</span>])
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.id = ?&quot;</span>, <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work_ids</span>]
    <span class="ruby-ivar">@works</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">where</span>(<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work_ids</span>])
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@works_by_fandom</span> = <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:taggings</span>).
    <span class="ruby-identifier">joins</span>(<span class="ruby-string">&quot;inner join tags on taggings.tagger_id = tags.id AND tags.type = 'Fandom'&quot;</span>).
    <span class="ruby-identifier">select</span>(<span class="ruby-string">&quot;distinct tags.name as fandom, works.id as id, works.title as title&quot;</span>).<span class="ruby-identifier">group_by</span>(&amp;<span class="ruby-value">:fandom</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- show_multiple-source -->
          
        </div>

        

        
      </div><!-- show_multiple-method -->

    
      <div id="method-i-update" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>PUT /works/1</p>
          

          
          <div class="method-source-code" id="update-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 308</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update</span>
  <span class="ruby-comment"># Need to get @pseuds and @series values before rendering edit</span>
  <span class="ruby-identifier">load_pseuds</span>
  <span class="ruby-ivar">@series</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">uniq</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:edit</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_pseuds</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">ambiguous_pseuds</span>.<span class="ruby-identifier">blank?</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-operator">?</span> (<span class="ruby-identifier">render</span> <span class="ruby-value">:_choose_coauthor</span>) <span class="ruby-operator">:</span> (<span class="ruby-identifier">render</span> <span class="ruby-value">:new</span>)
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:preview_button</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_coauthor_button</span>]
    <span class="ruby-ivar">@preview_mode</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_tags</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-ivar">@chapter</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@chapter</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:preview</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_tags</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">check_for_invalid_tags</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Please add all required tags. Fandom is missing.&quot;</span>)
      <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Please add all required tags.&quot;</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:edit</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_button</span>]
    <span class="ruby-identifier">cancel_posting_and_redirect</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:edit_button</span>]
    <span class="ruby-identifier">render</span> <span class="ruby-value">:edit</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">saved</span> = <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">saved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved</span>
      <span class="ruby-comment"># Setting the @work.revised_at datetime if appropriate</span>
      <span class="ruby-comment"># if @chapter.published_at has been changed or work is being posted</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:post_button</span>] <span class="ruby-operator">||</span> (<span class="ruby-keyword">defined?</span>(<span class="ruby-ivar">@previous_published_at</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@previous_published_at</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">published_at</span>)
        <span class="ruby-comment"># if work has only one chapter - so we don't need to take any other chapter dates into account,</span>
        <span class="ruby-comment"># OR the date is set to today AND the backdating setting has not been changed</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">number_of_chapters</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">||</span> (<span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">published_at</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-ivar">@previous_backdate_setting</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@previous_backdate_setting</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">backdate</span>)
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_revised_at</span>(<span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">published_at</span>)
        <span class="ruby-comment"># work has more than one chapter and the published_at date for this chapter is not today</span>
        <span class="ruby-comment"># so we can't tell if there is a later date than this one elsewhere, and need to grab all</span>
        <span class="ruby-comment"># OR the date is today but the backdate setting has changed</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-comment"># if backdate has been changed to positive</span>
          <span class="ruby-keyword">if</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-ivar">@previous_backdate_setting</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@previous_backdate_setting</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">backdate</span>
            <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_revised_at</span>(<span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">published_at</span>) <span class="ruby-comment"># set revised_at to the date on this form</span>
          <span class="ruby-comment"># if backdate has been changed to negative</span>
          <span class="ruby-comment"># OR there is no change in the backdate setting but the date isn't today</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_revised_at</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-comment"># elsif the date hasn't been changed, but the backdate setting has</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-ivar">@previous_backdate_setting</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@previous_backdate_setting</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">backdate</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@previous_backdate_setting</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">backdate</span>  <span class="ruby-comment"># if backdate has been changed to positive</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_revised_at</span>(<span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">published_at</span>) <span class="ruby-comment"># set revised_at to the date on this form</span>
        <span class="ruby-keyword">else</span> <span class="ruby-comment"># if backdate has been changed to negative, grab most recent chapter date</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_revised_at</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">challenge_claims</span>.<span class="ruby-identifier">empty?</span>
        <span class="ruby-ivar">@included</span> = <span class="ruby-value">0</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">challenge_claims</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">claim</span><span class="ruby-operator">|</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">collections</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">collection</span><span class="ruby-operator">|</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">collection</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">collection</span>
              <span class="ruby-ivar">@included</span> = <span class="ruby-value">1</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@included</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
            <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">collections</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">claim</span>.<span class="ruby-identifier">collection</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-ivar">@included</span> = <span class="ruby-value">0</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:post_button</span>]
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">minor_version</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">minor_version</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">set_challenge_info</span>
      <span class="ruby-identifier">saved</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:post_button</span>]
        <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">'Work was successfully posted.'</span>)
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:update_button</span>]
        <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">'Work was successfully updated.'</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">redirect_to</span>(<span class="ruby-ivar">@work</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">valid?</span>
        <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">err</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-identifier">err</span>)}
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">blank?</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Please add all required tags. Fandom is missing.&quot;</span>)
        <span class="ruby-keyword">else</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Required tags are missing.&quot;</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:edit</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update-source -->
          
        </div>

        

        
      </div><!-- update-method -->

    
      <div id="method-i-update_multiple" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_multiple</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="update_multiple-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 700</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_multiple</span>
  <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">current_user</span>
  <span class="ruby-ivar">@works</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">joins</span>(<span class="ruby-value">:pseuds</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:user</span>).<span class="ruby-identifier">where</span>(<span class="ruby-string">&quot;users.id = ?&quot;</span>, <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">where</span>(<span class="ruby-value">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work_ids</span>]).<span class="ruby-identifier">readonly</span>(<span class="ruby-keyword">false</span>)
  <span class="ruby-ivar">@errors</span> = []
  <span class="ruby-comment"># to avoid overwriting, we entirely trash any blank fields and also any unchecked checkboxes</span>
  <span class="ruby-identifier">work_params</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>].<span class="ruby-identifier">reject</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">key</span>,<span class="ruby-identifier">value</span><span class="ruby-operator">|</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;0&quot;</span>}
  <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">work</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># now we can just update each work independently, woo!</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">work</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">work_params</span>)
      <span class="ruby-ivar">@errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;The work %{title} could not be edited: %{error}&quot;</span>, <span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">work</span>.<span class="ruby-identifier">title</span>, <span class="ruby-value">:error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">work</span>.<span class="ruby-identifier">errors_on</span>.<span class="ruby-identifier">to_s</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@errors</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;There were problems editing some works: %{errors}&quot;</span>, <span class="ruby-value">:errors</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@errors</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>))
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">edit_multiple_user_works_path</span>(<span class="ruby-ivar">@user</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Your edits were put through! Please check over the works to make sure everything is right.&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">show_multiple_user_works_path</span>(<span class="ruby-ivar">@user</span>, <span class="ruby-value">:work_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:id</span>))
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_multiple-source -->
          
        </div>

        

        
      </div><!-- update_multiple-method -->

    
      <div id="method-i-update_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_tags</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="update_tags-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 413</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_tags</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:edit_tags</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:preview_button</span>]
    <span class="ruby-ivar">@preview_mode</span> = <span class="ruby-keyword">true</span>

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_tags</span>.<span class="ruby-identifier">blank?</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:preview_tags</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_tags</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">check_for_invalid_tags</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Please add all required tags. Fandom is missing.&quot;</span>)
      <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Please add all required tags.&quot;</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:edit_tags</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_button</span>]
    <span class="ruby-identifier">cancel_posting_and_redirect</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:edit_button</span>]
    <span class="ruby-identifier">render</span> <span class="ruby-value">:edit_tags</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">saved</span> = <span class="ruby-keyword">true</span>

    (<span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_tags</span>.<span class="ruby-identifier">blank?</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">saved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved</span>
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">minor_version</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">minor_version</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">saved</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-comment"># @work.update_minor_version</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">saved</span>
      <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">'Work was successfully updated.'</span>)
      <span class="ruby-identifier">redirect_to</span>(<span class="ruby-ivar">@work</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">invalid_tags</span>.<span class="ruby-identifier">blank?</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">check_for_invalid_tags</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">has_required_tags?</span>
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">fandoms</span>.<span class="ruby-identifier">blank?</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Please add all required tags. Fandom is missing.&quot;</span>)
        <span class="ruby-keyword">else</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">errors</span>.<span class="ruby-identifier">add</span>(<span class="ruby-value">:base</span>, <span class="ruby-string">&quot;Updating: Required tags are missing.&quot;</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">render</span> <span class="ruby-value">:edit_tags</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_tags-source -->
          
        </div>

        

        
      </div><!-- update_tags-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="protected-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Protected Instance Methods</h3>

    
      <div id="method-i-cancel_posting_and_redirect" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cancel_posting_and_redirect</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="cancel_posting_and_redirect-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 832</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cancel_posting_and_redirect</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span> <span class="ruby-keyword">and</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;The work was not updated.&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">user_works_path</span>(<span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;The work was not posted. It will be saved here in your drafts for one week, then cleaned up.&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">drafts_user_works_path</span>(<span class="ruby-identifier">current_user</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- cancel_posting_and_redirect-source -->
          
        </div>

        

        
      </div><!-- cancel_posting_and_redirect-method -->

    
      <div id="method-i-import_multiple" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">import_multiple</span><span
            class="method-args">(urls, options)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>import multiple works</p>
          

          
          <div class="method-source-code" id="import_multiple-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 590</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">import_multiple</span>(<span class="ruby-identifier">urls</span>, <span class="ruby-identifier">options</span>)
  <span class="ruby-comment"># try a multiple import</span>
  <span class="ruby-identifier">storyparser</span> = <span class="ruby-constant">StoryParser</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@works</span>, <span class="ruby-identifier">failed_urls</span>, <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">storyparser</span>.<span class="ruby-identifier">import_from_urls</span>(<span class="ruby-identifier">urls</span>, <span class="ruby-identifier">options</span>)

  <span class="ruby-comment"># collect the errors neatly, matching each error to the failed url</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">failed_urls</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">error_msgs</span> = <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-identifier">failed_urls</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">map</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;&lt;dt&gt;#{failed_urls[index]}&lt;/dt&gt;&lt;dd&gt;#{errors[index]}&lt;/dd&gt;&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-node">&quot;&lt;h3&gt;#{ts('Failed Imports')}&lt;/h3&gt;&lt;dl&gt;#{error_msgs}&lt;/dl&gt;&quot;</span>.<span class="ruby-identifier">html_safe</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># if EVERYTHING failed, boo. :( Go back to the import form.</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@works</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># if we got here, we have at least some successfully imported works</span>
  <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Importing completed successfully for the following works! (But please check the results over carefully!)&quot;</span>)
  <span class="ruby-identifier">send_external_invites</span>(<span class="ruby-ivar">@works</span>)

  <span class="ruby-comment"># fall through to import template</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- import_multiple-source -->
          
        </div>

        

        
      </div><!-- import_multiple-method -->

    
      <div id="method-i-import_single" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">import_single</span><span
            class="method-args">(urls, options)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>import a single work (possibly with multiple chapters)</p>
          

          
          <div class="method-source-code" id="import_single-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 554</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">import_single</span>(<span class="ruby-identifier">urls</span>, <span class="ruby-identifier">options</span>)
  <span class="ruby-comment"># try the import</span>
  <span class="ruby-identifier">storyparser</span> = <span class="ruby-constant">StoryParser</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">urls</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-ivar">@work</span> = <span class="ruby-identifier">storyparser</span>.<span class="ruby-identifier">download_and_parse_story</span>(<span class="ruby-identifier">urls</span>.<span class="ruby-identifier">first</span>, <span class="ruby-identifier">options</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@work</span> = <span class="ruby-identifier">storyparser</span>.<span class="ruby-identifier">download_and_parse_chapters_into_story</span>(<span class="ruby-identifier">urls</span>, <span class="ruby-identifier">options</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Timeout</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Import has timed out. This may be due to connectivity problems with the source site. Please try again in a few minutes, or check Known Issues to see if there are import problems with this site.&quot;</span>)
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">StoryParser</span><span class="ruby-operator">::</span><span class="ruby-constant">Error</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exception</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;We couldn't successfully import that work, sorry: %{message}&quot;</span>, <span class="ruby-value">:message</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exception</span>.<span class="ruby-identifier">message</span>)
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new_import</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@work</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;We were only partially able to import this work and couldn't save it. Please review below!&quot;</span>)
    <span class="ruby-ivar">@chapter</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">load_pseuds</span>
    <span class="ruby-ivar">@series</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">series</span>.<span class="ruby-identifier">uniq</span>
    <span class="ruby-identifier">render</span> <span class="ruby-value">:new</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Otherwise, we have a saved work, go us</span>
  <span class="ruby-identifier">send_external_invites</span>([<span class="ruby-ivar">@work</span>])
  <span class="ruby-ivar">@chapter</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">first_chapter</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">posted</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">work_path</span>(<span class="ruby-ivar">@work</span>) <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">preview_work_path</span>(<span class="ruby-ivar">@work</span>) <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- import_single-source -->
          
        </div>

        

        
      </div><!-- import_single-method -->

    
      <div id="method-i-load_pseuds" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_pseuds</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="load_pseuds-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 731</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_pseuds</span>
  <span class="ruby-ivar">@allpseuds</span> = (<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">+</span> (<span class="ruby-ivar">@work</span>.<span class="ruby-identifier">authors</span> <span class="ruby-operator">||=</span> []) <span class="ruby-operator">+</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">pseuds</span>).<span class="ruby-identifier">uniq</span>
  <span class="ruby-ivar">@pseuds</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">pseuds</span>
  <span class="ruby-ivar">@coauthors</span> = <span class="ruby-ivar">@allpseuds</span>.<span class="ruby-identifier">select</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">user</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>}
  <span class="ruby-identifier">to_select</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">pseuds</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">?</span> [<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">default_pseud</span>] <span class="ruby-operator">:</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">pseuds</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">authors</span>
  <span class="ruby-ivar">@selected_pseuds</span> = <span class="ruby-identifier">to_select</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">pseud</span><span class="ruby-operator">|</span> <span class="ruby-identifier">pseud</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span> }.<span class="ruby-identifier">uniq</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- load_pseuds-source -->
          
        </div>

        

        
      </div><!-- load_pseuds-method -->

    
      <div id="method-i-load_work" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">load_work</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="load_work-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 739</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">load_work</span>
  <span class="ruby-ivar">@work</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:error</span>] = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;Sorry, we couldn't find the work you were looking for.&quot;</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">root_path</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@collection</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@work</span>.<span class="ruby-identifier">collections</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@collection</span>)
    <span class="ruby-identifier">redirect_to</span> <span class="ruby-ivar">@work</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@check_ownership_of</span> = <span class="ruby-ivar">@work</span>
  <span class="ruby-ivar">@check_visibility_of</span> = <span class="ruby-ivar">@work</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- load_work-source -->
          
        </div>

        

        
      </div><!-- load_work-method -->

    
      <div id="method-i-send_external_invites" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">send_external_invites</span><span
            class="method-args">(works)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>if we are importing for others, we need to send invitations</p>
          

          
          <div class="method-source-code" id="send_external_invites-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 614</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">send_external_invites</span>(<span class="ruby-identifier">works</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:importing_for_others</span>]
    <span class="ruby-ivar">@external_authors</span> = <span class="ruby-identifier">works</span>.<span class="ruby-identifier">collect</span>(&amp;<span class="ruby-value">:external_authors</span>).<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
    <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@external_authors</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-ivar">@external_authors</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">external_author</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">external_author</span>.<span class="ruby-identifier">find_or_invite</span>(<span class="ruby-identifier">current_user</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">message</span> = <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;We have notified the author(s) you imported stories for. If any were missed, you can also add co-authors manually.&quot;</span>)
      <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] <span class="ruby-operator">+=</span> <span class="ruby-identifier">message</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">flash</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">message</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- send_external_invites-source -->
          
        </div>

        

        
      </div><!-- send_external_invites-method -->

    
      <div id="method-i-set_author_attributes" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_author_attributes</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>set the author attributes</p>
          

          
          <div class="method-source-code" id="set_author_attributes-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 788</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_author_attributes</span>
  <span class="ruby-comment"># if we don't have author_attributes[:ids], which shouldn't be allowed to happen</span>
  <span class="ruby-comment"># (this can happen if a user with multiple pseuds decides to unselect *all* of them)</span>
  <span class="ruby-identifier">sorry</span> = <span class="ruby-identifier">ts</span>(<span class="ruby-string">&quot;You haven't selected any pseuds for this work. Please use Remove Me As Author or consider orphaning your work instead if you do not wish to be associated with it anymore.&quot;</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>][<span class="ruby-value">:ids</span>]
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">sorry</span>
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>][<span class="ruby-value">:ids</span>] = [<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">default_pseud</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>]
    <span class="ruby-identifier">setflash</span>; <span class="ruby-identifier">flash</span>.<span class="ruby-identifier">now</span>[<span class="ruby-value">:notice</span>] = <span class="ruby-identifier">sorry</span>
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>] = {<span class="ruby-value">:ids</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">default_pseud</span>]}
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># stuff new bylines into author attributes to be parsed by the work model</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud</span>][<span class="ruby-value">:byline</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud</span>][<span class="ruby-value">:byline</span>] <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;&quot;</span>
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>][<span class="ruby-value">:byline</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud</span>][<span class="ruby-value">:byline</span>]
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:pseud</span>][<span class="ruby-value">:byline</span>] = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># stuff co-authors into author attributes too so we won't lose them</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>][<span class="ruby-value">:coauthors</span>]
    <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>][<span class="ruby-value">:ids</span>].<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:author_attributes</span>][<span class="ruby-value">:coauthors</span>]).<span class="ruby-identifier">uniq!</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_author_attributes-source -->
          
        </div>

        

        
      </div><!-- set_author_attributes-method -->

    
      <div id="method-i-set_instance_variables" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_instance_variables</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets values for @work, @chapter, @coauthor_results, @pseuds, and
@selected_pseuds and @<a href="http://category">tags</a></p>
          

          
          <div class="method-source-code" id="set_instance_variables-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 753</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_instance_variables</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] <span class="ruby-comment"># edit, update, preview, manage_chapters</span>
    <span class="ruby-ivar">@work</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
    <span class="ruby-ivar">@previous_published_at</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">first_chapter</span>.<span class="ruby-identifier">published_at</span>
    <span class="ruby-ivar">@previous_backdate_setting</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">backdate</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>]  <span class="ruby-comment"># editing, save our changes</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:preview_button</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_button</span>]
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">preview_mode</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">preview_mode</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>]
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">save_parents</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">preview_mode</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>] <span class="ruby-comment"># create</span>
    <span class="ruby-ivar">@work</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>])
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># new</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:load_unposted</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">unposted_work</span>
      <span class="ruby-ivar">@work</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">unposted_work</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@work</span> = <span class="ruby-constant">Work</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">chapters</span>.<span class="ruby-identifier">build</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@serial_works</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">serial_works</span>

  <span class="ruby-ivar">@chapter</span> = <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">first_chapter</span>
  <span class="ruby-comment"># If we're in preview mode, we want to pick up any changes that have been made to the first chapter</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:chapter_attributes</span>]
    <span class="ruby-ivar">@chapter</span>.<span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>][<span class="ruby-value">:chapter_attributes</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_instance_variables-source -->
          
        </div>

        

        
      </div><!-- set_instance_variables-method -->

    
      <div id="method-i-set_instance_variables_tags" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_instance_variables_tags</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets values for @work and @<a href="http://category">tags</a></p>
          

          
          <div class="method-source-code" id="set_instance_variables_tags-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 814</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">set_instance_variables_tags</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>] <span class="ruby-comment"># edit_tags, update_tags, preview_tags</span>
      <span class="ruby-ivar">@work</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Work</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value">:id</span>])
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>]  <span class="ruby-comment"># editing, save our changes</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:preview_button</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:cancel_button</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value">:edit_button</span>]
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">preview_mode</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">preview_mode</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">attributes</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value">:work</span>]
        <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">save_parents</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@work</span>.<span class="ruby-identifier">preview_mode</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- set_instance_variables_tags-source -->
          
        </div>

        

        
      </div><!-- set_instance_variables_tags-method -->

    
      <div id="method-i-tag_list" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tag_list</span><span
            class="method-args">(tags)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Takes an array of tags and returns a comma-separated list, without the
markup</p>
          

          
          <div class="method-source-code" id="tag_list-source">
            <pre><span class="ruby-comment"># File app/controllers/works_controller.rb, line 843</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tag_list</span>(<span class="ruby-identifier">tags</span>)
  <span class="ruby-identifier">tags</span> = <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">compact</span>
  <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">tags</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:collect</span>)
    <span class="ruby-identifier">last_tag</span> = <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">tag_list</span> = <span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tag</span><span class="ruby-operator">|</span>  <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;, &quot;</span>}.<span class="ruby-identifier">join</span>
    <span class="ruby-identifier">tag_list</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">last_tag</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">tag_list</span>.<span class="ruby-identifier">html_safe</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- tag_list-source -->
          
        </div>

        

        
      </div><!-- tag_list-method -->

    
    </section><!-- protected-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

