(b=>{var x,e,t,n,o={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1},R={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"},O=0,N=1,_=2;KeyboardEvent.prototype.hasOwnProperty("key")?(e=!0,x={BACKSPACE:"Backspace",TAB:"Tab",ENTER:"Enter",ESCAPE:"Escape",SPACE:" ",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",END:"End",HOME:"Home",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",DELETE:"Delete",NUMPAD_ENTER:"Enter",COMMA:","}):(x={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188},Object.defineProperty(KeyboardEvent.prototype,"key",{configurable:!0,enumerable:!0,get:function(){return this.keyCode}})),e&&(e=KeyboardEvent.prototype,t=Object.getOwnPropertyDescriptor(e,"key"),n={Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete"},Object.defineProperty(e,"key",{configurable:!0,enumerable:!0,get:function(){var e=t.get.call(this);return n.hasOwnProperty(e)?n[e]:e}})),b.fn.tokenInput=function(e,t){var n=b.extend({},o,t||{});return this.each(function(){new b.TokenList(this,e,n)})},b.TokenList=function(e,t,l){"string"==typeof t?(l.url=t,void 0===l.crossDomain&&(-1===l.url.indexOf("://")?l.crossDomain=!1:l.crossDomain=location.href.split(/\/+/g)[1]!==l.url.split(/\/+/g)[1])):"object"==typeof t&&(l.local_data=t),l.classes?l.classes=b.extend({},R,l.classes):l.theme?(l.classes={},b.each(R,function(e,t){l.classes[e]=t+"-"+l.theme})):l.classes=R;var n,a=[],i=0,r=new b.TokenList.Cache,t=b(e).attr("id"),c=(b('label[for="'+t+'"]').attr({for:t+"_autocomplete"}),b('<input type="text" class="text" autocomplete="off" role="combobox" aria-expanded="true" aria-autocomplete="list">').attr({id:t+"_autocomplete"}).focus(function(){(null===l.tokenLimit||i<l.tokenLimit)&&(b(this).val().length>=l.minChars?setTimeout(function(){L()},5):l.hintText&&(k.html("<p class='notice'>"+l.hintText+"</p>"),o()))}).blur(function(){y()}).keydown(function(e){var t,n,o;switch(e.key){case x.LEFT:case x.RIGHT:case x.UP:case x.DOWN:if(f&&!f.is(":hidden"))return e.key===x.LEFT||e.key===x.RIGHT||(o=null,(o=p?e.key===x.DOWN?b(p).next():b(p).prev():f).length?(w(o),b(k).scrollTo(b(o))):e.key===x.UP&&p&&P(b(p)),!1);d?(t=b(d).prev(),n=b(d).next(),e.key===x.LEFT||e.key===x.UP?E(b(d),O):E(b(d),N)):(t=m.prev(),n=m.next()),e.key!==x.LEFT&&e.key!==x.UP||!t.length?e.key!==x.RIGHT&&e.key!==x.DOWN||!n.length||T(b(n.get(0))):T(b(t.get(0)));break;case x.BACKSPACE:case x.DELETE:if(t=m.prev(),!b(this).val().length)return d?C(b(d)):t.length&&T(b(t.get(0))),!1;1===b(this).val().length?y():setTimeout(function(){L()},25);break;case x.COMMA:case x.TAB:case x.ENTER:case x.NUMPAD_ENTER:if(p){if(v(b(p)),P(b(p)),y(),e.keyCode===x.TAB&&l.tokenLimit&&l.tokenLimit===i)break;return!1}if(c.val()){if(b.each(c.val().split(l.tokenDelimiter),function(e,t){v(b.trim(t))}),y(),e.keyCode===x.TAB&&l.tokenLimit&&l.tokenLimit===i)break;return!1}break;case x.ESCAPE:return y(),!0;default:String.fromCharCode(e.which)&&setTimeout(function(){L()},25)}}).keyup(function(){b(this).val().length<l.minChars&&(y(),clearTimeout(n))})),u=(b(e).closest("form").submit(function(){c.val()&&b.each(c.val().split(l.tokenDelimiter),function(e,t){v(b.trim(t))})}),b(e).hide().focus(function(){c.focus()}).blur(function(){c.blur()})),d=null,s=0,p=null,f=null,h=b("<ul />").addClass(l.classes.tokenList).click(function(e){e=b(e.target).closest("li");if(e&&e.get(0)&&b.data(e.get(0),"tokeninput")){var t=d;if(d){if(d===e.get(0))return void(e=>{y();var t=b.data(e.get(0),"tokeninput");C(e),c.val(t.id)})(e);E(b(d),_)}t===e.get(0)?E(e,_):T(e)}else d&&E(b(d),_),c.focus()}).mouseover(function(e){e=b(e.target).closest("li");e&&d!==this&&e.addClass(l.classes.highlightedToken)}).mouseout(function(e){e=b(e.target).closest("li");e&&d!==this&&e.removeClass(l.classes.highlightedToken)}).insertBefore(u),m=(l.makeSortable&&h.addClass(l.classes.sortable),b("<li />").addClass(l.classes.inputToken).appendTo(h).append(c)),k=b("<div>").addClass(l.classes.dropdown).insertAfter(c).hide(),t=b(e).val()||l.prePopulate;function g(e,t){var n,o;0<=t.indexOf(l.tokenDelimiter)?b.each(t.split(l.tokenDelimiter),function(e,t){g(t,t)}):(n=b("<li>"+A(t)+" </li>").addClass(l.classes.token).insertBefore(m),l.makeSortable,o=b("<span></span>").addClass(l.classes.tokenDelete).appendTo(n).click(function(){return C(b(this).parent()),!1}),b('<a href="#">'+l.deleteText+"</a>").attr("title","remove "+t).appendTo(o),o={id:e,name:t},b.data(n.get(0),"tokeninput",o),a=a.slice(0,s).concat([o]).concat(a.slice(s)),s++,e=b.map(a,function(e){return e.id}),u.val(e.join(l.tokenDelimiter)),i+=1)}function v(e){var n="string"===b.type(e)?{id:e,name:e}:b.data(e.get(0),"tokeninput"),e=(c.val(""),l.onAdd);if(0<i&&l.preventDuplicates){var o=null;if(h.children().each(function(){var e=b(this),t=b.data(e.get(0),"tokeninput");if(t&&t.id===n.id)return o=e,!1}),o)return T(o),void c.focus()}g(n.id,n.name),null!==l.tokenLimit&&i>=l.tokenLimit?(c.parent().prev("li").find("a").focus(),c.hide()):c.focus(),y(),b.isFunction(e)&&e.call(u,n),c.change()}function T(e){e.addClass(l.classes.selectedToken),d=e.get(0),c.val(""),y()}function E(e,t){e.removeClass(l.classes.selectedToken),d=null,t===O?s--:t===N?s++:s=i,c.focus()}function C(e){var t=b.data(e.get(0),"tokeninput"),n=l.onDelete,o=e.prevAll().length,e=(s<o&&o--,e.remove(),d=null,c.focus(),a=a.slice(0,o).concat(a.slice(o+1)),o<s&&s--,b.map(a,function(e){return e.id}));u.val(e.join(l.tokenDelimiter)),--i,null!==l.tokenLimit&&c.show().val("").focus(),b.isFunction(n)&&n.call(u,t),c.change()}function y(){k.hide(),p&&b(p).removeClass(l.classes.selectedToken),p=null}function o(){k.css({position:"absolute"}).css("z-index",999).show()}function D(a,e){var i;e&&e.length?(k.empty(),i=b('<ul role="listbox" aria-activedescendant="ui-active-menuitem">').appendTo(k).mouseover(function(e){w(b(e.target).closest("li"))}).mousedown(function(e){return v(b(e.target).closest("li")),!1}).hide(),b.each(e,function(e,t){var n,o=b('<li role="option">'+(o=A(t.name),n=o,b.each(a.split(" "),function(e,t){t&&(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"),n=n.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"))}),n)+"</li>").appendTo(i);e%2?o.addClass(l.classes.dropdownItem):o.addClass(l.classes.dropdownItem2),0===e&&(f=o),b.data(o.get(0),"tokeninput",{id:t.id,name:t.name})}),o(),l.animateDropdown?i.slideDown("fast"):i.show()):l.noResultsText&&(k.html("<p class='notice'>"+l.noResultsText+"</p>"),o())}function w(e){e&&(p&&P(b(p)),e.addClass(l.classes.selectedDropdownItem),p=e.get(0))}function P(e){e.removeClass(l.classes.selectedDropdownItem),p=null}function A(e){return l.escapeHTML?b("<p></p>").text(e).html():e}function L(){var s=c.val().toLowerCase();(s&&s.length||0==l.minChars)&&(p&&P(b(p)),d&&E(b(d),N),0==l.minChars||s.length>=l.minChars?(l.searchingText&&(k.html("<p class='notice'>"+l.searchingText+"</p>"),o()),clearTimeout(n),n=setTimeout(function(){var e,t,n,o,a,i=s;l.noCache||(e=r.get(i)),!l.noCache&&e?D(i,e):(a=i,l.url?(t=a,o={data:{}},-1<l.url.indexOf("?")?(n=l.url.split("?"),o.url=n[0],n=n[1].split("&"),b.each(n,function(e,t){t=t.split("=");o.data[t[0]]=t[1]})):o.url=l.url,l.liveParams&&(n=l.liveParams.split("&"),b.each(n,function(e,t){var t=t.split("="),n="#"+t[1]+" input",n=(0===b(n).size()?n="#"+t[1]:n+=":checked",b(n).map(function(e,t){return b(t).val()}).get());n&&(o.data[t[0]]=n)})),o.data[l.queryParam]=t,o.type=l.method,o.dataType=l.contentType,l.crossDomain&&(o.dataType="jsonp"),o.success=function(e){b.isFunction(l.onResult)&&(e=l.onResult.call(u,e)),l.noCache||r.add(t,l.jsonContainer?e[l.jsonContainer]:e),c.val().toLowerCase()===t&&c.is(":focus")&&D(t,l.jsonContainer?e[l.jsonContainer]:e)},b.ajax(o)):l.local_data&&(e=b.grep(l.local_data,function(e){return-1<e.name.toLowerCase().indexOf(a.toLowerCase())}),b.isFunction(l.onResult)&&(e=l.onResult.call(u,e)),r.add(a,e),D(a,e)))},l.searchDelay)):y())}l.processPrePopulate&&b.isFunction(l.onResult)&&(t=l.onResult.call(u,t)),b(e).val(""),u.val(""),c.val(""),t&&t.length&&("string"==typeof t?g(t,t):b.each(t,function(e,t){g(t.id,t.name)})),null!==l.tokenLimit&&i>=l.tokenLimit&&c.hide(),l.liveParams&&(e=l.liveParams.split("&"),b.each(e,function(e,t){var t=t.split("="),n="#"+t[1]+" input";0===b(n).size()&&(n="#"+t[1]),b(n).each(function(e,t){b(t).hasClass("autocomplete")&&(t=b(t).prev().find("input").first()),b(t).change(function(e){r.clear_data()})})}))},b.TokenList.Cache=function(e){function n(){a={},i=0}var o=b.extend({max_size:500},e),a={},i=0;this.clear_data=function(){n()},this.add=function(e,t){i>o.max_size&&n(),a[e]||(i+=1),a[e]=t},this.get=function(e){return a[e]}}})(jQuery);