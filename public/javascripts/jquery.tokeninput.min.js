(function(e){var t={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:false,prePopulate:null,processPrePopulate:false,makeSortable:false,escapeHTML:true,animateDropdown:true,onResult:null,onAdd:null,onDelete:null,noCache:false};var n={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"};var r={BEFORE:0,AFTER:1,END:2};var i={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188};e.fn.tokenInput=function(n,r){var i=e.extend({},t,r||{});return this.each(function(){new e.TokenList(this,n,i)})};e.TokenList=function(t,s,o){function T(e){return e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function N(t,n){if(n.indexOf(o.tokenDelimiter)>=0){e.each(n.split(o.tokenDelimiter),function(e,t){N(t,t)});return}var r=e("<li>"+q(n)+" </li>").addClass(o.classes.token).insertBefore(w);if(o.makeSortable){}var i=e("<span></span>").addClass(o.classes.tokenDelete).appendTo(r).click(function(){M(e(this).parent());return false});e('<a href="#">'+o.deleteText+"</a>").attr("title","remove "+n).appendTo(i);var s={id:t,name:n};e.data(r.get(0),"tokeninput",s);u=u.slice(0,m).concat([s]).concat(u.slice(m));m++;var f=e.map(u,function(e){return e.id});d.val(f.join(o.tokenDelimiter));a+=1;return r}function C(t){var n;if(e.type(t)==="string"){n={id:t,name:t}}else{n=e.data(t.get(0),"tokeninput")}p.val("");var r=o.onAdd;if(a>0&&o.preventDuplicates){var i=null;b.children().each(function(){var t=e(this);var r=e.data(t.get(0),"tokeninput");if(r&&r.id===n.id){i=t;return false}});if(i){L(i);p.focus();return}}N(n.id,n.name);if(o.tokenLimit!==null&&a>=o.tokenLimit){p.hide()}else{p.focus()}_();if(e.isFunction(r)){r.call(d,n)}p.change()}function k(t){_();var n=e.data(t.get(0),"tokeninput");M(t);p.val(n.id)}function L(e){e.addClass(o.classes.selectedToken);v=e.get(0);p.val("");_()}function A(e,t){e.removeClass(o.classes.selectedToken);v=null;if(t===r.BEFORE){m--}else if(t===r.AFTER){m++}else{m=a}p.focus()}function O(t){var n=v;if(v){if(v===t.get(0)){k(t);return}A(e(v),r.END)}if(n===t.get(0)){A(t,r.END)}else{L(t)}}function M(t){var n=e.data(t.get(0),"tokeninput");var r=o.onDelete;var i=t.prevAll().length;if(i>m)i--;t.remove();v=null;p.focus();u=u.slice(0,i).concat(u.slice(i+1));if(i<m)m--;var s=e.map(u,function(e){return e.id});d.val(s.join(o.tokenDelimiter));a-=1;if(o.tokenLimit!==null){p.show().val("").focus()}if(e.isFunction(r)){r.call(d,n)}p.change()}function _(){E.hide();if(g){e(g).removeClass(o.classes.selectedToken)}g=null}function D(){E.css({position:"absolute"}).css("z-index",999).show()}function P(){if(o.searchingText){E.html("<p class='notice'>"+o.searchingText+"</p>");D()}}function H(){if(o.hintText){E.html("<p class='notice'>"+o.hintText+"</p>");D()}}function B(t,n){var r=t;e.each(n.split(" "),function(e,t){t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1");r=r.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")});return r}function j(t,n){if(n&&n.length){E.empty();var r=e('<ul role="listbox" aria-activedescendant="ui-active-menuitem">').appendTo(E).mouseover(function(t){F(e(t.target).closest("li"))}).mousedown(function(t){C(e(t.target).closest("li"));return false}).hide();e.each(n,function(n,i){var s=e('<li role="option">'+B(q(i.name),t)+"</li>").appendTo(r);if(n%2){s.addClass(o.classes.dropdownItem)}else{s.addClass(o.classes.dropdownItem2)}if(n===0){y=s}e.data(s.get(0),"tokeninput",{id:i.id,name:i.name})});D();if(o.animateDropdown){r.slideDown("fast")}else{r.show()}}else{if(o.noResultsText){E.html("<p class='notice'>"+o.noResultsText+"</p>");D()}}}function F(t){if(t){if(g){I(e(g))}t.addClass(o.classes.selectedDropdownItem);g=t.get(0)}}function I(e){e.removeClass(o.classes.selectedDropdownItem);g=null}function q(t){if(!o.escapeHTML)return t;return e("<p></p>").text(t).html()}function R(){var t=p.val().toLowerCase();if(t&&t.length||o.minChars==0){if(g){I(e(g))}if(v){A(e(v),r.AFTER)}if(o.minChars==0||t.length>=o.minChars){P();clearTimeout(l);l=setTimeout(function(){U(t)},o.searchDelay)}else{_()}}}function U(e){if(!o.noCache){var t=f.get(e)}if(!o.noCache&&t){j(e,t)}else{z(e)}}function z(t){if(o.url){W(t)}else if(o.local_data){var n=e.grep(o.local_data,function(e){return e.name.toLowerCase().indexOf(t.toLowerCase())>-1});if(e.isFunction(o.onResult)){n=o.onResult.call(d,n)}f.add(t,n);j(t,n)}}function W(t){var n={};n.data={};if(o.url.indexOf("?")>-1){var r=o.url.split("?");n.url=r[0];var i=r[1].split("&");e.each(i,function(e,t){var r=t.split("=");n.data[r[0]]=r[1]})}else{n.url=o.url}if(o.liveParams){var s=o.liveParams.split("&");e.each(s,function(t,r){var i=r.split("=");var s="#"+i[1]+" input";if(e(s).size()===0){s="#"+i[1]}else{s+=":checked"}var o=e(s).map(function(t,n){return e(n).val()}).get();if(o){n.data[i[0]]=o}})}n.data[o.queryParam]=t;n.type=o.method;n.dataType=o.contentType;if(o.crossDomain){n.dataType="jsonp"}n.success=function(n){if(e.isFunction(o.onResult)){n=o.onResult.call(d,n)}if(!o.noCache){f.add(t,o.jsonContainer?n[o.jsonContainer]:n)}if(p.val().toLowerCase()===t&&p.is(":focus")){j(t,o.jsonContainer?n[o.jsonContainer]:n)}};e.ajax(n)}if(typeof s==="string"){o.url=s;if(o.crossDomain===undefined){if(o.url.indexOf("://")===-1){o.crossDomain=false}else{o.crossDomain=location.href.split(/\/+/g)[1]!==o.url.split(/\/+/g)[1]}}}else if(typeof s==="object"){o.local_data=s}if(o.classes){o.classes=e.extend({},n,o.classes)}else if(o.theme){o.classes={};e.each(n,function(e,t){o.classes[e]=t+"-"+o.theme})}else{o.classes=n}var u=[];var a=0;var f=new e.TokenList.Cache;var l;var c;var h=e(t).attr("id").removeAttr("id");var p=e('<input type="text" class="text" autocomplete="off" role="combobox" aria-expanded="true" aria-autocomplete="list">').attr({id:h}).focus(function(){if(o.tokenLimit===null||a<o.tokenLimit){if(e(this).val().length>=o.minChars){setTimeout(function(){R()},5)}else{H()}}}).blur(function(){_()}).keydown(function(t){var n;var s;switch(t.keyCode){case i.LEFT:case i.RIGHT:case i.UP:case i.DOWN:if(!y||y.is(":hidden")){if(v){n=e(v).prev();s=e(v).next();if(t.keyCode===i.LEFT||t.keyCode===i.UP){A(e(v),r.BEFORE)}else{A(e(v),r.AFTER)}}else{n=w.prev();s=w.next()}if((t.keyCode===i.LEFT||t.keyCode===i.UP)&&n.length){L(e(n.get(0)))}else if((t.keyCode===i.RIGHT||t.keyCode===i.DOWN)&&s.length){L(e(s.get(0)))}}else if(t.keyCode===i.LEFT||t.keyCode===i.RIGHT){return true}else{var u=null;if(!g){u=y}else if(t.keyCode===i.DOWN){u=e(g).next()}else{u=e(g).prev()}if(u.length){F(u);e(E).scrollTo(e(u))}else if(t.keyCode===i.UP){if(g){I(e(g))}}return false}break;case i.BACKSPACE:case i.DELETE:n=w.prev();if(!e(this).val().length){if(v){M(e(v))}else if(n.length){L(e(n.get(0)))}return false}else if(e(this).val().length===1){_()}else{setTimeout(function(){R()},5)}break;case i.COMMA:case i.TAB:case i.ENTER:case i.NUMPAD_ENTER:if(g){C(e(g));I(e(g));_();if(t.keyCode===i.TAB&&o.tokenLimit&&o.tokenLimit===a){break}else{return false}}else if(p.val()){e.each(p.val().split(o.tokenDelimiter),function(t,n){C(e.trim(n))});_();if(t.keyCode===i.TAB&&o.tokenLimit&&o.tokenLimit===a){break}else{return false}}break;case i.ESCAPE:_();return true;default:if(String.fromCharCode(t.which)){setTimeout(function(){R()},5)}break}});e(t).closest("form").submit(function(){if(p.val()){e.each(p.val().split(o.tokenDelimiter),function(t,n){C(e.trim(n))})}});var d=e(t).hide().focus(function(){p.focus()}).blur(function(){p.blur()});var v=null;var m=0;var g=null;var y=null;var b=e("<ul />").addClass(o.classes.tokenList).click(function(t){var n=e(t.target).closest("li");if(n&&n.get(0)&&e.data(n.get(0),"tokeninput")){O(n)}else{if(v){A(e(v),r.END)}p.focus()}}).mouseover(function(t){var n=e(t.target).closest("li");if(n&&v!==this){n.addClass(o.classes.highlightedToken)}}).mouseout(function(t){var n=e(t.target).closest("li");if(n&&v!==this){n.removeClass(o.classes.highlightedToken)}}).insertBefore(d);if(o.makeSortable){b.addClass(o.classes.sortable)}var w=e("<li />").addClass(o.classes.inputToken).appendTo(b).append(p);var E=e("<div>").addClass(o.classes.dropdown).insertAfter(p).hide();var S=e(t).val()||o.prePopulate;if(o.processPrePopulate&&e.isFunction(o.onResult)){S=o.onResult.call(d,S)}e(t).val("");d.val("");p.val("");if(S&&S.length){if(typeof S==="string"){N(S,S)}else{e.each(S,function(e,t){N(t.id,t.name)})}}if(o.tokenLimit!==null&&a>=o.tokenLimit){p.hide()}if(o.liveParams){var x=o.liveParams.split("&");e.each(x,function(t,n){var r=n.split("=");var i="#"+r[1]+" input";if(e(i).size()===0){i="#"+r[1]}e(i).each(function(t,n){if(e(n).hasClass("autocomplete")){n=e(n).prev().find("input").first()}e(n).change(function(e){f.clear_data()})})})}};e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t);var r={};var i=0;var s=function(){r={};i=0};this.clear_data=function(){s()};this.add=function(e,t){if(i>n.max_size){s()}if(!r[e]){i+=1}r[e]=t};this.get=function(e){return r[e]}}})(jQuery)