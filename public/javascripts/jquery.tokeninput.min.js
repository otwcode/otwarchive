(function($){var DEFAULT_SETTINGS={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1};var DEFAULT_CLASSES={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"};var POSITION={BEFORE:0,AFTER:1,END:2};var KEY;if(!(KeyboardEvent.prototype.hasOwnProperty("key"))){KEY={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188};Object.defineProperty(KeyboardEvent.prototype,"key",{configurable:!0,enumerable:!0,get:function(){return this.keyCode}})}else{var browserHasKeyProp=!0;KEY={BACKSPACE:"Backspace",TAB:"Tab",ENTER:"Enter",ESCAPE:"Escape",SPACE:" ",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",END:"End",HOME:"Home",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",DELETE:"Delete",NUMPAD_ENTER:"Enter",COMMA:","}}
if(browserHasKeyProp){(function(){var eventProto=KeyboardEvent.prototype;var keyProp=Object.getOwnPropertyDescriptor(eventProto,"key");var keys={Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",};Object.defineProperty(eventProto,"key",{configurable:!0,enumerable:!0,get:function(){var key=keyProp.get.call(this);return keys.hasOwnProperty(key)?keys[key]:key}})})()}
$.fn.tokenInput=function(url_or_data,options){var settings=$.extend({},DEFAULT_SETTINGS,options||{});return this.each(function(){new $.TokenList(this,url_or_data,settings)})};$.TokenList=function(input,url_or_data,settings){if(typeof(url_or_data)==="string"){settings.url=url_or_data;if(settings.crossDomain===undefined){if(settings.url.indexOf("://")===-1){settings.crossDomain=!1}else{settings.crossDomain=(location.href.split(/\/+/g)[1]!==settings.url.split(/\/+/g)[1])}}}else if(typeof(url_or_data)==="object"){settings.local_data=url_or_data}
if(settings.classes){settings.classes=$.extend({},DEFAULT_CLASSES,settings.classes)}else if(settings.theme){settings.classes={};$.each(DEFAULT_CLASSES,function(key,value){settings.classes[key]=value+"-"+settings.theme})}else{settings.classes=DEFAULT_CLASSES}
var saved_tokens=[];var token_count=0;var cache=new $.TokenList.Cache();var timeout;var input_val;var hidden_input_id=$(input).attr('id');var hidden_input_label=$('label[for="'+hidden_input_id+'"]');var hidden_input_describedby=$(input).attr("aria-describedby");var autocomplete_dropdown_id=hidden_input_id+"_autocomplete_dropdown";hidden_input_label.attr({'for':hidden_input_id+'_autocomplete','id':hidden_input_id+'_autocomplete_label'});var input_box=$("<input>").attr({"aria-autocomplete":"list","aria-controls":autocomplete_dropdown_id,"autocomplete":"off","class":"text","id":hidden_input_id+"_autocomplete","type":"text"}).attr("aria-describedby",function(){if(hidden_input_describedby){return hidden_input_describedby}}).focus(function(){if(settings.tokenLimit===null||token_count<settings.tokenLimit){if($(this).val().length>=settings.minChars){setTimeout(function(){do_search()},5)}else{show_dropdown_hint()}}}).blur(function(){hide_dropdown()}).keydown(function(event){var previous_token;var next_token;switch(event.key){case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:if(!first_dropdown_item||first_dropdown_item.is(":hidden")){if(selected_token){previous_token=$(selected_token).prev();next_token=$(selected_token).next();if(event.key===KEY.LEFT||event.key===KEY.UP){deselect_token($(selected_token),POSITION.BEFORE)}else{deselect_token($(selected_token),POSITION.AFTER)}}else{previous_token=input_token.prev();next_token=input_token.next()}
if((event.key===KEY.LEFT||event.key===KEY.UP)&&previous_token.length){select_token($(previous_token.get(0)))}else if((event.key===KEY.RIGHT||event.key===KEY.DOWN)&&next_token.length){select_token($(next_token.get(0)))}}else if(event.key===KEY.LEFT||event.key===KEY.RIGHT){return!0}else{var dropdown_item=null;if(!selected_dropdown_item){dropdown_item=first_dropdown_item}else if(event.key===KEY.DOWN){dropdown_item=$(selected_dropdown_item).next()}else{dropdown_item=$(selected_dropdown_item).prev()}
if(dropdown_item.length){select_dropdown_item(dropdown_item);$(dropdown).scrollTo($(dropdown_item))}else if(event.key===KEY.UP){if(selected_dropdown_item){deselect_dropdown_item($(selected_dropdown_item))}}
return!1}
break;case KEY.BACKSPACE:case KEY.DELETE:previous_token=input_token.prev();if(!$(this).val().length){if(selected_token){delete_token($(selected_token))}else if(previous_token.length){select_token($(previous_token.get(0)))}
return!1}else if($(this).val().length===1){hide_dropdown()}else{setTimeout(function(){do_search()},25)}
break;case KEY.COMMA:case KEY.TAB:case KEY.ENTER:case KEY.NUMPAD_ENTER:if(selected_dropdown_item){add_token($(selected_dropdown_item));deselect_dropdown_item($(selected_dropdown_item));hide_dropdown();if(event.keyCode===KEY.TAB&&settings.tokenLimit&&settings.tokenLimit===token_count){break}else{return!1}}else if(input_box.val()){$.each(input_box.val().split(settings.tokenDelimiter),function(index,item){add_token($.trim(item))});hide_dropdown();if(event.keyCode===KEY.TAB&&settings.tokenLimit&&settings.tokenLimit===token_count){break}else{return!1}}
break;case KEY.ESCAPE:hide_dropdown();return!0;default:if(String.fromCharCode(event.which)){setTimeout(function(){do_search()},25)}
break}});$(input).closest("form").submit(function(){if(input_box.val()){$.each(input_box.val().split(settings.tokenDelimiter),function(index,item){add_token($.trim(item))})}});var hidden_input=$(input).hide().focus(function(){input_box.focus()}).blur(function(){input_box.blur()});var selected_token=null;var selected_token_index=0;var selected_dropdown_item=null;var first_dropdown_item=null;var token_list=$("<ul />").addClass(settings.classes.tokenList).click(function(event){var li=$(event.target).closest("li");if(li&&li.get(0)&&$.data(li.get(0),"tokeninput")){toggle_select_token(li)}else{if(selected_token){deselect_token($(selected_token),POSITION.END)}
input_box.focus()}}).mouseover(function(event){var li=$(event.target).closest("li");if(li&&selected_token!==this){li.addClass(settings.classes.highlightedToken)}}).mouseout(function(event){var li=$(event.target).closest("li");if(li&&selected_token!==this){li.removeClass(settings.classes.highlightedToken)}}).insertBefore(hidden_input);if(settings.makeSortable){token_list.addClass(settings.classes.sortable)}
var input_token=$("<li />").addClass(settings.classes.inputToken).attr({"aria-expanded":"false","aria-haspopup":"listbox","aria-owns":autocomplete_dropdown_id,"role":"combobox"}).appendTo(token_list).append(input_box);var dropdown=$("<div>").addClass(settings.classes.dropdown).insertAfter(input_box).hide();var li_data=$(input).val()||settings.prePopulate;if(settings.processPrePopulate&&$.isFunction(settings.onResult)){li_data=settings.onResult.call(hidden_input,li_data)}
$(input).val("");hidden_input.val("");input_box.val("");if(li_data&&li_data.length){if(typeof(li_data)==="string"){insert_token(li_data,li_data)}else{$.each(li_data,function(index,value){insert_token(value.id,value.name)})}}
if(settings.tokenLimit!==null&&token_count>=settings.tokenLimit){input_box.hide()}
if(settings.liveParams){var live_param_fields=settings.liveParams.split("&");$.each(live_param_fields,function(index,value){var kv=value.split("=");var id_to_get='#'+kv[1]+' input';if($(id_to_get).size()===0){id_to_get='#'+kv[1]}
$(id_to_get).each(function(index,node){if($(node).hasClass("autocomplete")){node=$(node).prev().find("input").first()}
$(node).change(function(event){cache.clear_data()})})})}
function is_printable_character(keycode){return((keycode>=48&&keycode<=90)||(keycode>=96&&keycode<=111)||(keycode>=186&&keycode<=192)||(keycode>=219&&keycode<=222))}
function insert_token(id,value){if(value.indexOf(settings.tokenDelimiter)>=0){$.each(value.split(settings.tokenDelimiter),function(index,subvalue){insert_token(subvalue,subvalue)});return}
var this_token=$("<li>"+escapeHTML(value)+" </li>").addClass(settings.classes.token).insertBefore(input_token);if(settings.makeSortable){}
var delete_span_token=$("<span></span>").addClass(settings.classes.tokenDelete).appendTo(this_token).click(function(){delete_token($(this).parent());return!1});$("<a href=\"#\">"+settings.deleteText+"</a>").attr("title","remove "+value).appendTo(delete_span_token);var token_data={"id":id,"name":value};$.data(this_token.get(0),"tokeninput",token_data);saved_tokens=saved_tokens.slice(0,selected_token_index).concat([token_data]).concat(saved_tokens.slice(selected_token_index));selected_token_index++;var token_ids=$.map(saved_tokens,function(el){return el.id});hidden_input.val(token_ids.join(settings.tokenDelimiter));token_count+=1;return this_token}
function add_token(item){var li_data;if($.type(item)==="string"){li_data={id:item,name:item}}else{li_data=$.data(item.get(0),"tokeninput")}
input_box.val("");var callback=settings.onAdd;if(token_count>0&&settings.preventDuplicates){var found_existing_token=null;token_list.children().each(function(){var existing_token=$(this);var existing_data=$.data(existing_token.get(0),"tokeninput");if(existing_data&&existing_data.id===li_data.id){found_existing_token=existing_token;return!1}});if(found_existing_token){select_token(found_existing_token);input_box.focus();return}}
insert_token(li_data.id,li_data.name);if(settings.tokenLimit!==null&&token_count>=settings.tokenLimit){input_box.parent().prev("li").find("a").focus();input_box.hide()}else{input_box.focus()}
hide_dropdown();if($.isFunction(callback)){callback.call(hidden_input,li_data)}
input_box.change()}
function edit_token(token){hide_dropdown();var token_data=$.data(token.get(0),"tokeninput");delete_token(token);input_box.val(token_data.id)}
function select_token(token){token.addClass(settings.classes.selectedToken);selected_token=token.get(0);input_box.val("");hide_dropdown()}
function deselect_token(token,position){token.removeClass(settings.classes.selectedToken);selected_token=null;if(position===POSITION.BEFORE){selected_token_index--}else if(position===POSITION.AFTER){selected_token_index++}else{selected_token_index=token_count}
input_box.focus()}
function toggle_select_token(token){var previous_selected_token=selected_token;if(selected_token){if(selected_token===token.get(0)){edit_token(token);return}
deselect_token($(selected_token),POSITION.END)}
if(previous_selected_token===token.get(0)){deselect_token(token,POSITION.END)}else{select_token(token)}}
function delete_token(token){var token_data=$.data(token.get(0),"tokeninput");var callback=settings.onDelete;var index=token.prevAll().length;if(index>selected_token_index)index--;token.remove();selected_token=null;input_box.focus();saved_tokens=saved_tokens.slice(0,index).concat(saved_tokens.slice(index+1));if(index<selected_token_index)selected_token_index--;var token_ids=$.map(saved_tokens,function(el){return el.id});hidden_input.val(token_ids.join(settings.tokenDelimiter));token_count-=1;if(settings.tokenLimit!==null){input_box.show().val("").focus()}
if($.isFunction(callback)){callback.call(hidden_input,token_data)}
input_box.change()}
function hide_dropdown(){dropdown.hide();if(selected_dropdown_item){$(selected_dropdown_item).removeClass(settings.classes.selectedToken)}
input_token.attr("aria-expanded","false");input_box.removeAttr("aria-activedescendant");selected_dropdown_item=null}
function show_dropdown(){dropdown.attr("id",autocomplete_dropdown_id).css({position:"absolute"}).css('z-index',999).show();input_token.attr("aria-expanded","true")}
function show_dropdown_searching(){if(settings.searchingText){dropdown.html("<p class='notice'>"+settings.searchingText+"</p>");show_dropdown()}}
function show_dropdown_hint(){if(settings.hintText){dropdown.html("<p class='notice'>"+settings.hintText+"</p>");show_dropdown()}}
function highlight_term(value,term){var newvalue=value;$.each(term.split(' '),function(index,termbit){if(!termbit){return}
termbit=termbit.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1");newvalue=newvalue.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+termbit+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")});return newvalue}
function populate_dropdown(query,results){if(results&&results.length){dropdown.empty();var dropdown_ul=$("<ul>").attr({"aria-labelledby":hidden_input_label.attr("id"),"role":"listbox"}).appendTo(dropdown).mouseover(function(event){select_dropdown_item($(event.target).closest("li"))}).mousedown(function(event){add_token($(event.target).closest("li"));return!1}).hide();$.each(results,function(index,value){var this_li=$("<li>"+highlight_term(escapeHTML(value.name),query)+"</li>").attr({"id":hidden_input_id+"_autocomplete_suggestion_"+index,"role":"option"}).appendTo(dropdown_ul);if(index%2){this_li.addClass(settings.classes.dropdownItem)}else{this_li.addClass(settings.classes.dropdownItem2)}
if(index===0){first_dropdown_item=this_li}
$.data(this_li.get(0),"tokeninput",{"id":value.id,"name":value.name})});show_dropdown();if(settings.animateDropdown){dropdown_ul.slideDown("fast")}else{dropdown_ul.show()}}else{if(settings.noResultsText){dropdown.html("<p class='notice'>"+settings.noResultsText+"</p>");show_dropdown()}}}
function select_dropdown_item(item){if(item){if(selected_dropdown_item){deselect_dropdown_item($(selected_dropdown_item))}
input_box.attr("aria-activedescendant",item.attr("id"));item.attr("aria-selected","true");item.addClass(settings.classes.selectedDropdownItem);selected_dropdown_item=item.get(0)}}
function deselect_dropdown_item(item){input_box.removeAttr("aria-activedescendant");item.removeAttr("aria-selected");item.removeClass(settings.classes.selectedDropdownItem);selected_dropdown_item=null}
function escapeHTML(text){if(!settings.escapeHTML)return text;return $("<p></p>").text(text).html()}
function do_search(){var query=input_box.val().toLowerCase();if((query&&query.length)||settings.minChars==0){if(selected_dropdown_item){deselect_dropdown_item($(selected_dropdown_item))}
if(selected_token){deselect_token($(selected_token),POSITION.AFTER)}
if(settings.minChars==0||query.length>=settings.minChars){show_dropdown_searching();clearTimeout(timeout);timeout=setTimeout(function(){run_search(query)},settings.searchDelay)}else{hide_dropdown()}}}
function run_search(query){if(!settings.noCache){var cached_results=cache.get(query)}
if(!settings.noCache&&cached_results){populate_dropdown(query,cached_results)}else{search_and_cache(query)}}
function search_and_cache(query){if(settings.url){ajax_search(query)}else if(settings.local_data){var results=$.grep(settings.local_data,function(row){return row.name.toLowerCase().indexOf(query.toLowerCase())>-1});if($.isFunction(settings.onResult)){results=settings.onResult.call(hidden_input,results)}
cache.add(query,results);populate_dropdown(query,results)}}
function ajax_search(query){var ajax_params={};ajax_params.data={};if(settings.url.indexOf("?")>-1){var parts=settings.url.split("?");ajax_params.url=parts[0];var param_array=parts[1].split("&");$.each(param_array,function(index,value){var kv=value.split("=");ajax_params.data[kv[0]]=kv[1]})}else{ajax_params.url=settings.url}
if(settings.liveParams){var live_param_fields=settings.liveParams.split("&");$.each(live_param_fields,function(index,value){var kv=value.split("=");var id_to_get='#'+kv[1]+' input';if($(id_to_get).size()===0){id_to_get='#'+kv[1]}else{id_to_get+=':checked'}
var id_contents=$(id_to_get).map(function(i,n){return $(n).val()}).get();if(id_contents){ajax_params.data[kv[0]]=id_contents}})}
ajax_params.data[settings.queryParam]=query;ajax_params.type=settings.method;ajax_params.dataType=settings.contentType;if(settings.crossDomain){ajax_params.dataType="jsonp"}
ajax_params.success=function(results){if($.isFunction(settings.onResult)){results=settings.onResult.call(hidden_input,results)}
if(!settings.noCache){cache.add(query,settings.jsonContainer?results[settings.jsonContainer]:results)}
if(input_box.val().toLowerCase()===query&&input_box.is(":focus")){populate_dropdown(query,settings.jsonContainer?results[settings.jsonContainer]:results)}};$.ajax(ajax_params)}};$.TokenList.Cache=function(options){var settings=$.extend({max_size:500},options);var data={};var size=0;var flush=function(){data={};size=0};this.clear_data=function(){flush()};this.add=function(query,results){if(size>settings.max_size){flush()}
if(!data[query]){size+=1}
data[query]=results};this.get=function(query){return data[query]}}}(jQuery))
