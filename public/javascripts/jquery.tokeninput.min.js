!function(e){var t={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1},n={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"},a={BEFORE:0,AFTER:1,END:2},o={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188};e.fn.tokenInput=function(n,a){var o=e.extend({},t,a||{});return this.each(function(){new e.TokenList(this,n,o)})},e.TokenList=function(t,i,s){function l(t,n){if(!(n.indexOf(s.tokenDelimiter)>=0)){var a=e("<li>"+D(n)+" </li>").addClass(s.classes.token).insertBefore(M);s.makeSortable;var o=e("<span></span>").addClass(s.classes.tokenDelete).appendTo(a).click(function(){return p(e(this).parent()),!1});e('<a href="#">'+s.deleteText+"</a>").attr("title","remove "+n).appendTo(o);var i={id:t,name:n};e.data(a.get(0),"tokeninput",i),A=A.slice(0,j).concat([i]).concat(A.slice(j)),j++;var r=e.map(A,function(e){return e.id});return O.val(r.join(s.tokenDelimiter)),R+=1,a}e.each(n.split(s.tokenDelimiter),function(e,t){l(t,t)})}function r(t){var n;n="string"===e.type(t)?{id:t,name:t}:e.data(t.get(0),"tokeninput"),N.val("");var a=s.onAdd;if(R>0&&s.preventDuplicates){var o=null;if(S.children().each(function(){var t=e(this),a=e.data(t.get(0),"tokeninput");if(a&&a.id===n.id)return o=t,!1}),o)return u(o),void N.focus()}l(n.id,n.name),null!==s.tokenLimit&&R>=s.tokenLimit?N.hide():N.focus(),h(),e.isFunction(a)&&a.call(O,n),N.change()}function c(t){h();var n=e.data(t.get(0),"tokeninput");p(t),N.val(n.id)}function u(e){e.addClass(s.classes.selectedToken),_=e.get(0),N.val(""),h()}function d(e,t){e.removeClass(s.classes.selectedToken),_=null,t===a.BEFORE?j--:t===a.AFTER?j++:j=R,N.focus()}function f(t){var n=_;if(_){if(_===t.get(0))return void c(t);d(e(_),a.END)}n===t.get(0)?d(t,a.END):u(t)}function p(t){var n=e.data(t.get(0),"tokeninput"),a=s.onDelete,o=t.prevAll().length;o>j&&o--,t.remove(),_=null,N.focus(),A=A.slice(0,o).concat(A.slice(o+1)),o<j&&j--;var i=e.map(A,function(e){return e.id});O.val(i.join(s.tokenDelimiter)),R-=1,null!==s.tokenLimit&&N.show().val("").focus(),e.isFunction(a)&&a.call(O,n),N.change()}function h(){U.hide(),B&&e(B).removeClass(s.classes.selectedToken),B=null}function m(){U.css({position:"absolute"}).css("z-index",999).show()}function v(){s.searchingText&&(U.html("<p class='notice'>"+s.searchingText+"</p>"),m())}function k(){s.hintText&&(U.html("<p class='notice'>"+s.hintText+"</p>"),m())}function T(t,n){var a=t;return e.each(n.split(" "),function(e,t){t&&(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"),a=a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"))}),a}function g(t,n){if(n&&n.length){U.empty();var a=e('<ul role="listbox" aria-activedescendant="ui-active-menuitem">').appendTo(U).mouseover(function(t){C(e(t.target).closest("li"))}).mousedown(function(t){return r(e(t.target).closest("li")),!1}).hide();e.each(n,function(n,o){var i=e('<li role="option">'+T(D(o.name),t)+"</li>").appendTo(a);n%2?i.addClass(s.classes.dropdownItem):i.addClass(s.classes.dropdownItem2),0===n&&(I=i),e.data(i.get(0),"tokeninput",{id:o.id,name:o.name})}),m(),s.animateDropdown?a.slideDown("fast"):a.show()}else s.noResultsText&&(U.html("<p class='notice'>"+s.noResultsText+"</p>"),m())}function C(t){t&&(B&&E(e(B)),t.addClass(s.classes.selectedDropdownItem),B=t.get(0))}function E(e){e.removeClass(s.classes.selectedDropdownItem),B=null}function D(t){return s.escapeHTML?e("<p></p>").text(t).html():t}function x(){var t=N.val().toLowerCase();(t&&t.length||0==s.minChars)&&(B&&E(e(B)),_&&d(e(_),a.AFTER),0==s.minChars||t.length>=s.minChars?(v(),clearTimeout(P),P=setTimeout(function(){y(t)},s.searchDelay)):h())}function y(e){if(!s.noCache)var t=b.get(e);!s.noCache&&t?g(e,t):L(e)}function L(t){if(s.url)w(t);else if(s.local_data){var n=e.grep(s.local_data,function(e){return e.name.toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(s.onResult)&&(n=s.onResult.call(O,n)),b.add(t,n),g(t,n)}}function w(t){var n={};if(n.data={},s.url.indexOf("?")>-1){var a=s.url.split("?");n.url=a[0];var o=a[1].split("&");e.each(o,function(e,t){var a=t.split("=");n.data[a[0]]=a[1]})}else n.url=s.url;if(s.liveParams){var i=s.liveParams.split("&");e.each(i,function(t,a){var o=a.split("="),i="#"+o[1]+" input";0===e(i).size()?i="#"+o[1]:i+=":checked";var s=e(i).map(function(t,n){return e(n).val()}).get();s&&(n.data[o[0]]=s)})}n.data[s.queryParam]=t,n.type=s.method,n.dataType=s.contentType,s.crossDomain&&(n.dataType="jsonp"),n.success=function(n){e.isFunction(s.onResult)&&(n=s.onResult.call(O,n)),s.noCache||b.add(t,s.jsonContainer?n[s.jsonContainer]:n),N.val().toLowerCase()===t&&N.is(":focus")&&g(t,s.jsonContainer?n[s.jsonContainer]:n)},e.ajax(n)}"string"==typeof i?(s.url=i,void 0===s.crossDomain&&(-1===s.url.indexOf("://")?s.crossDomain=!1:s.crossDomain=location.href.split(/\/+/g)[1]!==s.url.split(/\/+/g)[1])):"object"==typeof i&&(s.local_data=i),s.classes?s.classes=e.extend({},n,s.classes):s.theme?(s.classes={},e.each(n,function(e,t){s.classes[e]=t+"-"+s.theme})):s.classes=n;var P,A=[],R=0,b=new e.TokenList.Cache,F=e(t).attr("id");e('label[for="'+F+'"]').attr({for:F+"_autocomplete"});var N=e('<input type="text" class="text" autocomplete="off" role="combobox" aria-expanded="true" aria-autocomplete="list">').attr({id:F+"_autocomplete"}).focus(function(){(null===s.tokenLimit||R<s.tokenLimit)&&(e(this).val().length>=s.minChars?setTimeout(function(){x()},5):k())}).blur(function(){h()}).keydown(function(t){var n,i;switch(t.keyCode){case o.LEFT:case o.RIGHT:case o.UP:case o.DOWN:if(I&&!I.is(":hidden")){if(t.keyCode===o.LEFT||t.keyCode===o.RIGHT)return!0;var l=null;return l=B?t.keyCode===o.DOWN?e(B).next():e(B).prev():I,l.length?(C(l),e(U).scrollTo(e(l))):t.keyCode===o.UP&&B&&E(e(B)),!1}_?(n=e(_).prev(),i=e(_).next(),t.keyCode===o.LEFT||t.keyCode===o.UP?d(e(_),a.BEFORE):d(e(_),a.AFTER)):(n=M.prev(),i=M.next()),t.keyCode!==o.LEFT&&t.keyCode!==o.UP||!n.length?t.keyCode!==o.RIGHT&&t.keyCode!==o.DOWN||!i.length||u(e(i.get(0))):u(e(n.get(0)));break;case o.BACKSPACE:case o.DELETE:if(n=M.prev(),!e(this).val().length)return _?p(e(_)):n.length&&u(e(n.get(0))),!1;1===e(this).val().length?h():setTimeout(function(){x()},5);break;case o.COMMA:case o.TAB:case o.ENTER:case o.NUMPAD_ENTER:if(B){if(r(e(B)),E(e(B)),h(),t.keyCode===o.TAB&&s.tokenLimit&&s.tokenLimit===R)break;return!1}if(N.val()){if(e.each(N.val().split(s.tokenDelimiter),function(t,n){r(e.trim(n))}),h(),t.keyCode===o.TAB&&s.tokenLimit&&s.tokenLimit===R)break;return!1}break;case o.ESCAPE:return h(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){x()},5)}});e(t).closest("form").submit(function(){N.val()&&e.each(N.val().split(s.tokenDelimiter),function(t,n){r(e.trim(n))})});var O=e(t).hide().focus(function(){N.focus()}).blur(function(){N.blur()}),_=null,j=0,B=null,I=null,S=e("<ul />").addClass(s.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?f(n):(_&&d(e(_),a.END),N.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&_!==this&&n.addClass(s.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&_!==this&&n.removeClass(s.classes.highlightedToken)}).insertBefore(O);s.makeSortable&&S.addClass(s.classes.sortable);var M=e("<li />").addClass(s.classes.inputToken).appendTo(S).append(N),U=e("<div>").addClass(s.classes.dropdown).insertAfter(N).hide(),G=e(t).val()||s.prePopulate;if(s.processPrePopulate&&e.isFunction(s.onResult)&&(G=s.onResult.call(O,G)),e(t).val(""),O.val(""),N.val(""),G&&G.length&&("string"==typeof G?l(G,G):e.each(G,function(e,t){l(t.id,t.name)})),null!==s.tokenLimit&&R>=s.tokenLimit&&N.hide(),s.liveParams){var H=s.liveParams.split("&");e.each(H,function(t,n){var a=n.split("="),o="#"+a[1]+" input";0===e(o).size()&&(o="#"+a[1]),e(o).each(function(t,n){e(n).hasClass("autocomplete")&&(n=e(n).prev().find("input").first()),e(n).change(function(e){b.clear_data()})})})}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),a={},o=0,i=function(){a={},o=0};this.clear_data=function(){i()},this.add=function(e,t){o>n.max_size&&i(),a[e]||(o+=1),a[e]=t},this.get=function(e){return a[e]}}}(jQuery);