!function(e){var t,n,a,o,i={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1},s={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"},l={BEFORE:0,AFTER:1,END:2};if(KeyboardEvent.prototype.hasOwnProperty("key")){var r=!0;t={BACKSPACE:"Backspace",TAB:"Tab",ENTER:"Enter",ESCAPE:"Escape",SPACE:" ",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",END:"End",HOME:"Home",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",DELETE:"Delete",NUMPAD_ENTER:"Enter",COMMA:","}}else t={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188},Object.defineProperty(KeyboardEvent.prototype,"key",{configurable:!0,enumerable:!0,get:function(){return this.keyCode}});r&&(n=KeyboardEvent.prototype,a=Object.getOwnPropertyDescriptor(n,"key"),o={Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete"},Object.defineProperty(n,"key",{configurable:!0,enumerable:!0,get:function(){var e=a.get.call(this);return o.hasOwnProperty(e)?o[e]:e}})),e.fn.tokenInput=function(t,n){var a=e.extend({},i,n||{});return this.each(function(){new e.TokenList(this,t,a)})},e.TokenList=function(n,a,o){"string"==typeof a?(o.url=a,void 0===o.crossDomain&&(-1===o.url.indexOf("://")?o.crossDomain=!1:o.crossDomain=location.href.split(/\/+/g)[1]!==o.url.split(/\/+/g)[1])):"object"==typeof a&&(o.local_data=a),o.classes?o.classes=e.extend({},s,o.classes):o.theme?(o.classes={},e.each(s,function(e,t){o.classes[e]=t+"-"+o.theme})):o.classes=s;var i,r=[],c=0,u=new e.TokenList.Cache,d=e(n).attr("id");e('label[for="'+d+'"]').attr({for:d+"_autocomplete"});var p=e('<input type="text" class="text" autocomplete="off" role="combobox" aria-expanded="true" aria-autocomplete="list">').attr({id:d+"_autocomplete"}).focus(function(){(null===o.tokenLimit||c<o.tokenLimit)&&(e(this).val().length>=o.minChars?setTimeout(function(){F()},5):o.hintText&&(g.html("<p class='notice'>"+o.hintText+"</p>"),x()))}).blur(function(){b()}).keydown(function(n){var a,i;switch(n.key){case t.LEFT:case t.RIGHT:case t.UP:case t.DOWN:if(k&&!k.is(":hidden")){if(n.key===t.LEFT||n.key===t.RIGHT)return!0;var s=null;return(s=v?n.key===t.DOWN?e(v).next():e(v).prev():k).length?(O(s),e(g).scrollTo(e(s))):n.key===t.UP&&v&&N(e(v)),!1}h?(a=e(h).prev(),i=e(h).next(),n.key===t.LEFT||n.key===t.UP?w(e(h),l.BEFORE):w(e(h),l.AFTER)):(a=E.prev(),i=E.next()),n.key!==t.LEFT&&n.key!==t.UP||!a.length?n.key!==t.RIGHT&&n.key!==t.DOWN||!i.length||P(e(i.get(0))):P(e(a.get(0)));break;case t.BACKSPACE:case t.DELETE:if(a=E.prev(),!e(this).val().length)return h?L(e(h)):a.length&&P(e(a.get(0))),!1;1===e(this).val().length?b():setTimeout(function(){F()},25);break;case t.COMMA:case t.TAB:case t.ENTER:case t.NUMPAD_ENTER:if(v){if(A(e(v)),N(e(v)),b(),n.keyCode===t.TAB&&o.tokenLimit&&o.tokenLimit===c)break;return!1}if(p.val()){if(e.each(p.val().split(o.tokenDelimiter),function(t,n){A(e.trim(n))}),b(),n.keyCode===t.TAB&&o.tokenLimit&&o.tokenLimit===c)break;return!1}break;case t.ESCAPE:return b(),!0;default:String.fromCharCode(n.which)&&setTimeout(function(){F()},25)}});e(n).closest("form").submit(function(){p.val()&&e.each(p.val().split(o.tokenDelimiter),function(t,n){A(e.trim(n))})});var f=e(n).hide().focus(function(){p.focus()}).blur(function(){p.blur()}),h=null,m=0,v=null,k=null,T=e("<ul />").addClass(o.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?function(t){var n=h;if(h){if(h===t.get(0))return void function(t){b();var n=e.data(t.get(0),"tokeninput");L(t),p.val(n.id)}(t);w(e(h),l.END)}n===t.get(0)?w(t,l.END):P(t)}(n):(h&&w(e(h),l.END),p.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&h!==this&&n.addClass(o.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&h!==this&&n.removeClass(o.classes.highlightedToken)}).insertBefore(f);o.makeSortable&&T.addClass(o.classes.sortable);var E=e("<li />").addClass(o.classes.inputToken).appendTo(T).append(p),g=e("<div>").addClass(o.classes.dropdown).insertAfter(p).hide(),C=e(n).val()||o.prePopulate;if(o.processPrePopulate&&e.isFunction(o.onResult)&&(C=o.onResult.call(f,C)),e(n).val(""),f.val(""),p.val(""),C&&C.length&&("string"==typeof C?y(C,C):e.each(C,function(e,t){y(t.id,t.name)})),null!==o.tokenLimit&&c>=o.tokenLimit&&p.hide(),o.liveParams){var D=o.liveParams.split("&");e.each(D,function(t,n){var a=n.split("="),o="#"+a[1]+" input";0===e(o).size()&&(o="#"+a[1]),e(o).each(function(t,n){e(n).hasClass("autocomplete")&&(n=e(n).prev().find("input").first()),e(n).change(function(e){u.clear_data()})})})}function y(t,n){if(!(n.indexOf(o.tokenDelimiter)>=0)){var a,i=e("<li>"+(a=n,o.escapeHTML?e("<p></p>").text(a).html():a)+" </li>").addClass(o.classes.token).insertBefore(E);o.makeSortable;var s=e("<span></span>").addClass(o.classes.tokenDelete).appendTo(i).click(function(){return L(e(this).parent()),!1});e('<a href="#">'+o.deleteText+"</a>").attr("title","remove "+n).appendTo(s);var l={id:t,name:n};e.data(i.get(0),"tokeninput",l),r=r.slice(0,m).concat([l]).concat(r.slice(m)),m++;var u=e.map(r,function(e){return e.id});return f.val(u.join(o.tokenDelimiter)),c+=1,i}e.each(n.split(o.tokenDelimiter),function(e,t){y(t,t)})}function A(t){var n;n="string"===e.type(t)?{id:t,name:t}:e.data(t.get(0),"tokeninput"),p.val("");var a=o.onAdd;if(c>0&&o.preventDuplicates){var i=null;if(T.children().each(function(){var t=e(this),a=e.data(t.get(0),"tokeninput");if(a&&a.id===n.id)return i=t,!1}),i)return P(i),void p.focus()}y(n.id,n.name),null!==o.tokenLimit&&c>=o.tokenLimit?(p.parent().prev("li").find("a").focus(),p.hide()):p.focus(),b(),e.isFunction(a)&&a.call(f,n),p.change()}function P(e){e.addClass(o.classes.selectedToken),h=e.get(0),p.val(""),b()}function w(e,t){e.removeClass(o.classes.selectedToken),h=null,t===l.BEFORE?m--:t===l.AFTER?m++:m=c,p.focus()}function L(t){var n=e.data(t.get(0),"tokeninput"),a=o.onDelete,i=t.prevAll().length;i>m&&i--,t.remove(),h=null,p.focus(),r=r.slice(0,i).concat(r.slice(i+1)),i<m&&m--;var s=e.map(r,function(e){return e.id});f.val(s.join(o.tokenDelimiter)),c-=1,null!==o.tokenLimit&&p.show().val("").focus(),e.isFunction(a)&&a.call(f,n),p.change()}function b(){g.hide(),v&&e(v).removeClass(o.classes.selectedToken),v=null}function x(){g.css({position:"absolute"}).css("z-index",999).show()}function R(t,n){if(n&&n.length){g.empty();var a=e('<ul role="listbox" aria-activedescendant="ui-active-menuitem">').appendTo(g).mouseover(function(t){O(e(t.target).closest("li"))}).mousedown(function(t){return A(e(t.target).closest("li")),!1}).hide();e.each(n,function(t,n){var i=e('<li role="option">'+n.name+"</li>").appendTo(a);t%2?i.addClass(o.classes.dropdownItem):i.addClass(o.classes.dropdownItem2),0===t&&(k=i),e.data(i.get(0),"tokeninput",{id:n.id,name:n.name})}),x(),o.animateDropdown?a.slideDown("fast"):a.show()}else o.noResultsText&&(g.html("<p class='notice'>"+o.noResultsText+"</p>"),x())}function O(t){t&&(v&&N(e(v)),t.addClass(o.classes.selectedDropdownItem),v=t.get(0))}function N(e){e.removeClass(o.classes.selectedDropdownItem),v=null}function F(){var t=p.val().toLowerCase();(t&&t.length||0==o.minChars)&&(v&&N(e(v)),h&&w(e(h),l.AFTER),0==o.minChars||t.length>=o.minChars?(o.searchingText&&(g.html("<p class='notice'>"+o.searchingText+"</p>"),x()),clearTimeout(i),i=setTimeout(function(){!function(t){if(!o.noCache)var n=u.get(t);!o.noCache&&n?R(0,n):function(t){if(o.url)!function(t){var n={data:{}};if(o.url.indexOf("?")>-1){var a=o.url.split("?");n.url=a[0];var i=a[1].split("&");e.each(i,function(e,t){var a=t.split("=");n.data[a[0]]=a[1]})}else n.url=o.url;if(o.liveParams){var s=o.liveParams.split("&");e.each(s,function(t,a){var o=a.split("="),i="#"+o[1]+" input";0===e(i).size()?i="#"+o[1]:i+=":checked";var s=e(i).map(function(t,n){return e(n).val()}).get();s&&(n.data[o[0]]=s)})}n.data[o.queryParam]=t,n.type=o.method,n.dataType=o.contentType,o.crossDomain&&(n.dataType="jsonp");n.success=function(n){e.isFunction(o.onResult)&&(n=o.onResult.call(f,n)),o.noCache||u.add(t,o.jsonContainer?n[o.jsonContainer]:n),p.val().toLowerCase()===t&&p.is(":focus")&&R(0,o.jsonContainer?n[o.jsonContainer]:n)},e.ajax(n)}(t);else if(o.local_data){var n=e.grep(o.local_data,function(e){return e.name.toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(o.onResult)&&(n=o.onResult.call(f,n)),u.add(t,n),R(0,n)}}(t)}(t)},o.searchDelay)):b())}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),a={},o=0,i=function(){a={},o=0};this.clear_data=function(){i()},this.add=function(e,t){o>n.max_size&&i(),a[e]||(o+=1),a[e]=t},this.get=function(e){return a[e]}}}(jQuery);