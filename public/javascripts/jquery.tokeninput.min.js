!function(j){var e,U,t,n,a,o={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1},_={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"},S=0,I=1,M=2;KeyboardEvent.prototype.hasOwnProperty("key")?(e=!0,U={BACKSPACE:"Backspace",TAB:"Tab",ENTER:"Enter",ESCAPE:"Escape",SPACE:" ",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",END:"End",HOME:"Home",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",DELETE:"Delete",NUMPAD_ENTER:"Enter",COMMA:","}):(U={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188},Object.defineProperty(KeyboardEvent.prototype,"key",{configurable:!0,enumerable:!0,get:function(){return this.keyCode}})),e&&(t=KeyboardEvent.prototype,n=Object.getOwnPropertyDescriptor(t,"key"),a={Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete"},Object.defineProperty(t,"key",{configurable:!0,enumerable:!0,get:function(){var e=n.get.call(this);return a.hasOwnProperty(e)?a[e]:e}})),j.fn.tokenInput=function(e,t){var n=j.extend({},o,t||{});return this.each(function(){new j.TokenList(this,e,n)})},j.TokenList=function(e,t,l){"string"==typeof t?(l.url=t,void 0===l.crossDomain&&(-1===l.url.indexOf("://")?l.crossDomain=!1:l.crossDomain=location.href.split(/\/+/g)[1]!==l.url.split(/\/+/g)[1])):"object"==typeof t&&(l.local_data=t),l.classes?l.classes=j.extend({},_,l.classes):l.theme?(l.classes={},j.each(_,function(e,t){l.classes[e]=t+"-"+l.theme})):l.classes=_;var n,s=[],r=0,o=new j.TokenList.Cache,a=j(e).attr("id"),i=j('label[for="'+a+'"]'),c=j(e).attr("aria-describedby");i.attr({for:a+"_autocomplete"});var u=j("<input>").attr({"aria-autocomplete":"list","aria-expanded":"true",autocomplete:"off",class:"text",role:"combobox",type:"text"}).attr("aria-describedby",function(){if(c)return c}).focus(function(){(null===l.tokenLimit||r<l.tokenLimit)&&(j(this).val().length>=l.minChars?setTimeout(function(){N()},5):l.hintText&&(T.html("<p class='notice'>"+l.hintText+"</p>"),A()))}).blur(function(){b()}).keydown(function(e){var t,n;switch(e.key){case U.LEFT:case U.RIGHT:case U.UP:case U.DOWN:if(m&&!m.is(":hidden")){if(e.key===U.LEFT||e.key===U.RIGHT)return!0;var a=null;return(a=h?e.key===U.DOWN?j(h).next():j(h).prev():m).length?(x(a),j(T).scrollTo(j(a))):e.key===U.UP&&h&&R(j(h)),!1}p?(t=j(p).prev(),n=j(p).next(),e.key===U.LEFT||e.key===U.UP?w(j(p),S):w(j(p),I)):(t=g.prev(),n=g.next()),e.key!==U.LEFT&&e.key!==U.UP||!t.length?e.key!==U.RIGHT&&e.key!==U.DOWN||!n.length||D(j(n.get(0))):D(j(t.get(0)));break;case U.BACKSPACE:case U.DELETE:if(t=g.prev(),!j(this).val().length)return p?P(j(p)):t.length&&D(j(t.get(0))),!1;1===j(this).val().length?b():setTimeout(function(){N()},25);break;case U.COMMA:case U.TAB:case U.ENTER:case U.NUMPAD_ENTER:if(h){if(y(j(h)),R(j(h)),b(),e.keyCode===U.TAB&&l.tokenLimit&&l.tokenLimit===r)break;return!1}if(u.val()){if(j.each(u.val().split(l.tokenDelimiter),function(e,t){y(j.trim(t))}),b(),e.keyCode===U.TAB&&l.tokenLimit&&l.tokenLimit===r)break;return!1}break;case U.ESCAPE:return b(),!0;default:String.fromCharCode(e.which)&&setTimeout(function(){N()},25)}});j(e).closest("form").submit(function(){u.val()&&j.each(u.val().split(l.tokenDelimiter),function(e,t){y(j.trim(t))})});var d=j(e).hide().focus(function(){u.focus()}).blur(function(){u.blur()}),p=null,f=0,h=null,m=null,v=j("<ul />").addClass(l.classes.tokenList).click(function(e){var t=j(e.target).closest("li");t&&t.get(0)&&j.data(t.get(0),"tokeninput")?function(e){var t=p;if(p){if(p===e.get(0))return function(e){b();var t=j.data(e.get(0),"tokeninput");P(e),u.val(t.id)}(e);w(j(p),M)}t===e.get(0)?w(e,M):D(e)}(t):(p&&w(j(p),M),u.focus())}).mouseover(function(e){var t=j(e.target).closest("li");t&&p!==this&&t.addClass(l.classes.highlightedToken)}).mouseout(function(e){var t=j(e.target).closest("li");t&&p!==this&&t.removeClass(l.classes.highlightedToken)}).insertBefore(d);l.makeSortable&&v.addClass(l.classes.sortable);var k,g=j("<li />").addClass(l.classes.inputToken).appendTo(v).append(u),T=j("<div>").addClass(l.classes.dropdown).insertAfter(u).hide(),E=j(e).val()||l.prePopulate;function C(e,t){if(!(0<=t.indexOf(l.tokenDelimiter))){var n=j("<li>"+O(t)+" </li>").addClass(l.classes.token).insertBefore(g);l.makeSortable;var a=j("<span></span>").addClass(l.classes.tokenDelete).appendTo(n).click(function(){return P(j(this).parent()),!1});j('<a href="#">'+l.deleteText+"</a>").attr("title","remove "+t).appendTo(a);var o={id:e,name:t};j.data(n.get(0),"tokeninput",o),s=s.slice(0,f).concat([o]).concat(s.slice(f)),f++;var i=j.map(s,function(e){return e.id});return d.val(i.join(l.tokenDelimiter)),r+=1,n}j.each(t.split(l.tokenDelimiter),function(e,t){C(t,t)})}function y(e){var n="string"===j.type(e)?{id:e,name:e}:j.data(e.get(0),"tokeninput");u.val("");var t=l.onAdd;if(0<r&&l.preventDuplicates){var a=null;if(v.children().each(function(){var e=j(this),t=j.data(e.get(0),"tokeninput");if(t&&t.id===n.id)return a=e,!1}),a)return D(a),void u.focus()}C(n.id,n.name),null!==l.tokenLimit&&r>=l.tokenLimit?(u.parent().prev("li").find("a").focus(),u.hide()):u.focus(),b(),j.isFunction(t)&&t.call(d,n),u.change()}function D(e){e.addClass(l.classes.selectedToken),p=e.get(0),u.val(""),b()}function w(e,t){e.removeClass(l.classes.selectedToken),p=null,t===S?f--:t===I?f++:f=r,u.focus()}function P(e){var t=j.data(e.get(0),"tokeninput"),n=l.onDelete,a=e.prevAll().length;f<a&&a--,e.remove(),p=null,u.focus(),s=s.slice(0,a).concat(s.slice(a+1)),a<f&&f--;var o=j.map(s,function(e){return e.id});d.val(o.join(l.tokenDelimiter)),--r,null!==l.tokenLimit&&u.show().val("").focus(),j.isFunction(n)&&n.call(d,t),u.change()}function b(){T.hide(),h&&j(h).removeClass(l.classes.selectedToken),h=null}function A(){T.css({position:"absolute"}).css("z-index",999).show()}function L(s,e){var r;e&&e.length?(T.empty(),r=j("<ul>").attr({"aria-activedescendant":"ui-active-menuitem",role:"listbox"}).appendTo(T).mouseover(function(e){x(j(e.target).closest("li"))}).mousedown(function(e){return y(j(e.target).closest("li")),!1}).hide(),j.each(e,function(e,t){var n,a,o,i=j('<li role="option">'+(n=O(t.name),a=s,o=n,j.each(a.split(" "),function(e,t){t&&(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"),o=o.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"))}),o)+"</li>").appendTo(r);e%2?i.addClass(l.classes.dropdownItem):i.addClass(l.classes.dropdownItem2),0===e&&(m=i),j.data(i.get(0),"tokeninput",{id:t.id,name:t.name})}),A(),l.animateDropdown?r.slideDown("fast"):r.show()):l.noResultsText&&(T.html("<p class='notice'>"+l.noResultsText+"</p>"),A())}function x(e){e&&(h&&R(j(h)),e.addClass(l.classes.selectedDropdownItem),h=e.get(0))}function R(e){e.removeClass(l.classes.selectedDropdownItem),h=null}function O(e){return l.escapeHTML?j("<p></p>").text(e).html():e}function N(){var e=u.val().toLowerCase();(e&&e.length||0==l.minChars)&&(h&&R(j(h)),p&&w(j(p),I),0==l.minChars||e.length>=l.minChars?(l.searchingText&&(T.html("<p class='notice'>"+l.searchingText+"</p>"),A()),clearTimeout(n),n=setTimeout(function(){!function(e){{var t;l.noCache||(t=o.get(e))}!l.noCache&&t?L(e,t):function(t){{var e;l.url?function(t){var i={data:{}};{var e,n;-1<l.url.indexOf("?")?(e=l.url.split("?"),i.url=e[0],n=e[1].split("&"),j.each(n,function(e,t){var n=t.split("=");i.data[n[0]]=n[1]})):i.url=l.url}{var a;l.liveParams&&(a=l.liveParams.split("&"),j.each(a,function(e,t){var n=t.split("="),a="#"+n[1]+" input";0===j(a).size()?a="#"+n[1]:a+=":checked";var o=j(a).map(function(e,t){return j(t).val()}).get();o&&(i.data[n[0]]=o)}))}i.data[l.queryParam]=t,i.type=l.method,i.dataType=l.contentType,l.crossDomain&&(i.dataType="jsonp");i.success=function(e){j.isFunction(l.onResult)&&(e=l.onResult.call(d,e)),l.noCache||o.add(t,l.jsonContainer?e[l.jsonContainer]:e),u.val().toLowerCase()===t&&u.is(":focus")&&L(t,l.jsonContainer?e[l.jsonContainer]:e)},j.ajax(i)}(t):l.local_data&&(e=j.grep(l.local_data,function(e){return-1<e.name.toLowerCase().indexOf(t.toLowerCase())}),j.isFunction(l.onResult)&&(e=l.onResult.call(d,e)),o.add(t,e),L(t,e))}}(e)}(e)},l.searchDelay)):b())}l.processPrePopulate&&j.isFunction(l.onResult)&&(E=l.onResult.call(d,E)),j(e).val(""),d.val(""),u.val(""),E&&E.length&&("string"==typeof E?C(E,E):j.each(E,function(e,t){C(t.id,t.name)})),null!==l.tokenLimit&&r>=l.tokenLimit&&u.hide(),l.liveParams&&(k=l.liveParams.split("&"),j.each(k,function(e,t){var n=t.split("="),a="#"+n[1]+" input";0===j(a).size()&&(a="#"+n[1]),j(a).each(function(e,t){j(t).hasClass("autocomplete")&&(t=j(t).prev().find("input").first()),j(t).change(function(e){o.clear_data()})})}))},j.TokenList.Cache=function(e){function n(){o={},i=0}var a=j.extend({max_size:500},e),o={},i=0;this.clear_data=function(){n()},this.add=function(e,t){i>a.max_size&&n(),o[e]||(i+=1),o[e]=t},this.get=function(e){return o[e]}}}(jQuery);
