!function(e){var t={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1},n={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"},a={BEFORE:0,AFTER:1,END:2},o={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188};e.fn.tokenInput=function(n,a){var o=e.extend({},t,a||{});return this.each(function(){new e.TokenList(this,n,o)})},e.TokenList=function(t,i,s){function l(t,n){if(n.indexOf(s.tokenDelimiter)>=0)return void e.each(n.split(s.tokenDelimiter),function(e,t){l(t,t)});var a=e("<li>"+D(n)+" </li>").addClass(s.classes.token).insertBefore(U);s.makeSortable;var o=e("<span></span>").addClass(s.classes.tokenDelete).appendTo(a).click(function(){return p(e(this).parent()),!1});e('<a href="#">'+s.deleteText+"</a>").attr("title","remove "+n).appendTo(o);var i={id:t,name:n};e.data(a.get(0),"tokeninput",i),A=A.slice(0,B).concat([i]).concat(A.slice(B)),B++;var r=e.map(A,function(e){return e.id});return _.val(r.join(s.tokenDelimiter)),R+=1,a}function r(t){var n;n="string"===e.type(t)?{id:t,name:t}:e.data(t.get(0),"tokeninput"),O.val("");var a=s.onAdd;if(R>0&&s.preventDuplicates){var o=null;if(M.children().each(function(){var t=e(this),a=e.data(t.get(0),"tokeninput");return a&&a.id===n.id?(o=t,!1):void 0}),o)return u(o),void O.focus()}l(n.id,n.name),null!==s.tokenLimit&&R>=s.tokenLimit?(O.parent().prev("li").find("a").focus(),O.hide()):O.focus(),h(),e.isFunction(a)&&a.call(_,n),O.change()}function c(t){h();var n=e.data(t.get(0),"tokeninput");p(t),O.val(n.id)}function u(e){e.addClass(s.classes.selectedToken),j=e.get(0),O.val(""),h()}function d(e,t){e.removeClass(s.classes.selectedToken),j=null,t===a.BEFORE?B--:t===a.AFTER?B++:B=R,O.focus()}function f(t){var n=j;if(j){if(j===t.get(0))return void c(t);d(e(j),a.END)}n===t.get(0)?d(t,a.END):u(t)}function p(t){var n=e.data(t.get(0),"tokeninput"),a=s.onDelete,o=t.prevAll().length;o>B&&o--,t.remove(),j=null,O.focus(),A=A.slice(0,o).concat(A.slice(o+1)),B>o&&B--;var i=e.map(A,function(e){return e.id});_.val(i.join(s.tokenDelimiter)),R-=1,null!==s.tokenLimit&&O.show().val("").focus(),e.isFunction(a)&&a.call(_,n),O.change()}function h(){G.hide(),I&&e(I).removeClass(s.classes.selectedToken),I=null}function m(){G.css({position:"absolute"}).css("z-index",999).show()}function v(){s.searchingText&&(G.html("<p class='notice'>"+s.searchingText+"</p>"),m())}function k(){s.hintText&&(G.html("<p class='notice'>"+s.hintText+"</p>"),m())}function T(t,n){var a=t;return e.each(n.split(" "),function(e,t){t&&(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"),a=a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"))}),a}function g(t,n){if(n&&n.length){G.empty();var a=e('<ul role="listbox" aria-activedescendant="ui-active-menuitem">').appendTo(G).mouseover(function(t){C(e(t.target).closest("li"))}).mousedown(function(t){return r(e(t.target).closest("li")),!1}).hide();e.each(n,function(n,o){var i=e('<li role="option">'+T(D(o.name),t)+"</li>").appendTo(a);n%2?i.addClass(s.classes.dropdownItem):i.addClass(s.classes.dropdownItem2),0===n&&(S=i),e.data(i.get(0),"tokeninput",{id:o.id,name:o.name})}),m(),s.animateDropdown?a.slideDown("fast"):a.show()}else s.noResultsText&&(G.html("<p class='notice'>"+s.noResultsText+"</p>"),m())}function C(t){t&&(I&&E(e(I)),t.addClass(s.classes.selectedDropdownItem),I=t.get(0))}function E(e){e.removeClass(s.classes.selectedDropdownItem),I=null}function D(t){return s.escapeHTML?e("<p></p>").text(t).html():t}function x(){var t=O.val().toLowerCase();(t&&t.length||0==s.minChars)&&(I&&E(e(I)),j&&d(e(j),a.AFTER),0==s.minChars||t.length>=s.minChars?(v(),clearTimeout(P),P=setTimeout(function(){y(t)},s.searchDelay)):h())}function y(e){if(!s.noCache)var t=b.get(e);!s.noCache&&t?g(e,t):L(e)}function L(t){if(s.url)w(t);else if(s.local_data){var n=e.grep(s.local_data,function(e){return e.name.toLowerCase().indexOf(t.toLowerCase())>-1});e.isFunction(s.onResult)&&(n=s.onResult.call(_,n)),b.add(t,n),g(t,n)}}function w(t){var n={};if(n.data={},s.url.indexOf("?")>-1){var a=s.url.split("?");n.url=a[0];var o=a[1].split("&");e.each(o,function(e,t){var a=t.split("=");n.data[a[0]]=a[1]})}else n.url=s.url;if(s.liveParams){var i=s.liveParams.split("&");e.each(i,function(t,a){var o=a.split("="),i="#"+o[1]+" input";0===e(i).size()?i="#"+o[1]:i+=":checked";var s=e(i).map(function(t,n){return e(n).val()}).get();s&&(n.data[o[0]]=s)})}n.data[s.queryParam]=t,n.type=s.method,n.dataType=s.contentType,s.crossDomain&&(n.dataType="jsonp"),n.success=function(n){e.isFunction(s.onResult)&&(n=s.onResult.call(_,n)),s.noCache||b.add(t,s.jsonContainer?n[s.jsonContainer]:n),O.val().toLowerCase()===t&&O.is(":focus")&&g(t,s.jsonContainer?n[s.jsonContainer]:n)},e.ajax(n)}"string"==typeof i?(s.url=i,void 0===s.crossDomain&&(-1===s.url.indexOf("://")?s.crossDomain=!1:s.crossDomain=location.href.split(/\/+/g)[1]!==s.url.split(/\/+/g)[1])):"object"==typeof i&&(s.local_data=i),s.classes?s.classes=e.extend({},n,s.classes):s.theme?(s.classes={},e.each(n,function(e,t){s.classes[e]=t+"-"+s.theme})):s.classes=n;var P,A=[],R=0,b=new e.TokenList.Cache,F=e(t).attr("id"),N=e('label[for="'+F+'"]');N.attr({"for":F+"_autocomplete"});var O=e('<input type="text" class="text" autocomplete="off" role="combobox" aria-expanded="true" aria-autocomplete="list">').attr({id:F+"_autocomplete"}).focus(function(){(null===s.tokenLimit||R<s.tokenLimit)&&(e(this).val().length>=s.minChars?setTimeout(function(){x()},5):k())}).blur(function(){h()}).keydown(function(t){var n,i;switch(t.keyCode){case o.LEFT:case o.RIGHT:case o.UP:case o.DOWN:if(S&&!S.is(":hidden")){if(t.keyCode===o.LEFT||t.keyCode===o.RIGHT)return!0;var l=null;return l=I?t.keyCode===o.DOWN?e(I).next():e(I).prev():S,l.length?(C(l),e(G).scrollTo(e(l))):t.keyCode===o.UP&&I&&E(e(I)),!1}j?(n=e(j).prev(),i=e(j).next(),t.keyCode===o.LEFT||t.keyCode===o.UP?d(e(j),a.BEFORE):d(e(j),a.AFTER)):(n=U.prev(),i=U.next()),t.keyCode!==o.LEFT&&t.keyCode!==o.UP||!n.length?t.keyCode!==o.RIGHT&&t.keyCode!==o.DOWN||!i.length||u(e(i.get(0))):u(e(n.get(0)));break;case o.BACKSPACE:case o.DELETE:if(n=U.prev(),!e(this).val().length)return j?p(e(j)):n.length&&u(e(n.get(0))),!1;1===e(this).val().length?h():setTimeout(function(){x()},5);break;case o.COMMA:case o.TAB:case o.ENTER:case o.NUMPAD_ENTER:if(I){if(r(e(I)),E(e(I)),h(),t.keyCode===o.TAB&&s.tokenLimit&&s.tokenLimit===R)break;return!1}if(O.val()){if(e.each(O.val().split(s.tokenDelimiter),function(t,n){r(e.trim(n))}),h(),t.keyCode===o.TAB&&s.tokenLimit&&s.tokenLimit===R)break;return!1}break;case o.ESCAPE:return h(),!0;default:String.fromCharCode(t.which)&&setTimeout(function(){x()},5)}});e(t).closest("form").submit(function(){O.val()&&e.each(O.val().split(s.tokenDelimiter),function(t,n){r(e.trim(n))})});var _=e(t).hide().focus(function(){O.focus()}).blur(function(){O.blur()}),j=null,B=0,I=null,S=null,M=e("<ul />").addClass(s.classes.tokenList).click(function(t){var n=e(t.target).closest("li");n&&n.get(0)&&e.data(n.get(0),"tokeninput")?f(n):(j&&d(e(j),a.END),O.focus())}).mouseover(function(t){var n=e(t.target).closest("li");n&&j!==this&&n.addClass(s.classes.highlightedToken)}).mouseout(function(t){var n=e(t.target).closest("li");n&&j!==this&&n.removeClass(s.classes.highlightedToken)}).insertBefore(_);s.makeSortable&&M.addClass(s.classes.sortable);var U=e("<li />").addClass(s.classes.inputToken).appendTo(M).append(O),G=e("<div>").addClass(s.classes.dropdown).insertAfter(O).hide(),H=e(t).val()||s.prePopulate;if(s.processPrePopulate&&e.isFunction(s.onResult)&&(H=s.onResult.call(_,H)),e(t).val(""),_.val(""),O.val(""),H&&H.length&&("string"==typeof H?l(H,H):e.each(H,function(e,t){l(t.id,t.name)})),null!==s.tokenLimit&&R>=s.tokenLimit&&O.hide(),s.liveParams){var z=s.liveParams.split("&");e.each(z,function(t,n){var a=n.split("="),o="#"+a[1]+" input";0===e(o).size()&&(o="#"+a[1]),e(o).each(function(t,n){e(n).hasClass("autocomplete")&&(n=e(n).prev().find("input").first()),e(n).change(function(e){b.clear_data()})})})}},e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t),a={},o=0,i=function(){a={},o=0};this.clear_data=function(){i()},this.add=function(e,t){o>n.max_size&&i(),a[e]||(o+=1),a[e]=t},this.get=function(e){return a[e]}}}(jQuery);