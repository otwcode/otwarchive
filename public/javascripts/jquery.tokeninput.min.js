!function(_){var e,j,t,n,a,o={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,makeSortable:!1,escapeHTML:!0,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,noCache:!1},U={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"},S=0,I=1,M=2;KeyboardEvent.prototype.hasOwnProperty("key")?(e=!0,j={BACKSPACE:"Backspace",TAB:"Tab",ENTER:"Enter",ESCAPE:"Escape",SPACE:" ",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",END:"End",HOME:"Home",LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",DOWN:"ArrowDown",DELETE:"Delete",NUMPAD_ENTER:"Enter",COMMA:","}):(j={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188},Object.defineProperty(KeyboardEvent.prototype,"key",{configurable:!0,enumerable:!0,get:function(){return this.keyCode}})),e&&(t=KeyboardEvent.prototype,n=Object.getOwnPropertyDescriptor(t,"key"),a={Spacebar:" ",Esc:"Escape",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete"},Object.defineProperty(t,"key",{configurable:!0,enumerable:!0,get:function(){var e=n.get.call(this);return a.hasOwnProperty(e)?a[e]:e}})),_.fn.tokenInput=function(e,t){var n=_.extend({},o,t||{});return this.each(function(){new _.TokenList(this,e,n)})},_.TokenList=function(e,t,l){"string"==typeof t?(l.url=t,void 0===l.crossDomain&&(-1===l.url.indexOf("://")?l.crossDomain=!1:l.crossDomain=location.href.split(/\/+/g)[1]!==l.url.split(/\/+/g)[1])):"object"==typeof t&&(l.local_data=t),l.classes?l.classes=_.extend({},U,l.classes):l.theme?(l.classes={},_.each(U,function(e,t){l.classes[e]=t+"-"+l.theme})):l.classes=U;var n,s=[],r=0,o=new _.TokenList.Cache,a=_(e).attr("id"),i=_('label[for="'+a+'"]'),c=_(e).attr("aria-describedby");i.attr({for:a+"_autocomplete"});var u=_("<input>").attr({"aria-autocomplete":"list","aria-expanded":"true",autocomplete:"off",class:"text",id:a+"_autocomplete",role:"combobox",type:"text"}).attr("aria-describedby",function(){if(c)return c}).focus(function(){(null===l.tokenLimit||r<l.tokenLimit)&&(_(this).val().length>=l.minChars?setTimeout(function(){N()},5):l.hintText&&(T.html("<p class='notice'>"+l.hintText+"</p>"),A()))}).blur(function(){b()}).keydown(function(e){var t,n;switch(e.key){case j.LEFT:case j.RIGHT:case j.UP:case j.DOWN:if(m&&!m.is(":hidden")){if(e.key===j.LEFT||e.key===j.RIGHT)return!0;var a=null;return(a=h?e.key===j.DOWN?_(h).next():_(h).prev():m).length?(x(a),_(T).scrollTo(_(a))):e.key===j.UP&&h&&R(_(h)),!1}p?(t=_(p).prev(),n=_(p).next(),e.key===j.LEFT||e.key===j.UP?w(_(p),S):w(_(p),I)):(t=g.prev(),n=g.next()),e.key!==j.LEFT&&e.key!==j.UP||!t.length?e.key!==j.RIGHT&&e.key!==j.DOWN||!n.length||D(_(n.get(0))):D(_(t.get(0)));break;case j.BACKSPACE:case j.DELETE:if(t=g.prev(),!_(this).val().length)return p?P(_(p)):t.length&&D(_(t.get(0))),!1;1===_(this).val().length?b():setTimeout(function(){N()},25);break;case j.COMMA:case j.TAB:case j.ENTER:case j.NUMPAD_ENTER:if(h){if(y(_(h)),R(_(h)),b(),e.keyCode===j.TAB&&l.tokenLimit&&l.tokenLimit===r)break;return!1}if(u.val()){if(_.each(u.val().split(l.tokenDelimiter),function(e,t){y(_.trim(t))}),b(),e.keyCode===j.TAB&&l.tokenLimit&&l.tokenLimit===r)break;return!1}break;case j.ESCAPE:return b(),!0;default:String.fromCharCode(e.which)&&setTimeout(function(){N()},25)}});_(e).closest("form").submit(function(){u.val()&&_.each(u.val().split(l.tokenDelimiter),function(e,t){y(_.trim(t))})});var d=_(e).hide().focus(function(){u.focus()}).blur(function(){u.blur()}),p=null,f=0,h=null,m=null,v=_("<ul />").addClass(l.classes.tokenList).click(function(e){var t=_(e.target).closest("li");t&&t.get(0)&&_.data(t.get(0),"tokeninput")?function(e){var t=p;if(p){if(p===e.get(0))return function(e){b();var t=_.data(e.get(0),"tokeninput");P(e),u.val(t.id)}(e);w(_(p),M)}t===e.get(0)?w(e,M):D(e)}(t):(p&&w(_(p),M),u.focus())}).mouseover(function(e){var t=_(e.target).closest("li");t&&p!==this&&t.addClass(l.classes.highlightedToken)}).mouseout(function(e){var t=_(e.target).closest("li");t&&p!==this&&t.removeClass(l.classes.highlightedToken)}).insertBefore(d);l.makeSortable&&v.addClass(l.classes.sortable);var k,g=_("<li />").addClass(l.classes.inputToken).appendTo(v).append(u),T=_("<div>").addClass(l.classes.dropdown).insertAfter(u).hide(),E=_(e).val()||l.prePopulate;function C(e,t){if(!(0<=t.indexOf(l.tokenDelimiter))){var n=_("<li>"+O(t)+" </li>").addClass(l.classes.token).insertBefore(g);l.makeSortable;var a=_("<span></span>").addClass(l.classes.tokenDelete).appendTo(n).click(function(){return P(_(this).parent()),!1});_('<a href="#">'+l.deleteText+"</a>").attr("title","remove "+t).appendTo(a);var o={id:e,name:t};_.data(n.get(0),"tokeninput",o),s=s.slice(0,f).concat([o]).concat(s.slice(f)),f++;var i=_.map(s,function(e){return e.id});return d.val(i.join(l.tokenDelimiter)),r+=1,n}_.each(t.split(l.tokenDelimiter),function(e,t){C(t,t)})}function y(e){var n="string"===_.type(e)?{id:e,name:e}:_.data(e.get(0),"tokeninput");u.val("");var t=l.onAdd;if(0<r&&l.preventDuplicates){var a=null;if(v.children().each(function(){var e=_(this),t=_.data(e.get(0),"tokeninput");if(t&&t.id===n.id)return a=e,!1}),a)return D(a),void u.focus()}C(n.id,n.name),null!==l.tokenLimit&&r>=l.tokenLimit?(u.parent().prev("li").find("a").focus(),u.hide()):u.focus(),b(),_.isFunction(t)&&t.call(d,n),u.change()}function D(e){e.addClass(l.classes.selectedToken),p=e.get(0),u.val(""),b()}function w(e,t){e.removeClass(l.classes.selectedToken),p=null,t===S?f--:t===I?f++:f=r,u.focus()}function P(e){var t=_.data(e.get(0),"tokeninput"),n=l.onDelete,a=e.prevAll().length;f<a&&a--,e.remove(),p=null,u.focus(),s=s.slice(0,a).concat(s.slice(a+1)),a<f&&f--;var o=_.map(s,function(e){return e.id});d.val(o.join(l.tokenDelimiter)),--r,null!==l.tokenLimit&&u.show().val("").focus(),_.isFunction(n)&&n.call(d,t),u.change()}function b(){T.hide(),h&&_(h).removeClass(l.classes.selectedToken),h=null}function A(){T.css({position:"absolute"}).css("z-index",999).show()}function L(s,e){var r;e&&e.length?(T.empty(),r=_("<ul>").attr({"aria-activedescendant":"ui-active-menuitem",role:"listbox"}).appendTo(T).mouseover(function(e){x(_(e.target).closest("li"))}).mousedown(function(e){return y(_(e.target).closest("li")),!1}).hide(),_.each(e,function(e,t){var n,a,o,i=_('<li role="option">'+(n=O(t.name),a=s,o=n,_.each(a.split(" "),function(e,t){t&&(t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"),o=o.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"))}),o)+"</li>").appendTo(r);e%2?i.addClass(l.classes.dropdownItem):i.addClass(l.classes.dropdownItem2),0===e&&(m=i),_.data(i.get(0),"tokeninput",{id:t.id,name:t.name})}),A(),l.animateDropdown?r.slideDown("fast"):r.show()):l.noResultsText&&(T.html("<p class='notice'>"+l.noResultsText+"</p>"),A())}function x(e){e&&(h&&R(_(h)),e.addClass(l.classes.selectedDropdownItem),h=e.get(0))}function R(e){e.removeClass(l.classes.selectedDropdownItem),h=null}function O(e){return l.escapeHTML?_("<p></p>").text(e).html():e}function N(){var e=u.val().toLowerCase();(e&&e.length||0==l.minChars)&&(h&&R(_(h)),p&&w(_(p),I),0==l.minChars||e.length>=l.minChars?(l.searchingText&&(T.html("<p class='notice'>"+l.searchingText+"</p>"),A()),clearTimeout(n),n=setTimeout(function(){!function(e){{var t;l.noCache||(t=o.get(e))}!l.noCache&&t?L(e,t):function(t){{var e;l.url?function(t){var i={data:{}};{var e,n;-1<l.url.indexOf("?")?(e=l.url.split("?"),i.url=e[0],n=e[1].split("&"),_.each(n,function(e,t){var n=t.split("=");i.data[n[0]]=n[1]})):i.url=l.url}{var a;l.liveParams&&(a=l.liveParams.split("&"),_.each(a,function(e,t){var n=t.split("="),a="#"+n[1]+" input";0===_(a).size()?a="#"+n[1]:a+=":checked";var o=_(a).map(function(e,t){return _(t).val()}).get();o&&(i.data[n[0]]=o)}))}i.data[l.queryParam]=t,i.type=l.method,i.dataType=l.contentType,l.crossDomain&&(i.dataType="jsonp");i.success=function(e){_.isFunction(l.onResult)&&(e=l.onResult.call(d,e)),l.noCache||o.add(t,l.jsonContainer?e[l.jsonContainer]:e),u.val().toLowerCase()===t&&u.is(":focus")&&L(t,l.jsonContainer?e[l.jsonContainer]:e)},_.ajax(i)}(t):l.local_data&&(e=_.grep(l.local_data,function(e){return-1<e.name.toLowerCase().indexOf(t.toLowerCase())}),_.isFunction(l.onResult)&&(e=l.onResult.call(d,e)),o.add(t,e),L(t,e))}}(e)}(e)},l.searchDelay)):b())}l.processPrePopulate&&_.isFunction(l.onResult)&&(E=l.onResult.call(d,E)),_(e).val(""),d.val(""),u.val(""),E&&E.length&&("string"==typeof E?C(E,E):_.each(E,function(e,t){C(t.id,t.name)})),null!==l.tokenLimit&&r>=l.tokenLimit&&u.hide(),l.liveParams&&(k=l.liveParams.split("&"),_.each(k,function(e,t){var n=t.split("="),a="#"+n[1]+" input";0===_(a).size()&&(a="#"+n[1]),_(a).each(function(e,t){_(t).hasClass("autocomplete")&&(t=_(t).prev().find("input").first()),_(t).change(function(e){o.clear_data()})})}))},_.TokenList.Cache=function(e){function n(){o={},i=0}var a=_.extend({max_size:500},e),o={},i=0;this.clear_data=function(){n()},this.add=function(e,t){i>a.max_size&&n(),o[e]||(i+=1),o[e]=t},this.get=function(e){return o[e]}}}(jQuery);
