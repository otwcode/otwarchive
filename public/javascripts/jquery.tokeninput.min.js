(function(e){var t={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:500,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:false,prePopulate:null,processPrePopulate:false,makeSortable:false,escapeHTML:true,animateDropdown:true,onResult:null,onAdd:null,onDelete:null,noCache:false};var n={tokenList:"autocomplete",sortable:"sortable",token:"added tag",tokenDelete:"delete",selectedToken:"selected",highlightedToken:"highlighted",dropdown:"autocomplete dropdown",dropdownItem:"even",dropdownItem2:"odd",selectedDropdownItem:"selected",inputToken:"input",insertBefore:"selected",insertAfter:"selected"};var r={BEFORE:0,AFTER:1,END:2};var i={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46,NUMPAD_ENTER:108,COMMA:188};e.fn.tokenInput=function(n,r){var i=e.extend({},t,r||{});return this.each(function(){new e.TokenList(this,n,i)})};e.TokenList=function(t,s,o){function N(e){return e>=48&&e<=90||e>=96&&e<=111||e>=186&&e<=192||e>=219&&e<=222}function C(t,n){if(n.indexOf(o.tokenDelimiter)>=0){e.each(n.split(o.tokenDelimiter),function(e,t){C(t,t)});return}var r=e("<li>"+R(n)+" </li>").addClass(o.classes.token).insertBefore(E);if(o.makeSortable){}var i=e("<span></span>").addClass(o.classes.tokenDelete).appendTo(r).click(function(){_(e(this).parent());return false});e('<a href="#">'+o.deleteText+"</a>").attr("title","remove "+n).appendTo(i);var s={id:t,name:n};e.data(r.get(0),"tokeninput",s);u=u.slice(0,g).concat([s]).concat(u.slice(g));g++;var f=e.map(u,function(e){return e.id});v.val(f.join(o.tokenDelimiter));a+=1;return r}function k(t){var n;if(e.type(t)==="string"){n={id:t,name:t}}else{n=e.data(t.get(0),"tokeninput")}d.val("");var r=o.onAdd;if(a>0&&o.preventDuplicates){var i=null;w.children().each(function(){var t=e(this);var r=e.data(t.get(0),"tokeninput");if(r&&r.id===n.id){i=t;return false}});if(i){A(i);d.focus();return}}C(n.id,n.name);if(o.tokenLimit!==null&&a>=o.tokenLimit){d.hide()}else{d.focus()}D();if(e.isFunction(r)){r.call(v,n)}d.change()}function L(t){D();var n=e.data(t.get(0),"tokeninput");_(t);d.val(n.id)}function A(e){e.addClass(o.classes.selectedToken);m=e.get(0);d.val("");D()}function O(e,t){e.removeClass(o.classes.selectedToken);m=null;if(t===r.BEFORE){g--}else if(t===r.AFTER){g++}else{g=a}d.focus()}function M(t){var n=m;if(m){if(m===t.get(0)){L(t);return}O(e(m),r.END)}if(n===t.get(0)){O(t,r.END)}else{A(t)}}function _(t){var n=e.data(t.get(0),"tokeninput");var r=o.onDelete;var i=t.prevAll().length;if(i>g)i--;t.remove();m=null;d.focus();u=u.slice(0,i).concat(u.slice(i+1));if(i<g)g--;var s=e.map(u,function(e){return e.id});v.val(s.join(o.tokenDelimiter));a-=1;if(o.tokenLimit!==null){d.show().val("").focus()}if(e.isFunction(r)){r.call(v,n)}d.change()}function D(){S.hide();if(y){e(y).removeClass(o.classes.selectedToken)}y=null}function P(){S.css({position:"absolute"}).css("z-index",999).show()}function H(){if(o.searchingText){S.html("<p class='notice'>"+o.searchingText+"</p>");P()}}function B(){if(o.hintText){S.html("<p class='notice'>"+o.hintText+"</p>");P()}}function j(t,n){var r=t;e.each(n.split(" "),function(e,t){t=t.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1");r=r.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")});return r}function F(t,n){if(n&&n.length){S.empty();var r=e('<ul role="listbox" aria-activedescendant="ui-active-menuitem">').appendTo(S).mouseover(function(t){I(e(t.target).closest("li"))}).mousedown(function(t){k(e(t.target).closest("li"));return false}).hide();e.each(n,function(n,i){var s=e('<li role="option">'+j(R(i.name),t)+"</li>").appendTo(r);if(n%2){s.addClass(o.classes.dropdownItem)}else{s.addClass(o.classes.dropdownItem2)}if(n===0){b=s}e.data(s.get(0),"tokeninput",{id:i.id,name:i.name})});P();if(o.animateDropdown){r.slideDown("fast")}else{r.show()}}else{if(o.noResultsText){S.html("<p class='notice'>"+o.noResultsText+"</p>");P()}}}function I(t){if(t){if(y){q(e(y))}t.addClass(o.classes.selectedDropdownItem);y=t.get(0)}}function q(e){e.removeClass(o.classes.selectedDropdownItem);y=null}function R(t){if(!o.escapeHTML)return t;return e("<p></p>").text(t).html()}function U(){var t=d.val().toLowerCase();if(t&&t.length||o.minChars==0){if(y){q(e(y))}if(m){O(e(m),r.AFTER)}if(o.minChars==0||t.length>=o.minChars){H();clearTimeout(l);l=setTimeout(function(){z(t)},o.searchDelay)}else{D()}}}function z(e){if(!o.noCache){var t=f.get(e)}if(!o.noCache&&t){F(e,t)}else{W(e)}}function W(t){if(o.url){X(t)}else if(o.local_data){var n=e.grep(o.local_data,function(e){return e.name.toLowerCase().indexOf(t.toLowerCase())>-1});if(e.isFunction(o.onResult)){n=o.onResult.call(v,n)}f.add(t,n);F(t,n)}}function X(t){var n={};n.data={};if(o.url.indexOf("?")>-1){var r=o.url.split("?");n.url=r[0];var i=r[1].split("&");e.each(i,function(e,t){var r=t.split("=");n.data[r[0]]=r[1]})}else{n.url=o.url}if(o.liveParams){var s=o.liveParams.split("&");e.each(s,function(t,r){var i=r.split("=");var s="#"+i[1]+" input";if(e(s).size()===0){s="#"+i[1]}else{s+=":checked"}var o=e(s).map(function(t,n){return e(n).val()}).get();if(o){n.data[i[0]]=o}})}n.data[o.queryParam]=t;n.type=o.method;n.dataType=o.contentType;if(o.crossDomain){n.dataType="jsonp"}n.success=function(n){if(e.isFunction(o.onResult)){n=o.onResult.call(v,n)}if(!o.noCache){f.add(t,o.jsonContainer?n[o.jsonContainer]:n)}if(d.val().toLowerCase()===t&&d.is(":focus")){F(t,o.jsonContainer?n[o.jsonContainer]:n)}};e.ajax(n)}if(typeof s==="string"){o.url=s;if(o.crossDomain===undefined){if(o.url.indexOf("://")===-1){o.crossDomain=false}else{o.crossDomain=location.href.split(/\/+/g)[1]!==o.url.split(/\/+/g)[1]}}}else if(typeof s==="object"){o.local_data=s}if(o.classes){o.classes=e.extend({},n,o.classes)}else if(o.theme){o.classes={};e.each(n,function(e,t){o.classes[e]=t+"-"+o.theme})}else{o.classes=n}var u=[];var a=0;var f=new e.TokenList.Cache;var l;var c;var h=e(t).attr("id");var p=e('label[for="'+h+'"]');p.attr({"for":h+"_autocomplete"});var d=e('<input type="text" class="text" autocomplete="off" role="combobox" aria-expanded="true" aria-autocomplete="list">').attr({id:h+"_autocomplete"}).focus(function(){if(o.tokenLimit===null||a<o.tokenLimit){if(e(this).val().length>=o.minChars){setTimeout(function(){U()},5)}else{B()}}}).blur(function(){D()}).keydown(function(t){var n;var s;switch(t.keyCode){case i.LEFT:case i.RIGHT:case i.UP:case i.DOWN:if(!b||b.is(":hidden")){if(m){n=e(m).prev();s=e(m).next();if(t.keyCode===i.LEFT||t.keyCode===i.UP){O(e(m),r.BEFORE)}else{O(e(m),r.AFTER)}}else{n=E.prev();s=E.next()}if((t.keyCode===i.LEFT||t.keyCode===i.UP)&&n.length){A(e(n.get(0)))}else if((t.keyCode===i.RIGHT||t.keyCode===i.DOWN)&&s.length){A(e(s.get(0)))}}else if(t.keyCode===i.LEFT||t.keyCode===i.RIGHT){return true}else{var u=null;if(!y){u=b}else if(t.keyCode===i.DOWN){u=e(y).next()}else{u=e(y).prev()}if(u.length){I(u);e(S).scrollTo(e(u))}else if(t.keyCode===i.UP){if(y){q(e(y))}}return false}break;case i.BACKSPACE:case i.DELETE:n=E.prev();if(!e(this).val().length){if(m){_(e(m))}else if(n.length){A(e(n.get(0)))}return false}else if(e(this).val().length===1){D()}else{setTimeout(function(){U()},5)}break;case i.COMMA:case i.TAB:case i.ENTER:case i.NUMPAD_ENTER:if(y){k(e(y));q(e(y));D();if(t.keyCode===i.TAB&&o.tokenLimit&&o.tokenLimit===a){break}else{return false}}else if(d.val()){e.each(d.val().split(o.tokenDelimiter),function(t,n){k(e.trim(n))});D();if(t.keyCode===i.TAB&&o.tokenLimit&&o.tokenLimit===a){break}else{return false}}break;case i.ESCAPE:D();return true;default:if(String.fromCharCode(t.which)){setTimeout(function(){U()},5)}break}});e(t).closest("form").submit(function(){if(d.val()){e.each(d.val().split(o.tokenDelimiter),function(t,n){k(e.trim(n))})}});var v=e(t).hide().focus(function(){d.focus()}).blur(function(){d.blur()});var m=null;var g=0;var y=null;var b=null;var w=e("<ul />").addClass(o.classes.tokenList).click(function(t){var n=e(t.target).closest("li");if(n&&n.get(0)&&e.data(n.get(0),"tokeninput")){M(n)}else{if(m){O(e(m),r.END)}d.focus()}}).mouseover(function(t){var n=e(t.target).closest("li");if(n&&m!==this){n.addClass(o.classes.highlightedToken)}}).mouseout(function(t){var n=e(t.target).closest("li");if(n&&m!==this){n.removeClass(o.classes.highlightedToken)}}).insertBefore(v);if(o.makeSortable){w.addClass(o.classes.sortable)}var E=e("<li />").addClass(o.classes.inputToken).appendTo(w).append(d);var S=e("<div>").addClass(o.classes.dropdown).insertAfter(d).hide();var x=e(t).val()||o.prePopulate;if(o.processPrePopulate&&e.isFunction(o.onResult)){x=o.onResult.call(v,x)}e(t).val("");v.val("");d.val("");if(x&&x.length){if(typeof x==="string"){C(x,x)}else{e.each(x,function(e,t){C(t.id,t.name)})}}if(o.tokenLimit!==null&&a>=o.tokenLimit){d.hide()}if(o.liveParams){var T=o.liveParams.split("&");e.each(T,function(t,n){var r=n.split("=");var i="#"+r[1]+" input";if(e(i).size()===0){i="#"+r[1]}e(i).each(function(t,n){if(e(n).hasClass("autocomplete")){n=e(n).prev().find("input").first()}e(n).change(function(e){f.clear_data()})})})}};e.TokenList.Cache=function(t){var n=e.extend({max_size:500},t);var r={};var i=0;var s=function(){r={};i=0};this.clear_data=function(){s()};this.add=function(e,t){if(i>n.max_size){s()}if(!r[e]){i+=1}r[e]=t};this.get=function(e){return r[e]}}})(jQuery)