<% content_for :message do %>
<% @seen = {} %>
<% @seen_summary = {} %>
<% @creations.each_with_index do |creation, index| %>
<% this_work = creation.respond_to?(:work) ? creation.work : creation %>
<%= batch_subscription_text_preface(creation) %>
<%= creation.is_a?(Work) ? work_url(this_work) : work_chapter_url(this_work, creation) %>

<%= creation_title_with_word_count(creation) %><% if creation.is_a?(Work) || (creation.pseuds.sort != this_work.pseuds.sort) %>
<%= creation_attribution_text(creation) %><% end %>

<% if !creation.summary.blank? && creation.is_a?(Chapter) %>
<%= metadata_label(t(".chapter_summary")) %><%= raw to_plain_text(sanitize_field(creation, :summary)) %>
<% end %>

<% unless @seen[this_work.id] %>
<% cache(["subscription-email-meta-txt", I18n.locale.to_s, this_work]) do %>
<%= render "work_info", work: this_work, suppress_summary: true %>
<% end %><% @seen[this_work.id] = true %><% end %>

<% unless @seen_summary[this_work.id] || this_work.summary.blank? %>
<%= metadata_label(Work.human_attribute_name("summary")) %>
    <%= raw to_plain_text(sanitize_field(this_work, :summary)) %><% @seen_summary[this_work.id] = true %><% end %><% if (index < @creations.length-1) %>

<%= text_divider %>

<% end %><% end %><% end %>

<% content_for :footer_note do %>
<%= t(".footer_note.text", subscription_name: @subscription.name, unsubscribe_url: polymorphic_url(@subscription.subscribable)) %>
<% end %>
