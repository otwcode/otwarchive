<% content_for :message do %>
<% @seen = {} %>
<% @seen_summary = {} %>
<% @creations.each_with_index do |creation, index| %>
<% this_work = creation.respond_to?(:work) ? creation.work : creation %>
<%= this_work.pseuds.map{|p| p.byline}.to_sentence.html_safe %> <%= t 'user_mailer.batch_subscription_notification.posted_a' %> <% if creation.is_a?(Work) then %><%= if this_work.backdate then t 'user_mailer.batch_subscription_notification.backdated' else t 'user_mailer.batch_subscription_notification.new' end %> <%= t 'user_mailer.batch_subscription_notification.work' %> <% else %> <%= t 'user_mailer.batch_subscription_notification.new_chapter_of' %> <%= this_work.title %> (<%= this_work.word_count %> words):<% chapter_title = (creation.chapter_header + (creation.title.blank? ? "" : ": #{creation.title}")).html_safe %><% end %>
<%= creation.is_a?(Work) ? work_url(this_work) : work_chapter_url(this_work, creation) %>

<%= creation.is_a?(Work) ? this_work.title.html_safe : chapter_title %> (<%= creation.word_count%> words)<% unless @seen[this_work.id] %>
by <%= this_work.pseuds.map{|p| text_pseud(p)}.to_sentence.html_safe %><% end %>

<% if !creation.summary.blank? && creation.is_a?(Chapter) %>
<%= t 'user_mailer.batch_subscription_notification.chapter_summary' %><%= raw to_plain_text(sanitize_field(creation, :summary)) %>
<% end %>

<% unless @seen[this_work.id] %>
<%= t 'user_mailer.chapters' %> <%= this_work.chapter_total_display %>
<%= t 'user_mailer.fandom' %> <%= this_work.fandoms.map{|f| f.name}.to_sentence.html_safe %>
<%= t 'user_mailer.rating' %> <%= this_work.rating_string %>
<%= t 'user_mailer.warning' %> <%= this_work.warning_string %>
<% if this_work.relationship_string && !this_work.relationship_string.blank? then %><%= t 'user_mailer.relationships' %> <%= this_work.relationship_string %><% end %>
<% if this_work.character_string && !this_work.character_string.blank? then %><%=t 'user_mailer.characters'%> <%= this_work.character_string %><% end %>
<% if this_work.freeform_string && !this_work.freeform_string.blank? %><%=t 'user_mailer.additional_tags'%> <%= this_work.freeform_string %><% end %>
<% if this_work.series.count > 0 %><%=t 'user_mailer.series'%> <%=raw to_plain_text(series_list_for_feeds(this_work)) %><% end %>
<% @seen[this_work.id] = true %><% end %>

<% unless @seen_summary[this_work.id] || this_work.summary.blank? %>
<%=t 'user_mailer.summary'%>
    <%= raw to_plain_text(sanitize_field(this_work, :summary)) %><% @seen_summary[this_work.id] = true %><% end %><% if (index < @creations.length-1) %>

<%= text_divider %>

<% end %><% end %><% end %>

<% content_for :footer_note do %>
<%=t 'user_mailer.batch_subscription_notification.text.footer', who: @subscription.name, url: polymorphic_url(@subscription.subscribable) %>
<% end %>
