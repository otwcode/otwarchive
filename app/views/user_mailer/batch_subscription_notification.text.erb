<% content_for :message do %>
<% @seen = {} %>
<% @seen_summary = {} %>
<% @creations.each_with_index do |creation, index| %>
<% this_work = creation.respond_to?(:work) ? creation.work : creation %>
<% pseud = this_work.pseuds.map{|p| p.name}.to_sentence %>
<% work_link =  work_url(this_work) %>
<% link = creation.is_a?(Work) ? work_link : work_chapter_url(this_work, creation) %>
  <% if creation.is_a?(Work) %>
      <%= if this_work.backdate then
            t('user_mailer.batch_subscription_notification.text.work_backdated', pseud: pseud )
          else
            t('user_mailer.batch_subscription_notification.text.work_new', pseud: pseud )
          end  %>
    <% else %>
      <% chapter_title = (creation.chapter_header + (creation.title.blank? ? "" : ": #{creation.title}")) %>
      <%= t 'user_mailer.batch_subscription_notification.text.new_chapter_of', work_link: link, word_count: this_work.word_count %>
    <% end %>
       <%=t('user_mailer.batch_subscription_notification.text.word_count', link: link, word_count: creation.word_count) %>
      <% unless @seen[this_work.id] %>
        <%=t('user_mailer.batch_subscription_notification.text.collected_by',  pseud: pseud ) %>
      <% end %>

<% unless @seen[this_work.id] %>
<%= t 'user_mailer.chapters' %> <%= this_work.chapter_total_display %>
<%= t 'user_mailer.fandom' %> <%= this_work.fandoms.map{|f| f.name}.to_sentence %>
<%= t 'user_mailer.rating' %> <%= this_work.rating_string %>
<%= t 'user_mailer.warning' %> <%= this_work.warning_string %>
<% if this_work.relationship_string && !this_work.relationship_string.blank? then %><%= t 'user_mailer.relationships' %> <%= this_work.relationship_string %><% end %>
<% if this_work.character_string && !this_work.character_string.blank? then %><%=t 'user_mailer.characters'%> <%= this_work.character_string %><% end %>
<% if this_work.freeform_string && !this_work.freeform_string.blank? %><%=t 'user_mailer.additional_tags'%> <%= this_work.freeform_string %><% end %>
<% if this_work.series.count > 0 %><%=t 'user_mailer.series'%> <%=raw to_plain_text(series_list_for_feeds(this_work)) %><% end %>
<% @seen[this_work.id] = true %><% end %>

<% unless @seen_summary[this_work.id] || this_work.summary.blank? %>
<%=t 'user_mailer.summary'%>
    <%= raw to_plain_text(sanitize_field(this_work, :summary)) %><% @seen_summary[this_work.id] = true %><% end %><% if (index < @creations.length-1) %>

<%= text_divider %>

<% end %><% end %><% end %>

<% content_for :footer_note do %>
<%=t 'user_mailer.batch_subscription_notification.text.footer', who: @subscription.name, url: polymorphic_url(@subscription.subscribable) %>
<% end %>
