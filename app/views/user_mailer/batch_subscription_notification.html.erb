<% content_for :message do %>
  <% @seen = {} %>
  <% @seen_summary = {} %>
  <% @creations.each_with_index do |creation, index| %>

    <% this_work = creation.respond_to?(:work) ? creation.work : creation %>
    <% creation_url = creation.is_a?(Work) ? work_url(this_work) : work_chapter_url(this_work, creation) %>

    <% cache("/subscription-email-preface-#{creation.cache_key}") do %>
      <p><%= batch_subscription_html_preface(creation) %></p>
    <% end %>

    <p>
      <%= creation_link_with_word_count(creation, creation_url) %><% unless @seen[this_work.id] %><br><%= creation_attribution_links(this_work) %><% end %>
    </p>

    <% if creation.summary.present? && creation.is_a?(Chapter) %>
      <p><%= style_work_metadata_label(t(".chapter_summary")) %></p>
      <%= style_quote(raw sanitize_field(creation, :summary)) %>
    <% end %>

    <% unless @seen[this_work.id] %>
      <% cache("/subscription-email-meta-#{creation.cache_key}") do %>
        <p><%= render "work_info", work: this_work, suppress_summary: true %></p>
      <% end %>

      <% @seen[this_work.id] = true %>
    <% end %>

    <% unless @seen_summary[this_work.id] || this_work.summary.blank? %>
      <p><%= style_work_metadata_label(Work.human_attribute_name("summary")) %></p>
      <%= style_quote(raw sanitize_field(this_work, :summary)) %>
      <% @seen_summary[this_work.id] = true %>
    <% end %>

    <% if (index < @creations.length-1) %>
      <%= styled_divider %>
    <% end %>

  <% end %>
<% end %>


<% content_for :footer_note do %>
  <%= t(".footer_note.html", subscription_link: style_footer_link(@subscription.name, polymorphic_url(@subscription.subscribable))) %>
<% end %>
