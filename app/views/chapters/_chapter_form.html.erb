<div id="work-form">
<%= form_for([@work, chapter]) do |f| %>

<fieldset id="chapter-ordering">
  <legend><%= ts("Naming, Ordering and Date") %></legend>
  <dl>
    <dt><%= f.label :title, ts("Chapter title") %></dt>
    <dd><p><%= f.text_field :title, :class => "storyinputfield", :live => true %>
    <%= link_to_help "chapter-title" %></p>
    <%= generate_countdown_html("chapter_title", ArchiveConfig.TITLE_MAX) %>
    </dd>
  
    <dt><%= f.label :position, ts("Chapter number") %></dt>
    <dd><p><%= f.text_field :position, :class => "number-field" %> 
    <%= f.label :wip_length, ts("of"), :title => ts("of total chapters") %> 
    <%= f.text_field :wip_length, :class => "number-field" %> 
    </p></dd>
    <dt id="managePublicationDate">
    <%= f.label :published_at, ts("Chapter publication date") %></dt>
    <dd><p><%= f.date_select "published_at", :start_year => Date.today.year, :end_year => 1950, :default => @work.default_date, :order => [:day, :month, :year] %>
    <%= link_to_help "backdating-help" %>
    </p></dd>
  </dl>
</fieldset>

<fieldset>
  <legend><%= ts("Chapter Preface") %></legend>
    <dl class="preface">      

      <%= render :partial => 'pseuds/byline', :locals =>{:form => f, :type => 'chapter'} %>

      <dt class="summary"><%= f.label :summary, ts("Chapter summary (max %{max} characters)", :max => ArchiveConfig.SUMMARY_MAX.to_s) %></dt>
      <dd class="summary">
        <%= f.text_area :summary, :rows => 4, :cols => 60, :live => true, :class => "observe_textlength" %>
        <%= generate_countdown_html("chapter_summary", ArchiveConfig.SUMMARY_MAX) %>
      </dd>
      
      <dt><%= ts("Add notes:") %></dt>
      <dd>
        <dl class="notes">
          <dt class="endnotes">
            <%= check_box_tag "front-notes-options-show", "1", !chapter.notes.blank?, :class => "toggle_formfield" %>
          </dt>
          <dd class="endnotes">
            <%= label_tag 'front-notes-options-show', ts("at the beginning") %>
            <span id="worknoteswarning" class="warning" <% if chapter.notes.blank? %> style="display: none" <% end %>>
            <%= ts("Warning: Unchecking this box will delete any existing beginning note.") %></span>
          </dd>
          <dd id="front-notes-options" class="work-endnotes optionalField">
            <dl>     
              <dt class="notes">
                <%= f.label :notes, ts("Chapter notes (max %{max} characters)", :max => ArchiveConfig.NOTES_MAX.to_s) %>
              </dt>
              <dd class="notes">
                <%= f.text_area :notes, :rows => 4, :cols => 60, :live => true, :class => "observe_textlength" %>
                <%= generate_countdown_html("chapter_notes", ArchiveConfig.NOTES_MAX) %>
              </dd>
            </dl>
          </dd>      
        
          <dt class="endnotes">
            <%= check_box_tag "end-notes-options-show", "1", !chapter.endnotes.blank?, :class => "toggle_formfield" %>
          </dt>
          <dd class="endnotes">
            <%= label_tag 'end-notes-options-show', ts("at the end") %>
            <span id="workendnoteswarning" class="warning" <% if chapter.endnotes.blank? %> style="display: none" <% end %>>
            <%= ts("Warning: Unchecking this box will delete any existing end note.") %></span>
          </dd>
          <dd id="end-notes-options" class="work-endnotes optionalField">
            <dl>
              <dt class="notes">
                <%= f.label :endnotes, ts("Chapter notes (max %{max} characters)", :max => ArchiveConfig.NOTES_MAX.to_s) %>
              </dt>
              <dd class="notes">
                <%= f.text_area :endnotes, :rows => 4, :cols => 60, :live => true, :class => "observe_textlength" %>
                <%= generate_countdown_html("chapter_endnotes", ArchiveConfig.NOTES_MAX) %>
              </dd>
            </dl>
          </dd>
        </dl>
      </dd>
    </dl>
</fieldset>

<fieldset>
  <legend><%= ts("Chapter Text") %></legend>
   <p class="label">
    <%= f.label :content, ts("Chapter text"), :class => "required" %></p>
  <div id="toggleText">
  <p id="plainTextNotes" style="display: block"><%= allowed_html_instructions %></p>
  <p id="richTextNotes" style="display: none"><%= ts("Type or paste formatted text. Select the icon to the far left (clipboard with a 'W') to paste documents from Microsoft Word.") %></p>
  </div>
  <% use_tinymce %>
  <p class="rtf-html-switch">
    <span id="richTextLink" style="display: inline"><a href="javascript:addEditor('content');javascript:toggle();"><%=h 'Rich text' %></a></span>
    <span id="plainTextLink" style="display: none"><a href="javascript:removeEditor('content');javascript:toggle();"><%=h 'HTML' %></a></span>
  </p>
  
  <div class="rtf-html-field">
    <%= f.text_area :content, :class => "mce-editor", :id => "content", :class => "observe_textlength" %>
        <%= live_validation_for_field('content', 
          :maximum_length => ArchiveConfig.CONTENT_MAX, :minimum_length => ArchiveConfig.CONTENT_MIN, 
          :tooLongMessage => ts("We salute your ambition! But sadly the content must be less than %{max} characters long. (Maybe you want to create a multi-chaptered work?)", :max => ArchiveConfig.CONTENT_MAX.to_s),
          :tooShortMessage => ts("Brevity is the soul of wit, but your content does have to be at least %{min} characters long.", :min => ArchiveConfig.CONTENT_MIN.to_s),
          :failureMessage => ts("Brevity is the soul of wit, but your content does have to be at least %{min} characters long.", :min => ArchiveConfig.CONTENT_MIN.to_s))
      %>
    <%= generate_countdown_html("content", ArchiveConfig.CONTENT_MAX) %>
  </div>
</fieldset>

<fieldset>
<legend><%= ts("Post Chapter") %></legend>
    <p class="submit">
      <%= submit_tag ts('Preview'), :name => 'preview_button' %>
      <%= submit_tag ts('Post without preview'), :name => 'post_without_preview_button' %>
      <%= submit_tag ts('Cancel'), :name => 'cancel_button' %>
    </p>
</fieldset>
<% end %>
</div>

<%= content_for :footer_js do %>
  <%= javascript_tag do %>
    $j(document).ready(function(){
      $j(".toggle_formfield").click(function() {
        var targetId = $j(this).attr("id").replace("-show", "");
        toggleFormField(targetId);
      });
    })
  <% end %>
<% end %>
