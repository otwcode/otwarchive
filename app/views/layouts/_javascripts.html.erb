<!-- check to see if this controller/action allow tinymce before we load the gigantor js; see application_helper -->
<% if allow_tinymce?(controller) %>
  <%= yield :tinymce %>
<% end %>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" type="text/javascript"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js" type="text/javascript"></script>
<!-- if user has googleapis blocked for some reason we need a fallback -->
<script type="text/javascript">
  if (typeof jQuery == 'undefined') {
    document.write(unescape("%3Cscript src='/javascripts/jquery.min.js' type='text/javascript'%3E%3C/script%3E"));
    document.write(unescape("%3Cscript src='/javascripts/jquery-ui.min.js' type='text/javascript'%3E%3C/script%3E"));
  }
</script>

<% if Rails.env.test? %>
  <!--
    The autocomplete dropdown for a field (generated by jquery.tokeninput) will only appear
    if the field has focus. The jQuery :focus pseudo-selector returns the focused element
    on the page, but only if the browser itself has focus, and we're running tests in a
    headless browser which is always out of focus.

    We get around this by forcing jQuery to use its own selector engine instead of
    the browser's.

    By Matthew O'Riordan (http://mattheworiordan.com).
    License: IDGAF.

    https://github.com/mattheworiordan/jquery-focus-selenium-webkit-fix
  -->
  <script type="text/javascript">
    jQuery.find.selectors.filters.focus = function(elem) {
      var doc = elem.ownerDocument;
      return elem === doc.activeElement && !!(elem.type || elem.href);
    }
  </script>
<% end %>

<script type="text/javascript">$j = jQuery.noConflict();</script>
<%= javascript_include_tag "jquery.scrollTo.min", "jquery.livequery.min", "rails", "application", "bootstrap/bootstrap-dropdown.min", "jquery-shuffle", "jquery.tokeninput.min", "jquery.trap.min", "ao3modal.min", skip_pipeline: true %>

<%= javascript_include_tag "filters.min", skip_pipeline: true %>

<% if allow_tinymce?(controller) %>
  <%= yield :tinymce_init %>
<% end %>

<% unless Rails.env.test? ||
    current_user && current_user.try(:accepted_tos_version) == @current_tos_version ||
    params[:controller] == "home" && params[:action] == "tos" ||
    params[:controller] == "home" && params[:action] == "tos_faq" ||
    params[:controller] == "home" && params[:action] == "dmca" ||
    params[:controller] == "abuse_reports" && params[:action] == "new" ||
    params[:controller] == "feedbacks" && params[:action] == "new" %>
  <%= javascript_tag do %>
    <% # localStorage polyfill we only need for guests. %>
    <% unless current_user %>
      // We can't rely on !window.localStorage to test localStorage support in
      // browsers like Safari 9, which technically support it, but which have a
      // storage length of 0 in private mode.
      // Credit: https://github.com/getgrav/grav-plugin-admin/commit/cfe2188f10c4ca604e03c96f3e21537fda1cdf9a
      function isSupported() {
          var item = "localStoragePolyfill";
          try {
              localStorage.setItem(item, item);
              localStorage.removeItem(item);
              sessionStorage.setItem(item, item);
              sessionStorage.removeItem(item);
              return true;
          } catch (e) {
              return false;
          }
      }

      // For browsers that don't support localStorage according to our check,
      // make its functions handle cookies instead.
      // Credit: https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Local_storage
      if (!isSupported()) {
        // 20 years is the Rails maximum and what we previous used.  
        var expiryDate = new Date;
        expiryDate.setFullYear(expiryDate.getFullYear() + 20);

        // window.localStorage is read only, ergo we must delete it for this to
        // work in instances like Safari 9 private mode.
        delete window.localStorage;
        window.localStorage = {
          getItem: function (sKey) {
            if (!sKey || !this.hasOwnProperty(sKey)) { return null; }
            return unescape(document.cookie.replace(new RegExp("(?:^|.*;\\s*)" + escape(sKey).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"), "$1"));
          },
          key: function (nKeyId) {
            return unescape(document.cookie.replace(/\s*\=(?:.(?!;))*$/, "").split(/\s*\=(?:[^;](?!;))*[^;]?;\s*/)[nKeyId]);
          },
          setItem: function (sKey, sValue) {
            if(!sKey) { return; }
            document.cookie = escape(sKey) + "=" + escape(sValue) + "; expires=" + expiryDate.toUTCString() + "; path=/";
            this.length = document.cookie.match(/\=/g).length;
          },
          length: 0,
          removeItem: function (sKey) {
            if (!sKey || !this.hasOwnProperty(sKey)) { return; }
            document.cookie = escape(sKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
            this.length--;
          },
          hasOwnProperty: function (sKey) {
            return (new RegExp("(?:^|;\\s*)" + escape(sKey).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=")).test(document.cookie);
          }
        };
        window.localStorage.length = (document.cookie.match(/\=/g) || window.localStorage).length;
      }
    <% end %>

    $j(document).ready(function() {
      <% if current_user %>
        <% # Users who haven't accepted this TOS need the popup. %>
        $j("body").prepend("<%= escape_javascript(render "layouts/tos_prompt") %>");
      <% elsif params[:tos] == "yes" %>
        <% # Guests can bypass the popup using ?tos=yes in the URLs. %>
        localStorage.setItem("accepted_tos", "<%= @current_tos_version %>");
      <% else %>
        <% # Otherwise, guests who don't have the localStorage item need the popup.
           # We have to use JavaScript to remember their choice or risk issues
           # when full page caching is enabled. %>
        if (localStorage.getItem("accepted_tos") !== "<%= @current_tos_version %>") {
          $j("body").prepend("<%= escape_javascript(render "layouts/tos_prompt") %>");
        }
      <% end %>
    });
  <% end %>
<% end %>

<%= yield :footer_js %>
